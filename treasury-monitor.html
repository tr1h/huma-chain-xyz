<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Treasury Monitor - Project Wallets</title>
    <!-- Admin Password -->
    <meta name="admin-password-hash" content="86303a8eab5693506714a32875b556fd84daf2209f184459642af6e153da3ff3">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Admin Login Screen */
        #adminLoginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-container h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 28px;
        }

        #adminPasswordInput {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        #adminPasswordInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: #5568d3;
        }

        #adminLoginError {
            color: red;
            margin-top: 15px;
            min-height: 20px;
            font-size: 14px;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(45, 55, 72, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }

        h1 {
            font-size: 32px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(16, 185, 129, 0.2);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #10b981;
        }

        .live-dot {
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Wallet Cards Grid */
        .wallets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .wallet-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .wallet-card:hover {
            transform: translateY(-5px);
        }

        .wallet-card.treasury {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .wallet-card.p2e {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .wallet-card.burn {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        }

        .wallet-card.sol-treasury {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .wallet-card.marketing {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        }

        .wallet-card.community {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
        }

        .wallet-card.reserve {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }

        .wallet-card.treasury-liquidity {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        }

        .wallet-card.treasury-team {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .wallet-icon {
            font-size: 32px;
        }

        .wallet-name {
            font-size: 14px;
            opacity: 0.9;
        }

        .wallet-balance {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .wallet-address {
            font-size: 11px;
            opacity: 0.7;
            word-break: break-all;
            margin-top: 10px;
        }

        .wallet-recent {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .filters {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            color: #fff;
            font-size: 14px;
        }

        .transactions-table {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(0,0,0,0.3);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
        }

        tr {
            transition: all 0.2s;
        }

        tr:hover {
            background: rgba(255,255,255,0.1);
        }

        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .type-treasury {
            background: #8b5cf6;
            color: #fff;
        }

        .type-p2e {
            background: #3b82f6;
            color: #fff;
        }

        .type-burn {
            background: #ff6b35;
            color: #fff;
        }

        .type-sol {
            background: #f59e0b;
            color: #fff;
        }

        .amount-positive {
            color: #10b981;
            font-weight: bold;
        }

        .amount-negative {
            color: #ef4444;
            font-weight: bold;
        }

        .amount-burn {
            color: #ff6b35;
            font-weight: bold;
        }

        .explorer-link {
            color: #60a5fa;
            text-decoration: none;
            font-size: 11px;
        }

        .explorer-link:hover {
            text-decoration: underline;
        }

        .export-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            transition: all 0.2s;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }

        .update-time {
            text-align: center;
            font-size: 12px;
            opacity: 0.7;
            margin-top: 10px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }

        .pagination button {
            padding: 10px 20px;
            background: #667eea;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button:not(:disabled):hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        #page-info {
            font-size: 18px;
            font-weight: bold;
        }

        /* Wallet Detail Modal */
        .wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .wallet-modal.show {
            display: flex;
        }

        .wallet-modal-content {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.1);
        }

        .wallet-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .wallet-modal-header h2 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .wallet-modal-close {
            background: #ef4444;
            border: none;
            color: #fff;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wallet-modal-close:hover {
            background: #dc2626;
            transform: rotate(90deg);
        }

        .wallet-card:hover {
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
    </style>
    <script src="js/admin-env.js"></script>
</head>
<body>
    <!-- Admin Login Screen -->
    <div id="adminLoginScreen">
        <div class="login-container">
            <h2>üîê Treasury Access</h2>
            <input type="password" id="adminPasswordInput" placeholder="Enter password">
            <button class="login-btn" onclick="adminAuth.checkPassword()">Login</button>
            <div id="adminLoginError"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="adminContent" style="display: none;">
        <div class="container">
            <div class="header">
                <a href="super-admin.html" class="back-btn">‚¨ÖÔ∏è Back</a>
                <h1>üí∞ Treasury Monitor - Project Wallets</h1>
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span>Live Updates</span>
                </div>
            </div>

            <!-- Wallet Cards -->
            <div class="wallets-grid" id="wallets-grid">
                <div class="wallet-card treasury" onclick="showWalletDetails('treasury')">
                    <div class="wallet-header">
                        <div>
                            <div class="wallet-name">üí∞ Treasury Main V2</div>
                            <div class="wallet-balance" id="treasury-balance">Loading...</div>
                        </div>
                        <div class="wallet-icon">üíé</div>
                    </div>
                    <a href="https://solscan.io/account/6rY5inYo8JmDTj91UwMKLr1MyxyAAQGjLpJhSi6dNpFM?cluster=devnet" 
                       target="_blank" class="wallet-address" style="color: #60a5fa; text-decoration: none;">
                        6rY5...6dNpFM üîó
                    </a>
                    <div class="wallet-recent">30% TAMA from NFT mints + 50% SOL from NFT sales</div>
                </div>

                <div class="wallet-card p2e" onclick="showWalletDetails('p2e')">
                    <div class="wallet-header">
                        <div>
                            <div class="wallet-name">üéÆ P2E Pool</div>
                            <div class="wallet-balance" id="p2e-balance">Loading...</div>
                        </div>
                        <div class="wallet-icon">üéÆ</div>
                    </div>
                    <a href="https://solscan.io/account/HPQf1MG8e41MoMayD8iqFmadqZ2NteScx4dQuwc1fCQw?cluster=devnet" 
                       target="_blank" class="wallet-address" style="color: #60a5fa; text-decoration: none;">
                        HPQf...c1fCQw üîó
                    </a>
                    <div class="wallet-recent">30% from NFT mints (TAMA) + Player rewards</div>
                </div>

                <div class="wallet-card burn" onclick="showWalletDetails('burn')">
                    <div class="wallet-header">
                        <div>
                            <div class="wallet-name">üî• Total Burned</div>
                            <div class="wallet-balance" id="burn-total">Loading...</div>
                        </div>
                        <div class="wallet-icon">üî•</div>
                    </div>
                    <div class="wallet-address">Permanent destruction</div>
                    <div class="wallet-recent">40% from NFT mints (TAMA) - burned forever</div>
                </div>

                <div class="wallet-card sol-treasury" onclick="showWalletDetails('liquidity')">
                    <div class="wallet-header">
                        <div>
                            <div class="wallet-name">üíß Liquidity Pool (30%)</div>
                            <div class="wallet-balance" id="liquidity-balance">Loading...</div>
                        </div>
                        <div class="wallet-icon">üíß</div>
                    </div>
                    <a href="https://solscan.io/account/5kHACukYuErqSzURPTtexS7CXdqv9eJ9eNvydDz3o36z?cluster=devnet" 
                       target="_blank" class="wallet-address" style="color: #60a5fa; text-decoration: none;" onclick="event.stopPropagation();">
                        5kHA...3o36z üîó
                    </a>
                    <div class="wallet-recent">30% SOL for DEX liquidity (Raydium/Jupiter)</div>
                </div>

                <div class="wallet-card sol-treasury" onclick="showWalletDetails('team')">
                    <div class="wallet-header">
                        <div>
                            <div class="wallet-name">üë• Team Wallet (20%)</div>
                            <div class="wallet-balance" id="team-balance">Loading...</div>
                        </div>
                        <div class="wallet-icon">üë•</div>
                    </div>
                    <a href="https://solscan.io/account/AQr5BM4FUKumKwdcNMWM1FPVx6qLWssp55HqH4SkWXVR?cluster=devnet" 
                       target="_blank" class="wallet-address" style="color: #60a5fa; text-decoration: none;" onclick="event.stopPropagation();">
                        AQr5...kWXVR üîó
                    </a>
                    <div class="wallet-recent">20% SOL for team compensation</div>
                </div>

                <div class="wallet-card marketing" onclick="showWalletDetails('marketing')">
                    <div class="wallet-header">
                        <div>
                            <div class="wallet-name">üì¢ Marketing</div>
                            <div class="wallet-balance" id="marketing-balance">Loading...</div>
                        </div>
                        <div class="wallet-icon">üì¢</div>
                    </div>
                    <a href="https://solscan.io/account/2eryce7DH7mqDCPegTb696FjXReA5qmx9xfCKH5UneeF?cluster=devnet" 
                       target="_blank" class="wallet-address" style="color: #60a5fa; text-decoration: none;" onclick="event.stopPropagation();">
                        2ery...neeF üîó
                    </a>
                    <div class="wallet-recent">Marketing & partnerships (15%)</div>
                </div>

                <div class="wallet-card community" onclick="showWalletDetails('community')">
                    <div class="wallet-header">
                        <div>
                            <div class="wallet-name">üåê Community</div>
                            <div class="wallet-balance" id="community-balance">Loading...</div>
                        </div>
                        <div class="wallet-icon">üåê</div>
                    </div>
                    <a href="https://solscan.io/account/9X1DYKzHiYP4V2UuVNGbU42DQkd8ST1nPwbJDuFQY3T?cluster=devnet" 
                       target="_blank" class="wallet-address" style="color: #60a5fa; text-decoration: none;" onclick="event.stopPropagation();">
                        9X1D...QY3T üîó
                    </a>
                    <div class="wallet-recent">Community rewards & airdrops (10%)</div>
                </div>

                <div class="wallet-card reserve" onclick="showWalletDetails('reserve')">
                    <div class="wallet-header">
                        <div>
                            <div class="wallet-name">üè¶ Reserve</div>
                            <div class="wallet-balance" id="reserve-balance">Loading...</div>
                        </div>
                        <div class="wallet-icon">üè¶</div>
                    </div>
                    <a href="https://solscan.io/account/8cDHbeHcuspjGKXofYzApCCBrAVenSHPy2UAPU1iCEj6?cluster=devnet" 
                       target="_blank" class="wallet-address" style="color: #60a5fa; text-decoration: none;" onclick="event.stopPropagation();">
                        8cDH...CEj6 üîó
                    </a>
                    <div class="wallet-recent">Reserve fund for emergencies (5%)</div>
                </div>

                <div class="wallet-card treasury-liquidity" onclick="showWalletDetails('treasury-liquidity')">
                    <div class="wallet-header">
                        <div>
                            <div class="wallet-name">üíß Treasury Liquidity V2</div>
                            <div class="wallet-balance" id="treasury-liquidity-balance">Loading...</div>
                        </div>
                        <div class="wallet-icon">üíπ</div>
                    </div>
                    <a href="https://solscan.io/account/CeeKjLEVfY15fmiVnPrGzjneN5i3UsrRW4r4XHdavGk1?cluster=devnet" 
                       target="_blank" class="wallet-address" style="color: #60a5fa; text-decoration: none;" onclick="event.stopPropagation();">
                        CeeK...avGk1 üîó
                    </a>
                    <div class="wallet-recent">DEX Liquidity Pool (SOL Silver/Gold: 30%)</div>
                </div>

                <div class="wallet-card treasury-team" onclick="showWalletDetails('treasury-team')">
                    <div class="wallet-header">
                        <div>
                            <div class="wallet-name">üë• Treasury Team V2</div>
                            <div class="wallet-balance" id="treasury-team-balance">Loading...</div>
                        </div>
                        <div class="wallet-icon">üíº</div>
                    </div>
                    <a href="https://solscan.io/account/Amy5EJqZWp713SaT3nieXSSZjxptVXJA1LhtpTE7Ua8?cluster=devnet" 
                       target="_blank" class="wallet-address" style="color: #60a5fa; text-decoration: none;" onclick="event.stopPropagation();">
                        Amy5...7Ua8 üîó
                    </a>
                    <div class="wallet-recent">Team Operations (SOL Silver/Gold: 20%)</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label>Wallet Type</label>
                    <select id="filter-wallet">
                        <option value="">All Wallets</option>
                        <option value="treasury">Treasury (TAMA)</option>
                        <option value="p2e">P2E Pool (TAMA)</option>
                        <option value="burn">Burn</option>
                        <option value="sol">SOL Wallets</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Transaction Type</label>
                    <select id="filter-type">
                        <option value="">All Types</option>
                        <option value="treasury_income">Treasury Income</option>
                        <option value="p2e_pool_refund">P2E Pool Refund</option>
                        <option value="burn">Burn</option>
                        <option value="sol_income">SOL Income</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date From</label>
                    <input type="date" id="filter-date-from">
                </div>
                <div class="filter-group">
                    <label>Date To</label>
                    <input type="date" id="filter-date-to">
                </div>
            </div>

            <button class="export-btn" onclick="exportToCSV()">üì• Export to CSV</button>

            <!-- Transactions Table -->
            <div class="transactions-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Wallet</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Source</th>
                            <th>Signature / Explorer</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <tr>
                            <td colspan="6" class="loading">‚è≥ Loading project transactions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <button onclick="changePage(-1)">‚Üê Previous</button>
                <div id="page-info">Page 1</div>
                <button onclick="changePage(1)">Next ‚Üí</button>
            </div>

            <div class="update-time" id="update-time">Last updated: Never</div>
        </div>

        <!-- Wallet Detail Modal -->
        <div class="wallet-modal" id="wallet-modal">
            <div class="wallet-modal-content">
                <div class="wallet-modal-header">
                    <h2 id="wallet-modal-title">üí∞ Wallet Transactions</h2>
                    <button class="wallet-modal-close" onclick="closeWalletModal()">‚úï</button>
                </div>
                <div id="wallet-modal-body">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = window.AdminEnv?.SUPABASE_URL || 'https://zfrazyupameidxpjihrh.supabase.co';
        const SUPABASE_ANON_KEY = window.AdminEnv?.SUPABASE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcmF6eXVwYW1laWR4cGppaHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5Mzc1NTAsImV4cCI6MjA3NTUxMzU1MH0.1EkMDqCNJoAjcJDh3Dd3yPfus-JpdcwE--z2dhjh7wU';
        const TAMA_API_BASE = window.AdminEnv?.TAMA_API_BASE || 'https://api.solanatamagotchi.com/api/tama';

        // Project Wallet Addresses
        const TREASURY_MAIN = '6rY5inYo8JmDTj91UwMKLr1MyxyAAQGjLpJhSi6dNpFM';
        const P2E_POOL = 'HPQf1MG8e41MoMayD8iqFmadqZ2NteScx4dQuwc1fCQw';
        const BURN_ADDRESS = 'BURN_ADDRESS';
        const LIQUIDITY_POOL = '5kHACukYuErqSzURPTtexS7CXdqv9eJ9eNvydDz3o36z';
        const TEAM_WALLET = 'AQr5BM4FUKumKwdcNMWM1FPVx6qLWssp55HqH4SkWXVR';
        const MARKETING_WALLET = '2eryce7DH7mqDCPegTb696FjXReA5qmx9xfCKH5UneeF';
        const COMMUNITY_WALLET = '9X1DYKzHiYP4V2UuVNGbU42DQkd8ST1nPwbJDuFQY3T';
        const RESERVE_WALLET = '8cDHbeHcuspjGKXofYzApCCBrAVenSHPy2UAPU1iCEj6';
        const TREASURY_LIQUIDITY = 'CeeKjLEVfY15fmiVnPrGzjneN5i3UsrRW4r4XHdavGk1';
        const TREASURY_TEAM = 'Amy5EJqZWp713SaT3nieXSSZjxptVXJA1LhtpTE7Ua8';
        const SOLANA_RPC = 'https://api.devnet.solana.com';
        
        let allTransactions = [];
        let currentPage = 1;
        const PAGE_SIZE = 50;
        let autoUpdateInterval;

        // TAMA Mint Address
        const TAMA_MINT = 'Fuqw8Zg17XhHGXfghLYD1fqjxJa1PnmG2MmoqG5pcmLY';
        const TAMA_DECIMALS = 9;

        // Get SOL balance from Solana RPC
        async function getSolBalance(address) {
            try {
                const response = await fetch(SOLANA_RPC, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'getBalance',
                        params: [address]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.result && data.result.value !== undefined) {
                        // Convert lamports to SOL (1 SOL = 1,000,000,000 lamports)
                        return data.result.value / 1e9;
                    }
                }
                return 0;
            } catch (error) {
                console.error(`Failed to get SOL balance for ${address}:`, error);
                return 0;
            }
        }

        // Get TAMA token balance from Solana RPC
        async function getTamaBalance(address) {
            try {
                const response = await fetch(SOLANA_RPC, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'getTokenAccountsByOwner',
                        params: [
                            address,
                            { mint: TAMA_MINT },
                            { encoding: 'jsonParsed' }
                        ]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.result && data.result.value && data.result.value.length > 0) {
                        const tokenAccount = data.result.value[0];
                        // Get token amount from parsed data
                        const amount = tokenAccount?.account?.data?.parsed?.info?.tokenAmount?.amount;
                        
                        if (amount && parseInt(amount) > 0) {
                            // Convert from raw units to TAMA (divide by 10^decimals)
                            return parseInt(amount) / Math.pow(10, TAMA_DECIMALS);
                        }
                    }
                }
                return 0;
            } catch (error) {
                console.error(`Failed to get TAMA balance for ${address}:`, error);
                return 0;
            }
        }

        async function loadWalletBalances() {
            try {
                // Load balances directly from BLOCKCHAIN (source of truth)
                // Treasury Main V2 - get SOL and TAMA from blockchain
                const treasuryMainSol = await getSolBalance(TREASURY_MAIN);
                const treasuryMainTama = await getTamaBalance(TREASURY_MAIN);
                
                let treasuryMainText = Math.round(treasuryMainTama).toLocaleString() + ' TAMA';
                if (treasuryMainSol > 0) {
                    treasuryMainText += ' + ' + treasuryMainSol.toFixed(4) + ' SOL';
                }
                document.getElementById('treasury-balance').textContent = treasuryMainText;

                // P2E Pool balance (from BLOCKCHAIN - source of truth)
                const p2eBlockchainTama = await getTamaBalance(P2E_POOL);
                document.getElementById('p2e-balance').textContent = 
                    Math.round(p2eBlockchainTama).toLocaleString() + ' TAMA';

                // Calculate total burned (from transactions)
                const burnResponse = await fetch(`${TAMA_API_BASE}/transactions/list?limit=1000`);
                if (burnResponse.ok) {
                    const burnData = await burnResponse.json();
                    const burnTransactions = (burnData.data || []).filter(t => t.type && t.type.includes('burn'));
                    const totalBurned = burnTransactions.reduce((sum, t) => sum + Math.abs(t.amount || 0), 0);
                    document.getElementById('burn-total').textContent = 
                        Math.round(totalBurned).toLocaleString() + ' TAMA';
                } else {
                    document.getElementById('burn-total').textContent = '0 TAMA';
                }

                // Load SOL and TAMA balances from Solana Devnet
                // Liquidity Pool (SOL + TAMA)
                const liquiditySolBalance = await getSolBalance(LIQUIDITY_POOL);
                const liquidityTamaBalance = await getTamaBalance(LIQUIDITY_POOL);
                let liquidityText = liquiditySolBalance.toFixed(4) + ' SOL';
                if (liquidityTamaBalance > 0) {
                    liquidityText += ' + ' + Math.round(liquidityTamaBalance).toLocaleString() + ' TAMA';
                }
                document.getElementById('liquidity-balance').textContent = liquidityText;
                
                // Team Wallet (SOL + TAMA)
                const teamSolBalance = await getSolBalance(TEAM_WALLET);
                const teamTamaBalance = await getTamaBalance(TEAM_WALLET);
                let teamText = teamSolBalance.toFixed(4) + ' SOL';
                if (teamTamaBalance > 0) {
                    teamText += ' + ' + Math.round(teamTamaBalance).toLocaleString() + ' TAMA';
                }
                document.getElementById('team-balance').textContent = teamText;

                // Marketing Wallet (SOL + TAMA)
                const marketingSolBalance = await getSolBalance(MARKETING_WALLET);
                const marketingTamaBalance = await getTamaBalance(MARKETING_WALLET);
                let marketingText = marketingSolBalance.toFixed(4) + ' SOL';
                if (marketingTamaBalance > 0) {
                    marketingText += ' + ' + Math.round(marketingTamaBalance).toLocaleString() + ' TAMA';
                }
                document.getElementById('marketing-balance').textContent = marketingText;

                // Community Wallet (SOL + TAMA)
                const communitySolBalance = await getSolBalance(COMMUNITY_WALLET);
                const communityTamaBalance = await getTamaBalance(COMMUNITY_WALLET);
                let communityText = communitySolBalance.toFixed(4) + ' SOL';
                if (communityTamaBalance > 0) {
                    communityText += ' + ' + Math.round(communityTamaBalance).toLocaleString() + ' TAMA';
                }
                document.getElementById('community-balance').textContent = communityText;

                // Reserve Wallet (SOL + TAMA)
                const reserveSolBalance = await getSolBalance(RESERVE_WALLET);
                const reserveTamaBalance = await getTamaBalance(RESERVE_WALLET);
                let reserveText = reserveSolBalance.toFixed(4) + ' SOL';
                if (reserveTamaBalance > 0) {
                    reserveText += ' + ' + Math.round(reserveTamaBalance).toLocaleString() + ' TAMA';
                }
                document.getElementById('reserve-balance').textContent = reserveText;

                // Treasury Liquidity V2 (SOL + TAMA)
                const treasuryLiquiditySolBalance = await getSolBalance(TREASURY_LIQUIDITY);
                const treasuryLiquidityTamaBalance = await getTamaBalance(TREASURY_LIQUIDITY);
                let treasuryLiquidityText = treasuryLiquiditySolBalance.toFixed(4) + ' SOL';
                if (treasuryLiquidityTamaBalance > 0) {
                    treasuryLiquidityText += ' + ' + Math.round(treasuryLiquidityTamaBalance).toLocaleString() + ' TAMA';
                }
                document.getElementById('treasury-liquidity-balance').textContent = treasuryLiquidityText;

                // Treasury Team V2 (SOL + TAMA)
                const treasuryTeamSolBalance = await getSolBalance(TREASURY_TEAM);
                const treasuryTeamTamaBalance = await getTamaBalance(TREASURY_TEAM);
                let treasuryTeamText = treasuryTeamSolBalance.toFixed(4) + ' SOL';
                if (treasuryTeamTamaBalance > 0) {
                    treasuryTeamText += ' + ' + Math.round(treasuryTeamTamaBalance).toLocaleString() + ' TAMA';
                }
                document.getElementById('treasury-team-balance').textContent = treasuryTeamText;

                console.log('‚úÖ Wallet balances loaded');
            } catch (error) {
                console.error('‚ùå Error loading wallet balances:', error);
                // Set error state
                document.getElementById('treasury-balance').textContent = 'Error';
                document.getElementById('p2e-balance').textContent = 'Error';
                document.getElementById('burn-total').textContent = 'Error';
                document.getElementById('liquidity-balance').textContent = 'Error';
                document.getElementById('team-balance').textContent = 'Error';
            }
        }

        async function loadProjectTransactions() {
            const tbody = document.getElementById('transactions-body');
            
            try {
                // Try API first
                console.log(`üì° Fetching transactions from: ${TAMA_API_BASE}/transactions/list`);
                const response = await fetch(`${TAMA_API_BASE}/transactions/list?limit=1000&order=created_at.desc`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.warn(`‚ö†Ô∏è API returned ${response.status}, trying Supabase directly...`);
                    throw new Error(`API error: ${response.status}`);
                }

                const payload = await response.json();
                console.log('üì¶ API Response:', payload);
                
                if (payload && payload.data && Array.isArray(payload.data)) {
                    // Debug: Log first few transactions to see structure
                    if (payload.data.length > 0) {
                        console.log('üîç Sample transactions (first 5):', payload.data.slice(0, 5).map(t => ({
                            id: t.id,
                            user_id: t.user_id,
                            type: t.type,
                            amount: t.amount
                        })));
                        console.log('üîç Expected addresses:', {
                            TREASURY_MAIN,
                            P2E_POOL,
                            BURN_ADDRESS
                        });
                    }
                    
                    // Filter only project transactions
                    // –í–ê–ñ–ù–û: NFT mint —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—É–ª–∞–º –≤ metadata
                    allTransactions = payload.data.filter(t => {
                        // Convert user_id to string for comparison
                        const userId = String(t.user_id || '');
                        
                        // 1. Include by user_id (exact match) - direct pool transactions
                        if (userId === TREASURY_MAIN || 
                            userId === P2E_POOL || 
                            userId === BURN_ADDRESS ||
                            userId === 'SYSTEM_BURN') {
                            return true;
                        }
                        
                        // 2. Include by type (case insensitive) - –≤—Å–µ —Ç–∏–ø—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—É–ª–∞–º–∏
                        const typeStr = String(t.type || '').toLowerCase();
                        if (typeStr) {
                            // NFT mint —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
                            if (typeStr.includes('nft_mint')) {
                                return true;
                            }
                            
                            // –î—Ä—É–≥–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–∏–ø—ã
                            if (typeStr.includes('treasury') || 
                                typeStr.includes('p2e') ||
                                typeStr.includes('burn') ||
                                typeStr.includes('tama_burn') ||
                                typeStr.includes('sol_income') ||
                                typeStr.includes('liquidity') ||
                                typeStr.includes('team') ||
                                typeStr.includes('withdrawal')) {
                                return true;
                            }
                        }
                        
                        // 3. Check metadata for distribution info
                        if (t.metadata) {
                            try {
                                const metadata = typeof t.metadata === 'string' ? JSON.parse(t.metadata) : t.metadata;
                                const metadataStr = JSON.stringify(metadata).toLowerCase();
                                
                                // –ï—Å–ª–∏ –≤ metadata –µ—Å—Ç—å distribution (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤)
                                if (metadata.distribution || 
                                    metadataStr.includes('treasury') || 
                                    metadataStr.includes('p2e') ||
                                    metadataStr.includes('burn') ||
                                    metadataStr.includes('pool')) {
                                    return true;
                                }
                            } catch (e) {
                                // Ignore JSON parse errors
                            }
                        }
                        
                        return false;
                    });
                    
                    console.log(`‚úÖ Loaded ${allTransactions.length} project transactions from API (filtered from ${payload.data.length} total)`);
                    renderTransactions(allTransactions);
                    updateLastUpdateTime();
                } else {
                    console.warn('‚ö†Ô∏è API returned invalid format, trying Supabase...');
                    throw new Error('Invalid API response format');
                }
            } catch (error) {
                console.error('‚ùå API Error:', error);
                
                // Fallback: Try Supabase directly
                try {
                    console.log('üîÑ Trying Supabase directly...');
                    const supabaseResponse = await fetch(`${SUPABASE_URL}/rest/v1/transactions?select=id,user_id,username,type,amount,balance_before,balance_after,metadata,created_at&order=created_at.desc&limit=1000`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });
                    
                    if (supabaseResponse.ok) {
                        const supabaseData = await supabaseResponse.json();
                        console.log(`üì¶ Supabase returned ${supabaseData.length} transactions`);
                        
                        // Filter project transactions (same logic as API)
                        allTransactions = (Array.isArray(supabaseData) ? supabaseData : []).filter(t => {
                            const userId = String(t.user_id || '');
                            
                            // 1. Include by user_id
                            if (userId === TREASURY_MAIN || 
                                userId === P2E_POOL || 
                                userId === BURN_ADDRESS ||
                                userId === 'SYSTEM_BURN') {
                                return true;
                            }
                            
                            // 2. Include by type
                            const typeStr = String(t.type || '').toLowerCase();
                            if (typeStr) {
                                if (typeStr.includes('nft_mint')) {
                                    return true;
                                }
                                
                                if (typeStr.includes('treasury') || 
                                    typeStr.includes('p2e') ||
                                    typeStr.includes('burn') ||
                                    typeStr.includes('tama_burn') ||
                                    typeStr.includes('sol_income') ||
                                    typeStr.includes('liquidity') ||
                                    typeStr.includes('team') ||
                                    typeStr.includes('withdrawal')) {
                                    return true;
                                }
                            }
                            
                            // 3. Check metadata
                            if (t.metadata) {
                                try {
                                    const metadata = typeof t.metadata === 'string' ? JSON.parse(t.metadata) : t.metadata;
                                    const metadataStr = JSON.stringify(metadata).toLowerCase();
                                    
                                    if (metadata.distribution || 
                                        metadataStr.includes('treasury') || 
                                        metadataStr.includes('p2e') ||
                                        metadataStr.includes('burn') ||
                                        metadataStr.includes('pool')) {
                                        return true;
                                    }
                                } catch (e) {
                                    // Ignore
                                }
                            }
                            
                            return false;
                        });
                        
                        console.log(`‚úÖ Loaded ${allTransactions.length} project transactions from Supabase`);
                        renderTransactions(allTransactions);
                        updateLastUpdateTime();
                    } else {
                        throw new Error(`Supabase error: ${supabaseResponse.status}`);
                    }
                } catch (supabaseError) {
                    console.error('‚ùå Supabase Error:', supabaseError);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="loading">
                                ‚ùå Error loading transactions: ${error.message}<br>
                                <small>API: ${TAMA_API_BASE}/transactions/list</small><br>
                                <small>Supabase fallback also failed</small>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactions-body');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No project transactions found</td></tr>';
                return;
            }

            tbody.innerHTML = transactions.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE).map(t => {
                const date = new Date(t.created_at).toLocaleString();
                const amount = t.amount || 0;
                
                // Determine wallet name
                let walletName = t.username || t.user_id;
                if (t.user_id === TREASURY_MAIN) walletName = 'üí∞ Treasury Main V2';
                if (t.user_id === P2E_POOL) walletName = 'üéÆ P2E Pool';
                if (t.user_id === BURN_ADDRESS || t.user_id === 'SYSTEM_BURN') walletName = 'üî• Burn';
                
                // Type badge
                const typeClass = t.type && t.type.includes('treasury') ? 'type-treasury' :
                                 t.type && t.type.includes('p2e') ? 'type-p2e' :
                                 t.type && t.type.includes('burn') ? 'type-burn' :
                                 t.type && t.type.includes('sol') ? 'type-sol' : 'type-treasury';
                
                // Amount display
                const isBurn = t.type && t.type.includes('burn');
                let amountClass, amountPrefix, displayAmount;
                if (isBurn) {
                    amountClass = 'amount-burn';
                    amountPrefix = 'üî• ';
                    displayAmount = Math.abs(amount);
                } else if (amount > 0) {
                    amountClass = 'amount-positive';
                    amountPrefix = '+';
                    displayAmount = amount;
                } else {
                    amountClass = 'amount-negative';
                    amountPrefix = '-';
                    displayAmount = Math.abs(amount);
                }
                
                const currency = t.type && t.type.includes('_sol') ? ' SOL' : ' TAMA';
                
                // Source (from metadata)
                let source = 'System';
                if (t.metadata && typeof t.metadata === 'object') {
                    source = t.metadata.reason || t.metadata.source || 'NFT Mint';
                } else if (typeof t.metadata === 'string') {
                    // Try to parse JSON string
                    try {
                        const parsed = JSON.parse(t.metadata);
                        source = parsed.reason || parsed.source || 'NFT Mint';
                    } catch (e) {
                        // Invalid JSON, keep 'System'
                    }
                }
                
                // Explorer link (from metadata) - using Solscan
                let explorerLink = '-';
                let signature = null;
                
                if (t.metadata && typeof t.metadata === 'object') {
                    signature = t.metadata.onchain_signature || t.metadata.transaction_signature;
                } else if (typeof t.metadata === 'string') {
                    // Try to parse JSON string
                    try {
                        const parsed = JSON.parse(t.metadata);
                        signature = parsed.onchain_signature || parsed.transaction_signature;
                    } catch (e) {
                        // Invalid JSON, keep null
                    }
                }
                
                if (signature) {
                    explorerLink = `<a href="https://solscan.io/tx/${signature}?cluster=devnet" 
                                      target="_blank" class="explorer-link">View on Solscan üîó</a>`;
                }
                
                return `
                    <tr>
                        <td>${date}</td>
                        <td><strong>${walletName}</strong></td>
                        <td><span class="type-badge ${typeClass}">${t.type}</span></td>
                        <td class="${amountClass}">${amountPrefix}${Math.round(displayAmount * 100) / 100}${currency}</td>
                        <td>${source}</td>
                        <td>${explorerLink}</td>
                    </tr>
                `;
            }).join('');
            
            updatePaginationInfo();
        }

        function updatePaginationInfo() {
            const totalPages = Math.ceil(allTransactions.length / PAGE_SIZE);
            const start = (currentPage - 1) * PAGE_SIZE + 1;
            const end = Math.min(currentPage * PAGE_SIZE, allTransactions.length);
            
            document.getElementById('page-info').innerHTML = `
                Page ${currentPage} of ${totalPages}<br>
                <span style="font-size: 14px; opacity: 0.8;">
                    Showing ${start.toLocaleString()} - ${end.toLocaleString()} of ${allTransactions.length.toLocaleString()}
                </span>
            `;
            
            // Update button states
            const prevBtn = document.querySelector('.pagination button:first-child');
            const nextBtn = document.querySelector('.pagination button:last-child');
            
            if (prevBtn) {
                prevBtn.disabled = currentPage <= 1;
            }
            if (nextBtn) {
                nextBtn.disabled = currentPage >= totalPages;
            }
        }

        function changePage(direction) {
            const totalPages = Math.ceil(allTransactions.length / PAGE_SIZE);
            currentPage += direction;
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            renderTransactions(allTransactions);
        }

        function filterTransactions() {
            const walletFilter = document.getElementById('filter-wallet').value;
            const typeFilter = document.getElementById('filter-type').value;
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;

            // Implementation of filters (similar to transactions-admin.html)
            // For now, just reload
            loadProjectTransactions();
        }

        function exportToCSV() {
            const csv = [
                ['Date', 'Wallet', 'Type', 'Amount', 'Source', 'Signature'],
                ...allTransactions.map(t => [
                    new Date(t.created_at).toISOString(),
                    t.username || t.user_id,
                    t.type,
                    t.amount,
                    (t.metadata && t.metadata.reason) || '',
                    (t.metadata && t.metadata.onchain_signature) || ''
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `treasury_transactions_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function updateLastUpdateTime() {
            document.getElementById('update-time').textContent = `Last updated: ${new Date().toLocaleString()}`;
        }

        function startAutoUpdate() {
            autoUpdateInterval = setInterval(() => {
                console.log('üîÑ Auto-updating...');
                loadWalletBalances();
                loadProjectTransactions();
            }, 30000); // Every 30 seconds
        }

        // Add filter listeners
        document.getElementById('filter-wallet').addEventListener('change', filterTransactions);
        document.getElementById('filter-type').addEventListener('change', filterTransactions);
        document.getElementById('filter-date-from').addEventListener('change', filterTransactions);
        document.getElementById('filter-date-to').addEventListener('change', filterTransactions);

        // Wallet Detail Modal Functions
        function showWalletDetails(walletType) {
            const modal = document.getElementById('wallet-modal');
            const title = document.getElementById('wallet-modal-title');
            const body = document.getElementById('wallet-modal-body');
            
            // Set title based on wallet type
            const titles = {
                'treasury': 'üí∞ Treasury Main V2 - All Transactions',
                'p2e': 'üéÆ P2E Pool - All Transactions',
                'burn': 'üî• Burn - All Transactions',
                'liquidity': 'üíß Liquidity Pool - All Transactions',
                'team': 'üë• Team Wallet - All Transactions',
                'marketing': 'üì¢ Marketing - All Transactions',
                'community': 'üåê Community - All Transactions',
                'reserve': 'üè¶ Reserve - All Transactions',
                'treasury-liquidity': 'üíß Treasury Liquidity V2 - All Transactions',
                'treasury-team': 'üë• Treasury Team V2 - All Transactions'
            };
            
            title.textContent = titles[walletType] || 'üí∞ Wallet Transactions';
            
            // Filter transactions by wallet type (improved with metadata check)
            let walletTransactions = [];
            
            // Helper function to check metadata for wallet-related info
            function checkMetadataForWallet(metadata, walletType) {
                if (!metadata) return false;
                try {
                    const meta = typeof metadata === 'string' ? JSON.parse(metadata) : metadata;
                    const metaStr = JSON.stringify(meta).toLowerCase();
                    
                    if (walletType === 'treasury') {
                        return meta.distribution?.treasury || metaStr.includes('treasury');
                    } else if (walletType === 'p2e') {
                        return meta.distribution?.pool || metaStr.includes('p2e') || metaStr.includes('pool');
                    } else if (walletType === 'burn') {
                        return meta.distribution?.burn || metaStr.includes('burn');
                    }
                } catch (e) {
                    return false;
                }
                return false;
            }
            
            if (walletType === 'treasury') {
                walletTransactions = allTransactions.filter(t => {
                    const userId = String(t.user_id || '');
                    return userId === TREASURY_MAIN || 
                           (t.type && t.type.includes('treasury_income')) ||
                           checkMetadataForWallet(t.metadata, 'treasury');
                });
            } else if (walletType === 'p2e') {
                walletTransactions = allTransactions.filter(t => {
                    const userId = String(t.user_id || '');
                    return userId === P2E_POOL || 
                           (t.type && t.type.includes('p2e_pool')) ||
                           (t.type && t.type.includes('p2e')) ||
                           checkMetadataForWallet(t.metadata, 'p2e');
                });
            } else if (walletType === 'burn') {
                walletTransactions = allTransactions.filter(t => {
                    const userId = String(t.user_id || '');
                    return userId === BURN_ADDRESS || 
                           userId === 'SYSTEM_BURN' ||
                           (t.type && t.type.includes('burn')) ||
                           (t.type && t.type.includes('tama_burn')) ||
                           checkMetadataForWallet(t.metadata, 'burn');
                });
            } else if (walletType === 'liquidity') {
                walletTransactions = allTransactions.filter(t => {
                    const userId = String(t.user_id || '');
                    return userId === LIQUIDITY_POOL || 
                           (t.type && t.type.includes('liquidity'));
                });
            } else if (walletType === 'team') {
                walletTransactions = allTransactions.filter(t => {
                    const userId = String(t.user_id || '');
                    return userId === TEAM_WALLET || 
                           (t.type && t.type.includes('team') && !t.type.includes('treasury_team'));
                });
            } else if (walletType === 'marketing') {
                walletTransactions = allTransactions.filter(t => {
                    const userId = String(t.user_id || '');
                    return userId === MARKETING_WALLET || 
                           (t.type && t.type.includes('marketing'));
                });
            } else if (walletType === 'community') {
                walletTransactions = allTransactions.filter(t => {
                    const userId = String(t.user_id || '');
                    return userId === COMMUNITY_WALLET || 
                           (t.type && t.type.includes('community'));
                });
            } else if (walletType === 'reserve') {
                walletTransactions = allTransactions.filter(t => {
                    const userId = String(t.user_id || '');
                    return userId === RESERVE_WALLET || 
                           (t.type && t.type.includes('reserve'));
                });
            } else if (walletType === 'treasury-liquidity') {
                walletTransactions = allTransactions.filter(t => {
                    const userId = String(t.user_id || '');
                    return userId === TREASURY_LIQUIDITY || 
                           (t.type && t.type.includes('liquidity'));
                });
            } else if (walletType === 'treasury-team') {
                walletTransactions = allTransactions.filter(t => {
                    const userId = String(t.user_id || '');
                    return userId === TREASURY_TEAM || 
                           (t.type && t.type.includes('team'));
                });
            }
            
            // Calculate statistics
            const stats = calculateWalletStats(walletTransactions);
            
            // Render transactions in modal with stats and charts
            if (walletTransactions.length === 0) {
                body.innerHTML = '<div class="loading">No transactions found for this wallet</div>';
            } else {
                body.innerHTML = `
                    <!-- Statistics Section -->
                    <div style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="padding: 15px; background: rgba(102, 126, 234, 0.2); border-radius: 10px; border: 1px solid rgba(102, 126, 234, 0.3);">
                            <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">Total Transactions</div>
                            <div style="font-size: 24px; font-weight: bold;">${stats.totalTransactions}</div>
                        </div>
                        <div style="padding: 15px; background: rgba(34, 197, 94, 0.2); border-radius: 10px; border: 1px solid rgba(34, 197, 94, 0.3);">
                            <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">Total Inflow</div>
                            <div style="font-size: 24px; font-weight: bold; color: #22c55e;">+${stats.totalInflow.toLocaleString()} ${stats.currency}</div>
                        </div>
                        <div style="padding: 15px; background: rgba(239, 68, 68, 0.2); border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.3);">
                            <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">Total Outflow</div>
                            <div style="font-size: 24px; font-weight: bold; color: #ef4444;">-${stats.totalOutflow.toLocaleString()} ${stats.currency}</div>
                        </div>
                        <div style="padding: 15px; background: rgba(251, 191, 36, 0.2); border-radius: 10px; border: 1px solid rgba(251, 191, 36, 0.3);">
                            <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">Net Balance</div>
                            <div style="font-size: 24px; font-weight: bold; color: #fbbf24;">${stats.netBalance >= 0 ? '+' : ''}${stats.netBalance.toLocaleString()} ${stats.currency}</div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                            <h3 style="margin-bottom: 10px; font-size: 16px;">üìä Transactions by Type</h3>
                            <canvas id="typeChart" style="max-height: 250px;"></canvas>
                        </div>
                        <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                            <h3 style="margin-bottom: 10px; font-size: 16px;">üìà Daily Activity (Last 30 Days)</h3>
                            <canvas id="dailyChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                    
                    <!-- Transactions Table -->
                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                            üìã Transaction History (${walletTransactions.length})
                        </div>
                    </div>
                    <div class="transactions-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Source</th>
                                    <th>Explorer</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${walletTransactions.map(t => {
                                    const date = new Date(t.created_at).toLocaleString();
                                    const amount = t.amount || 0;
                                    const typeClass = t.type && t.type.includes('treasury') ? 'type-treasury' :
                                                     t.type && t.type.includes('p2e') ? 'type-p2e' :
                                                     t.type && t.type.includes('burn') ? 'type-burn' : 'type-treasury';
                                    const isBurn = t.type && t.type.includes('burn');
                                    let amountClass, amountPrefix, displayAmount;
                                    if (isBurn) {
                                        amountClass = 'amount-burn';
                                        amountPrefix = 'üî• ';
                                        displayAmount = Math.abs(amount);
                                    } else if (amount > 0) {
                                        amountClass = 'amount-positive';
                                        amountPrefix = '+';
                                        displayAmount = amount;
                                    } else {
                                        amountClass = 'amount-negative';
                                        amountPrefix = '-';
                                        displayAmount = Math.abs(amount);
                                    }
                                    const currency = t.type && t.type.includes('_sol') ? ' SOL' : ' TAMA';
                                    let source = 'System';
                                    if (t.metadata && typeof t.metadata === 'object') {
                                        source = t.metadata.reason || t.metadata.source || 'NFT Mint';
                                    } else if (typeof t.metadata === 'string') {
                                        try {
                                            const parsed = JSON.parse(t.metadata);
                                            source = parsed.reason || parsed.source || 'NFT Mint';
                                        } catch (e) {
                                            // Invalid JSON, keep 'System'
                                        }
                                    }
                                    let explorerLink = '-';
                                    if (t.metadata && typeof t.metadata === 'object') {
                                        const signature = t.metadata.onchain_signature || t.metadata.transaction_signature;
                                        if (signature) {
                                            explorerLink = '<a href="https://solscan.io/tx/' + signature + '?cluster=devnet" target="_blank" class="explorer-link">View üîó</a>';
                                        }
                                    } else if (typeof t.metadata === 'string') {
                                        // Try to parse JSON string
                                        try {
                                            const parsed = JSON.parse(t.metadata);
                                            const signature = parsed.onchain_signature || parsed.transaction_signature;
                                            if (signature) {
                                                explorerLink = '<a href="https://solscan.io/tx/' + signature + '?cluster=devnet" target="_blank" class="explorer-link">View üîó</a>';
                                            }
                                        } catch (e) {
                                            // Invalid JSON, keep '-'
                                        }
                                    }
                                    return '<tr><td>' + date + '</td><td><span class="type-badge ' + typeClass + '">' + t.type + '</span></td><td class="' + amountClass + '">' + amountPrefix + Math.round(displayAmount * 100) / 100 + currency + '</td><td>' + source + '</td><td>' + explorerLink + '</td></tr>';
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Render charts after HTML is inserted
                setTimeout(() => {
                    renderTypeChart(stats.typeDistribution);
                    renderDailyChart(stats.dailyData);
                }, 100);
            }
            
            modal.classList.add('show');
        }
        
        // Calculate wallet statistics
        function calculateWalletStats(transactions) {
            const stats = {
                totalTransactions: transactions.length,
                totalInflow: 0,
                totalOutflow: 0,
                netBalance: 0,
                currency: 'TAMA',
                typeDistribution: {},
                dailyData: {}
            };
            
            // Get last 30 days
            const today = new Date();
            const last30Days = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last30Days.push(dateStr);
                stats.dailyData[dateStr] = { count: 0, amount: 0 };
            }
            
            transactions.forEach(t => {
                const amount = parseFloat(t.amount || 0);
                
                // Determine currency
                if (t.type && t.type.includes('_sol')) {
                    stats.currency = 'SOL';
                }
                
                // Calculate inflow/outflow
                if (amount > 0) {
                    stats.totalInflow += amount;
                } else {
                    stats.totalOutflow += Math.abs(amount);
                }
                
                // Type distribution
                const type = t.type || 'unknown';
                if (!stats.typeDistribution[type]) {
                    stats.typeDistribution[type] = { count: 0, amount: 0 };
                }
                stats.typeDistribution[type].count++;
                stats.typeDistribution[type].amount += Math.abs(amount);
                
                // Daily data
                if (t.created_at) {
                    const date = new Date(t.created_at).toISOString().split('T')[0];
                    if (stats.dailyData[date]) {
                        stats.dailyData[date].count++;
                        stats.dailyData[date].amount += Math.abs(amount);
                    }
                }
            });
            
            stats.netBalance = stats.totalInflow - stats.totalOutflow;
            
            return stats;
        }
        
        // Render type distribution chart
        function renderTypeChart(typeDistribution) {
            const ctx = document.getElementById('typeChart');
            if (!ctx) return;
            
            const labels = Object.keys(typeDistribution).slice(0, 10); // Top 10 types
            const data = labels.map(type => typeDistribution[type].count);
            
            // Destroy old chart if exists
            if (window.typeChartInstance) {
                window.typeChartInstance.destroy();
            }
            
            window.typeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(14, 165, 233, 0.8)',
                            'rgba(20, 184, 166, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(249, 115, 22, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }
        
        // Render daily activity chart
        function renderDailyChart(dailyData) {
            const ctx = document.getElementById('dailyChart');
            if (!ctx) return;
            
            const labels = Object.keys(dailyData);
            const counts = labels.map(date => dailyData[date].count);
            const amounts = labels.map(date => dailyData[date].amount);
            
            // Destroy old chart if exists
            if (window.dailyChartInstance) {
                window.dailyChartInstance.destroy();
            }
            
            window.dailyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(d => {
                        const date = new Date(d);
                        return (date.getMonth() + 1) + '/' + date.getDate();
                    }),
                    datasets: [{
                        label: 'Transactions',
                        data: counts,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Amount',
                        data: amounts,
                        borderColor: 'rgba(34, 197, 94, 1)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#fff' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function closeWalletModal() {
            const modal = document.getElementById('wallet-modal');
            modal.classList.remove('show');
            
            // Destroy charts to prevent memory leaks
            const typeChartCanvas = document.getElementById('typeChart');
            const dailyChartCanvas = document.getElementById('dailyChart');
            if (typeChartCanvas && window.typeChartInstance) {
                window.typeChartInstance.destroy();
                window.typeChartInstance = null;
            }
            if (dailyChartCanvas && window.dailyChartInstance) {
                window.dailyChartInstance.destroy();
                window.dailyChartInstance = null;
            }
        }

        // Close modal on background click
        document.getElementById('wallet-modal').addEventListener('click', (e) => {
            if (e.target.id === 'wallet-modal') {
                closeWalletModal();
            }
        });

        // Load on page load
        loadWalletBalances();
        loadProjectTransactions();
        startAutoUpdate();
    </script>

    <!-- Admin Authentication -->
    <script src="admin-password.js"></script>
    <script src="js/admin-auth.js"></script>
</body>
</html>

