# üéÆ –û–¢–ß–Å–¢: –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –ò–ì–†–´ –ò –ú–ò–ù–ò-–ò–ì–†

**–î–∞—Ç–∞:** 20 –¥–µ–∫–∞–±—Ä—è 2025  
**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** tamagotchi-game.html + mini-games

---

## ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢:

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:
```
tamagotchi-game.html   - –û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–∞
‚îú‚îÄ‚îÄ slots.html         - Lucky Slots (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ)
‚îú‚îÄ‚îÄ wheel.html         - Lucky Wheel (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ)
‚îú‚îÄ‚îÄ super-tama-bros.html - Platformer (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ)
‚îú‚îÄ‚îÄ tama-shooter.html  - Shooter (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ)
‚îî‚îÄ‚îÄ tama-color-match.html - Memory game (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ)
```

### 2. –ù–∞–≤–∏–≥–∞—Ü–∏—è:
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "Games" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É —Å –º–∏–Ω–∏-–∏–≥—Ä–∞–º–∏
- ‚úÖ –ö–ª–∏–∫ –Ω–∞ –º–∏–Ω–∏-–∏–≥—Ä—É –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –µ—ë –≤ **–Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ** (`window.open`)
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `backToGames()` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Å—Ç—Ä–æ–∫–∏ 9509, 14776)

### 3. –ë–∞–ª–∞–Ω—Å TAMA:
- ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–∞ —Ö—Ä–∞–Ω–∏—Ç –±–∞–ª–∞–Ω—Å –≤ `gameState.tama`
- ‚úÖ –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `loadFromSupabase()` (—Å—Ç—Ä–æ–∫–∞ 8819)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Supabase —Ç–∞–±–ª–∏—Ü–∞ `players`

---

## ‚ùå –ü–†–û–ë–õ–ï–ú–´:

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É –∏–≥—Ä–∞–º–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ï—Å–ª–∏ –∏–≥—Ä–∞–µ—à—å –≤ slots.html –∏ –≤—ã–∏–≥—Ä—ã–≤–∞–µ—à—å TAMA
- –ó–∞—Ç–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å—Å—è –≤ tamagotchi-game.html
- –ë–∞–ª–∞–Ω—Å –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–ü—Ä–∏—á–∏–Ω–∞:**
- `slots.html` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ (`window.open`)
- –ù–µ—Ç —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ `window.opener` –∏–ª–∏ `postMessage`
- tamagotchi-game.html –ù–ï –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —Ñ–æ–∫—É—Å–∞

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å `focus` listener —á—Ç–æ–±—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å:

```javascript
// –í tamagotchi-game.html, –ø–æ—Å–ª–µ loadFromSupabase
window.addEventListener('focus', async () => {
    console.log('üîÑ Tab focused - reloading balance...');
    const userId = window.TELEGRAM_USER_ID || window.WALLET_USER_ID;
    if (userId) {
        const saved = await loadFromSupabase(String(userId));
        if (saved) {
            console.log('‚úÖ Balance reloaded after tab switch');
            updateUI();
        }
    }
});
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: slots.html –Ω–µ –∏–º–µ–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä–∏–ª —Ñ–∞–π–ª:** `slots.html` (–ø–µ—Ä–≤—ã–µ 100 —Å—Ç—Ä–æ–∫)
- ‚ùå –ù–µ—Ç `saveToSupabase()` —Ñ—É–Ω–∫—Ü–∏–∏
- ‚ùå –ù–µ—Ç `supabase.update()` –≤—ã–∑–æ–≤–æ–≤

**–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
–ö–∞–∫ slots.html —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–∏–≥—Ä—ã—à?

---

## üîß –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É –±–∞–ª–∞–Ω—Å–∞

**–§–∞–π–ª:** `tamagotchi-game.html`  
**–ú–µ—Å—Ç–æ:** –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 8819 (—Ñ—É–Ω–∫—Ü–∏—è loadFromSupabase)

**–î–æ–±–∞–≤–∏—Ç—å:**
```javascript
// üîÑ Auto-reload balance when user returns to tab
window.addEventListener('focus', async () => {
    const userId = window.TELEGRAM_USER_ID || window.WALLET_USER_ID || window.WALLET_ADDRESS;
    if (userId && !document.hidden) {
        console.log('üîÑ Tab focused - reloading balance from Supabase...');
        try {
            const response = await window.getSupabase()
                .from('players')
                .select('tama_balance, wallet_address')
                .eq('telegram_id', String(userId))
                .single();

            if (response.data) {
                const newBalance = parseFloat(response.data.tama_balance) || 0;
                const oldBalance = gameState.tama;
                
                if (newBalance !== oldBalance) {
                    gameState.tama = newBalance;
                    updateUI();
                    showMessage(`üîÑ Balance synced: ${formatNumber(newBalance)} TAMA`);
                    console.log(`‚úÖ Balance updated: ${oldBalance} ‚Üí ${newBalance}`);
                }
            }
        } catch (error) {
            console.error('‚ùå Failed to reload balance:', error);
        }
    }
});

// Also handle visibility change (more reliable on mobile)
document.addEventListener('visibilitychange', async () => {
    if (!document.hidden) {
        // Same logic as focus event
        window.dispatchEvent(new Event('focus'));
    }
});
```

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ slots.html

–ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –≥–¥–µ slots.html –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –≤—ã–∏–≥—Ä—ã—à–∞ –∏ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ:

1. **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Supabase:**
```javascript
// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á—Ç–æ-—Ç–æ —Ç–∞–∫–æ–µ –≤ slots.html:
await supabase
    .from('players')
    .update({ tama_balance: newBalance })
    .eq('telegram_id', userId);
```

2. **–ò–õ–ò –∏—Å–ø–æ–ª—å–∑—É–µ—Ç API:**
```javascript
// –ò–ª–∏ —á–µ—Ä–µ–∑ API:
await fetch('/api/tama/update-balance', {
    method: 'POST',
    body: JSON.stringify({ 
        telegram_id: userId, 
        balance: newBalance 
    })
});
```

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "Refresh Balance"

**–í UI (–æ–∫–æ–ª–æ –±–∞–ª–∞–Ω—Å–∞ TAMA):**

```html
<button onclick="refreshBalance()" style="...">
    üîÑ Sync
</button>
```

```javascript
async function refreshBalance() {
    const userId = window.TELEGRAM_USER_ID || window.WALLET_USER_ID;
    if (!userId) {
        showMessage('‚ùå No user ID found');
        return;
    }

    showMessage('üîÑ Syncing balance...');
    await loadFromSupabase(String(userId));
    updateUI();
    showMessage('‚úÖ Balance synced!');
}
```

---

## üìä –ß–¢–û –ü–†–û–í–ï–†–ò–¢–¨ –í SLOTS.HTML:

–ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ `slots.html`:

1. **–ì–¥–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —Å–ø–∏–Ω–∞:**
```javascript
// –ò—Å–∫–∞—Ç—å —á—Ç–æ-—Ç–æ –ø–æ—Ö–æ–∂–µ–µ –Ω–∞:
balance += winAmount;
// –∏–ª–∏
playerBalance = playerBalance + winnings;
```

2. **–ï—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Supabase:**
```javascript
// –ò—Å–∫–∞—Ç—å:
supabase.from('players').update(...)
// –∏–ª–∏
fetch('/api/tama/...')
```

3. **–ì–¥–µ –±–∞–ª–∞–Ω—Å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏:**
```javascript
// –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
const { data } = await supabase
    .from('players')
    .select('tama_balance')
    .eq('telegram_id', userId);
```

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:

1. ‚úÖ **–°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤—å SQL (—É–±–µ—Ä–∏ unified_users –∏–∑ –∑–∞–ø—Ä–æ—Å–∞)**
2. ‚è≥ **–ü—Ä–æ–≤–µ—Ä—å slots.html:** –Ω–∞–π–¥–∏ —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
3. ‚è≥ **–î–æ–±–∞–≤—å focus listener** –≤ tamagotchi-game.html
4. ‚è≥ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π flow:**
   - –û—Ç–∫—Ä–æ–π –∏–≥—Ä—É, –∑–∞–ø–æ–º–Ω–∏ –±–∞–ª–∞–Ω—Å
   - –û—Ç–∫—Ä–æ–π slots.html, —Å—ã–≥—Ä–∞–π, –∑–∞—Ä–∞–±–æ—Ç–∞–π TAMA
   - –í–µ—Ä–Ω–∏—Å—å –≤ –∏–≥—Ä—É
   - –ë–∞–ª–∞–Ω—Å –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

**–•–æ—á–µ—à—å —è —Å–µ–π—á–∞—Å –¥–æ–±–∞–≤–ª—é focus listener –∏ –ø—Ä–æ–≤–µ—Ä—é slots.html?** üîß
