# üí∞ BALANCE SYNCHRONIZATION - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞

## üéØ –ï–î–ò–ù–´–ô –ò–°–¢–û–ß–ù–ò–ö –ë–ê–õ–ê–ù–°–ê

–í—Å–µ –∏–≥—Ä—ã –∏ –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫** –±–∞–ª–∞–Ω—Å–∞:

```
Supabase ‚Üí leaderboard.tama
```

---

## üìä –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         UNIFIED BALANCE SYSTEM          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                         ‚îÇ
‚îÇ  üé∞ slots.html  ‚Üí  API  ‚Üí  leaderboard.tama
‚îÇ  üé° wheel.html  ‚Üí  API  ‚Üí  leaderboard.tama
‚îÇ  üçÑ platformer  ‚Üí  API  ‚Üí  leaderboard.tama
‚îÇ  ü§ñ Bot         ‚Üí  API  ‚Üí  leaderboard.tama
‚îÇ                                         ‚îÇ
‚îÇ  –í—Å–µ —á–∏—Ç–∞—é—Ç –∏ –ø–∏—à—É—Ç –≤ –æ–¥–Ω–æ –º–µ—Å—Ç–æ!     ‚îÇ
‚îÇ                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ SLOTS.HTML ‚Üí –ë–û–¢

### –ö–æ–≥–¥–∞ –∏–≥—Ä–∞–µ—à—å –≤ slots.html:

1. **–î–µ–ª–∞–µ—à—å —Å–ø–∏–Ω** ‚Üí API —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç–∞–≤–∫—É
2. **–í—ã–∏–≥—Ä—ã–≤–∞–µ—à—å** ‚Üí API –Ω–∞—á–∏—Å–ª—è–µ—Ç –≤—ã–∏–≥—Ä—ã—à
3. **API –æ–±–Ω–æ–≤–ª—è–µ—Ç** `leaderboard.tama`
4. **–ë–æ—Ç —á–∏—Ç–∞–µ—Ç** –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏–∑ `leaderboard.tama`

### –ü—Ä–∏–º–µ—Ä:

```
1. –ë–∞–ª–∞–Ω—Å –≤ –±–æ—Ç–µ: 10,000 TAMA
   ‚Üì
2. –û—Ç–∫—Ä—ã–≤–∞–µ—à—å slots.html
   –ë–∞–ª–∞–Ω—Å: 10,000 TAMA (–∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ leaderboard.tama)
   ‚Üì
3. –î–µ–ª–∞–µ—à—å —Å–ø–∏–Ω 500 TAMA
   API –æ–±–Ω–æ–≤–ª—è–µ—Ç: leaderboard.tama = 9,500
   ‚Üì
4. –í—ã–∏–≥—Ä—ã–≤–∞–µ—à—å 5,000 TAMA
   API –æ–±–Ω–æ–≤–ª—è–µ—Ç: leaderboard.tama = 14,500
   ‚Üì
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—à—å—Å—è –≤ –±–æ—Ç–∞
   –ë–∞–ª–∞–Ω—Å –≤ –±–æ—Ç–µ: 14,500 TAMA ‚úÖ
```

---

## ‚úÖ –ë–û–¢ ‚Üí SLOTS.HTML

### –ö–æ–≥–¥–∞ –∏–≥—Ä–∞–µ—à—å –≤ –±–æ—Ç–µ:

1. **–ü–æ–ª—É—á–∞–µ—à—å –Ω–∞–≥—Ä–∞–¥—É** ‚Üí –ë–æ—Ç –Ω–∞—á–∏—Å–ª—è–µ—Ç TAMA
2. **–ë–æ—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç** `leaderboard.tama`
3. **–û—Ç–∫—Ä—ã–≤–∞–µ—à—å slots.html**
4. **slots.html –∑–∞–≥—Ä—É–∂–∞–µ—Ç** –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏–∑ API
5. **API —á–∏—Ç–∞–µ—Ç** –∏–∑ `leaderboard.tama`

### –ü—Ä–∏–º–µ—Ä:

```
1. –ë–∞–ª–∞–Ω—Å –≤ –±–æ—Ç–µ: 10,000 TAMA
   ‚Üì
2. –ü–æ–ª—É—á–∞–µ—à—å daily reward: +5,000 TAMA
   –ë–æ—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç: leaderboard.tama = 15,000
   ‚Üì
3. –û—Ç–∫—Ä—ã–≤–∞–µ—à—å slots.html
   slots.html –∑–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ API
   API —á–∏—Ç–∞–µ—Ç –∏–∑ leaderboard.tama
   –ë–∞–ª–∞–Ω—Å: 15,000 TAMA ‚úÖ
```

---

## üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø

### –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–≥—Ä—ã:

`slots.html` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å:

```javascript
// –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
async function initialize() {
    await loadUserData(); // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∏–∑ API
    // API —á–∏—Ç–∞–µ—Ç –∏–∑ leaderboard.tama
}
```

### –ü—Ä–∏ –∫–∞–∂–¥–æ–º —Å–ø–∏–Ω–µ:

API –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:

```javascript
// –ü–æ—Å–ª–µ —Å–ø–∏–Ω–∞
const response = await updateBalance(-bet, []);
// response.balance = –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –∏–∑ leaderboard.tama
balance = response.balance; // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
```

---

## üì° API ENDPOINTS

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞:

```
GET /api/tama/balance?telegram_id=123456789

Response:
{
  "success": true,
  "total_tama": 15000,
  "database_tama": 15000  // –ò–∑ leaderboard.tama
}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (slots):

```
POST /api/tama/slots/spin

Body:
{
  "telegram_id": "123456789",
  "amount": -500,  // –°—Ç–∞–≤–∫–∞
  "bet": 500,
  "win": 0,
  "symbols": [],
  "init_data": "..."
}

Response:
{
  "success": true,
  "balance": 14500,  // –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –∏–∑ leaderboard.tama
  "amount": -500,
  "balance_before": 15000,
  "balance_after": 14500
}
```

---

## üêõ TROUBLESHOOTING

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–ª–∞–Ω—Å –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–∞–ª–∞–Ω—Å –≤ –±–æ—Ç–µ: 10,000
- –ë–∞–ª–∞–Ω—Å –≤ slots.html: 5,000
- –ù–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!

**–†–µ—à–µ–Ω–∏–µ 1: –ü—Ä–æ–≤–µ—Ä—å API**

```bash
# –û—Ç–∫—Ä–æ–π Render ‚Üí API ‚Üí Logs
# –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ API –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å:
‚úÖ Slots spin successful: balance = 14500
üí∞ Balance update: 10000 + (-500) = 9500
```

**–†–µ—à–µ–Ω–∏–µ 2: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ –∏–≥—Ä—É**

```
1. –ó–∞–∫—Ä–æ–π slots.html
2. –û—Ç–∫—Ä–æ–π –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
3. –ë–∞–ª–∞–Ω—Å –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∏–∑ leaderboard.tama
```

**–†–µ—à–µ–Ω–∏–µ 3: –ü—Ä–æ–≤–µ—Ä—å Supabase**

```sql
-- –í Supabase ‚Üí SQL Editor
SELECT telegram_id, tama FROM leaderboard 
WHERE telegram_id = '7401131043';

-- –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–ª–∞–Ω—Å –æ–±–Ω—É–ª—è–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –û—à–∏–±–∫–∞ –≤ API (–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç leaderboard.tama)
2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π user_id
3. –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ API
üîê Security: Validate Telegram WebApp authentication
‚úÖ Telegram auth validated for user: 7401131043
üí∞ Balance update: 10000 + (-500) = 9500
‚úÖ Slots spin successful: balance = 9500

# –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –æ—à–∏–±–∫–∏:
‚ùå Failed to update balance: ...
üö´ Telegram auth failed: ...

# –ó–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ —Å API –∏–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
```

---

## üéØ –ì–ê–†–ê–ù–¢–ò–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò

### –í—Å–µ –∏–≥—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫:

| –ò–≥—Ä–∞ | –ò—Å—Ç–æ—á–Ω–∏–∫ –±–∞–ª–∞–Ω—Å–∞ | API Endpoint |
|------|------------------|--------------|
| ü§ñ Bot | `leaderboard.tama` | Direct Supabase |
| üé∞ Slots | `leaderboard.tama` | `/api/tama/slots/spin` |
| üé° Wheel | `leaderboard.tama` | `/api/tama/balance` |
| üçÑ Platformer | `leaderboard.tama` | `/api/tama/balance` |
| üèóÔ∏è Tower | `leaderboard.tama` | `/api/tama/balance` |

### API –≤—Å–µ–≥–¥–∞:

1. ‚úÖ –ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∏–∑ `leaderboard.tama`
2. ‚úÖ –í—ã—á–∏—Å–ª—è–µ—Ç –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
3. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç `leaderboard.tama`
4. ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –≤ –æ—Ç–≤–µ—Ç–µ
5. ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ `transactions`

---

## üìù –ö–û–î –ü–†–ò–ú–ï–†–ê

### –ö–∞–∫ slots.html –∑–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–ª–∞–Ω—Å:

```javascript
async function loadUserData() {
    const response = await fetch(
        `${API_BASE}/balance?telegram_id=${userId}`
    );
    
    if (response.ok) {
        const data = await response.json();
        // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∏–∑ leaderboard.tama
        balance = data.total_tama || data.database_tama || 0;
        document.getElementById('balance').textContent = balance;
    }
}
```

### –ö–∞–∫ slots.html –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å:

```javascript
async function updateBalance(amount, symbols) {
    const response = await fetch(`${API_BASE}/slots/spin`, {
        method: 'POST',
        body: JSON.stringify({
            telegram_id: userId,
            amount: amount,
            bet: Math.abs(amount),
            win: amount > 0 ? amount : 0,
            symbols: symbols,
            init_data: window.Telegram.WebApp.initData
        })
    });
    
    if (response.ok) {
        const data = await response.json();
        // API –≤–µ—Ä–Ω—É–ª –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏–∑ leaderboard.tama
        balance = data.balance;
        document.getElementById('balance').textContent = balance;
    }
}
```

### –ö–∞–∫ API –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å:

```php
// api/tama_supabase.php - handleSlotsSpin()

// 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
$currentBalance = (int)$user['tama'];

// 2. –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
$newBalance = $currentBalance + $amount;

// 3. –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
supabaseRequest($url, $key, 'PATCH', 'leaderboard', [
    'telegram_id' => 'eq.' . $telegramId
], [
    'tama' => $newBalance  // –û–±–Ω–æ–≤–ª—è–µ–º leaderboard.tama
]);

// 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
echo json_encode([
    'success' => true,
    'balance' => $newBalance  // –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å
]);
```

---

## ‚úÖ CHECKLIST

- [ ] –í—Å–µ –∏–≥—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ (`leaderboard.tama`)
- [ ] API –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å
- [ ] API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å –≤ –æ—Ç–≤–µ—Ç–µ
- [ ] Frontend –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
- [ ] –ë–æ—Ç —á–∏—Ç–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∏–∑ `leaderboard.tama`
- [ ] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `transactions`

---

## üéØ –ò–¢–û–ì–û

```
‚úÖ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –±–∞–ª–∞–Ω—Å–∞: leaderboard.tama
‚úÖ –í—Å–µ –∏–≥—Ä—ã —á–∏—Ç–∞—é—Ç –∏ –ø–∏—à—É—Ç –≤ –æ–¥–Ω–æ –º–µ—Å—Ç–æ
‚úÖ API –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
‚úÖ –ë–∞–ª–∞–Ω—Å –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
```

**–ë–∞–ª–∞–Ω—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –º–µ–∂–¥—É –≤—Å–µ–º–∏ –∏–≥—Ä–∞–º–∏ –∏ –±–æ—Ç–æ–º!**

