<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokenomics Dashboard - TAMA</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
            border-radius: 15px; 
            padding: 25px;
            border: 2px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; }
        .stat-card .big-number { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .stat-card small { opacity: 0.8; font-size: 0.85em; }
        .chart-container { 
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .withdrawal-table { 
            width: 100%;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; }
        th { background: rgba(0,0,0,0.3); font-weight: 600; }
        tr:nth-child(even) { background: rgba(255,255,255,0.05); }
        .btn { 
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 5px;
            transition: transform 0.2s ease;
        }
        .btn:hover { transform: scale(1.05); }
        .progress-bar { 
            width: 100%;
            height: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill { 
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ TAMA TOKENOMICS DASHBOARD</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üìä TOTAL SUPPLY</h3>
                <div class="big-number">1,000,000,000</div>
                <small>Fixed maximum supply</small>
            </div>
            
            <div class="stat-card">
                <h3>üí´ CIRCULATING SUPPLY</h3>
                <div class="big-number" id="circulating">0</div>
                <small>Actually withdrawn to wallets</small>
            </div>
            
            <div class="stat-card">
                <h3>üî• BURNED (Virtual)</h3>
                <div class="big-number" id="burned">0</div>
                <small>From withdrawal fees (60%)</small>
            </div>
            
            <div class="stat-card">
                <h3>üíß DAILY POOL</h3>
                <div class="big-number" id="daily-pool">2,222,222</div>
                <small id="daily-pool-period">Year 1 H1 (400M / 180 days)</small>
            </div>
        </div>

        <div class="chart-container">
            <h2>‚è∞ HALVING COUNTDOWN</h2>
            <p id="halving-text">Next halving in <strong id="days-left">180</strong> days</p>
            <div class="progress-bar">
                <div class="progress-fill" id="halving-progress" style="width: 0%">0%</div>
            </div>
            <small id="halving-countdown">After halving: Daily Pool will be 1,111,111 TAMA/day</small>
        </div>

        <div class="chart-container">
            <h2>üìà TOKEN EMISSION CHART</h2>
            <canvas id="emissionChart"></canvas>
        </div>

        <div class="chart-container">
            <h2>üí∏ RECENT WITHDRAWALS</h2>
            <button class="btn" onclick="loadWithdrawals()">üîÑ Refresh</button>
            <div class="withdrawal-table">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Fee</th>
                            <th>Net</th>
                            <th>Signature</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-list">
                        <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Supabase connection
        const SUPABASE_URL = 'https://zfrazyupameidxpjihrh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcmF6eXVwYW1laWR4cGppaHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5Mzc1NTAsImV4cCI6MjA3NTUxMzU1MH0.1EkMDqCNJoAjcJDh3Dd3yPfus-JpdcwE--z2dhjh7wU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Load statistics
        async function loadStats() {
            try {
                // Try multiple table names and column names
                let withdrawals = [];
                let error = null;
                
                // Try tama_economy with transaction_type
                let result = await supabase
                    .from('tama_economy')
                    .select('amount')
                    .eq('transaction_type', 'withdrawal');
                
                if (result.error && result.error.code !== 'PGRST116') {
                    // Try withdrawals table
                    result = await supabase
                        .from('withdrawals')
                        .select('amount');
                }
                
                if (result.error && result.error.code !== 'PGRST116') {
                    // Try leaderboard total_withdrawn
                    result = await supabase
                        .from('leaderboard')
                        .select('total_withdrawn');
                    
                    if (!result.error && result.data) {
                        // total_withdrawn —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç net amount (–ø–æ—Å–ª–µ fee)
                        const circulating = result.data.reduce((sum, user) => sum + (user.total_withdrawn || 0), 0);
                        document.getElementById('circulating').textContent = circulating.toLocaleString();
                        // –ü–†–ê–í–ò–õ–¨–ù–û: –°—á–∏—Ç–∞—Ç—å burned –æ—Ç —Å—É–º–º—ã –≤—Å–µ—Ö fee
                        // –ï—Å–ª–∏ total_withdrawn = net amount, —Ç–æ fee = withdrawn / 0.95 * 0.05
                        const totalWithdrawn = circulating;
                        const totalAmount = totalWithdrawn / 0.95;  // –í–µ—Ä–Ω—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º–µ (–¥–æ fee)
                        const totalFees = totalAmount - totalWithdrawn;
                        const burned = Math.floor(totalFees * 0.60);
                        document.getElementById('burned').textContent = burned.toLocaleString();
                        return;
                    }
                }
                
                if (result.error) {
                    console.error('Supabase error:', result.error);
                    document.getElementById('circulating').textContent = '0';
                    document.getElementById('burned').textContent = '0';
                    return;
                }
                
                withdrawals = result.data || [];
                // –ü–†–ê–í–ò–õ–¨–ù–û: –°—á–∏—Ç–∞—Ç—å –æ—Ç amount_sent (—Ä–µ–∞–ª—å–Ω–æ –≤—ã–≤–µ–¥–µ–Ω–æ), –∞ –Ω–µ –æ—Ç amount
                const circulating = withdrawals.reduce((sum, tx) => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º amount_sent (net amount) –∏–ª–∏ amount - fee
                    const amountSent = tx.amount_sent || tx.net_amount || (Math.abs(tx.amount || 0) * 0.95);
                    return sum + Math.abs(amountSent);
                }, 0);
                document.getElementById('circulating').textContent = circulating.toLocaleString();
                
                // –ü–†–ê–í–ò–õ–¨–ù–û: –°—á–∏—Ç–∞—Ç—å burned –æ—Ç —Å—É–º–º—ã –≤—Å–µ—Ö fee, –∞ –Ω–µ –æ—Ç circulating
                const totalFees = withdrawals.reduce((sum, tx) => {
                    const fee = tx.fee || Math.floor(Math.abs(tx.amount || 0) * 0.05);
                    return sum + fee;
                }, 0);
                const burned = Math.floor(totalFees * 0.60);  // 60% –æ—Ç fee —Å–∂–∏–≥–∞–µ—Ç—Å—è
                document.getElementById('burned').textContent = burned.toLocaleString();
                
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('circulating').textContent = '0';
                document.getElementById('burned').textContent = '0';
            }
        }

        // Load withdrawals
        async function loadWithdrawals() {
            try {
                const tbody = document.getElementById('withdrawals-list');
                let result = null;
                
                // Try multiple table names
                // 1. Try tama_economy with transaction_type
                result = await supabase
                    .from('tama_economy')
                    .select('*')
                    .eq('transaction_type', 'withdrawal')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (result.error && result.error.code !== 'PGRST116') {
                    // 2. Try withdrawals table
                    result = await supabase
                        .from('withdrawals')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(50);
                }
                
                if (result.error) {
                    console.error('Supabase error:', result.error);
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#ef4444;">Table not found. Please create tama_economy or withdrawals table in Supabase.</td></tr>';
                    return;
                }
                
                const data = result.data || [];
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No withdrawals yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(tx => {
                    const amount = Math.abs(tx.amount || 0);
                    const fee = Math.floor(amount * 0.05);
                    const net = amount - fee;
                    const time = new Date(tx.created_at || tx.completed_at || Date.now()).toLocaleString();
                    const sig = (tx.signature || tx.tx_signature || '').substring(0, 8) + '...' || 'N/A';
                    const telegramId = tx.telegram_id || 'N/A';
                    
                    return `
                        <tr>
                            <td>${time}</td>
                            <td>${telegramId}</td>
                            <td>${amount.toLocaleString()} TAMA</td>
                            <td>${fee.toLocaleString()} TAMA</td>
                            <td>${net.toLocaleString()} TAMA</td>
                            <td><code>${sig}</code></td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading withdrawals:', error);
                const tbody = document.getElementById('withdrawals-list');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#ef4444;">Error: ' + error.message + '</td></tr>';
            }
        }

        // Calculate P2E Pool info
        function calculateP2EPoolInfo() {
            const launchDate = new Date('2025-11-01');
            const now = new Date();
            const daysSinceLaunch = Math.floor((now - launchDate) / (1000 * 60 * 60 * 24));
            
            // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥ (—Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –ø–µ—Ä–∏–æ–¥–æ–≤)
            let periodNumber = 0;
            let daysInPeriod = daysSinceLaunch;
            let daysLeftInPeriod = 0;
            
            // –ù–∞–π—Ç–∏ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥
            for (let i = 0; i < periods.length; i++) {
                if (daysInPeriod < periods[i].days) {
                    periodNumber = i;
                    daysLeftInPeriod = periods[i].days - daysInPeriod;
                    break;
                }
                daysInPeriod -= periods[i].days;
            }
            
            // –ï—Å–ª–∏ –≤—Å–µ –ø–µ—Ä–∏–æ–¥—ã –ø—Ä–æ—à–ª–∏
            if (periodNumber >= periods.length) {
                periodNumber = periods.length - 1;
                daysInPeriod = periods[periodNumber].days;
                daysLeftInPeriod = 0;
            }
            
            // –ü–µ—Ä–∏–æ–¥—ã –∏ –∏—Ö –ø—É–ª—ã (400M –≤—Å–µ–≥–æ, —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π Daily Pool –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –º–∞–π–Ω–∏–Ω–≥–∞)
            // Daily Pool —É–º–µ–Ω—å—à–µ–Ω –Ω–∞ ~30% –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –º–∞–π–Ω–∏–Ω–≥–∞ —Å 4 –¥–æ 5.5 –ª–µ—Ç
            const periods = [
                { name: 'Year 1 H1', pool: 200000000, daily: 800000, days: 250 },
                { name: 'Year 1 H2', pool: 100000000, daily: 392157, days: 255 },
                { name: 'Year 2 H1', pool: 50000000, daily: 200000, days: 250 },
                { name: 'Year 2 H2', pool: 25000000, daily: 98039, days: 255 },
                { name: 'Year 3 H1', pool: 12500000, daily: 50000, days: 250 },
                { name: 'Year 3 H2', pool: 6250000, daily: 24510, days: 255 },
                { name: 'Year 4 H1', pool: 3125000, daily: 12500, days: 250 },
                { name: 'Year 4 H2', pool: 1562500, daily: 6127, days: 255 }
            ];
            
            const currentPeriod = periods[periodNumber] || periods[periods.length - 1];
            const nextPeriod = periods[periodNumber + 1] || null;
            
            // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º —Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π
            const distributed = Math.min(daysInPeriod * currentPeriod.daily, currentPeriod.pool);
            const remaining = Math.max(0, currentPeriod.pool - distributed);
            
            return {
                currentPeriod: currentPeriod.name,
                dailyPool: currentPeriod.daily,
                initialPool: currentPeriod.pool,
                distributed: distributed,
                remaining: remaining,
                daysInPeriod: daysInPeriod,
                daysLeft: daysLeftInPeriod,
                nextPeriod: nextPeriod ? nextPeriod.name : 'End',
                nextDailyPool: nextPeriod ? nextPeriod.daily : 0
            };
        }

        // Update Daily Pool display
        function updateDailyPool() {
            const poolInfo = calculateP2EPoolInfo();
            document.getElementById('daily-pool').textContent = poolInfo.dailyPool.toLocaleString();
            document.getElementById('daily-pool-period').textContent = 
                `${poolInfo.currentPeriod} (${(poolInfo.remaining / 1000000).toFixed(1)}M remaining)`;
        }

        // Halving countdown
        function updateHalvingCountdown() {
            const poolInfo = calculateP2EPoolInfo();
            const daysLeft = poolInfo.daysLeft;
            const progress = (poolInfo.daysInPeriod / 180) * 100;
            
            document.getElementById('days-left').textContent = daysLeft;
            document.getElementById('halving-progress').style.width = progress + '%';
            document.getElementById('halving-progress').textContent = progress.toFixed(1) + '%';
            
            // Update halving text
            const halvingNote = document.getElementById('halving-countdown');
            if (poolInfo.nextPeriod !== 'End') {
                document.getElementById('halving-text').innerHTML = 
                    `Next halving in <strong>${daysLeft}</strong> days<br>` +
                    `<small>Current: ${poolInfo.currentPeriod} ‚Üí Next: ${poolInfo.nextPeriod}</small>`;
                if (halvingNote) {
                    halvingNote.textContent = `After halving: Daily Pool will be ${poolInfo.nextDailyPool.toLocaleString()} TAMA/day`;
                }
            } else {
                document.getElementById('halving-text').innerHTML = 
                    `<strong>All halvings completed</strong><br>` +
                    `<small>Current: ${poolInfo.currentPeriod}</small>`;
                if (halvingNote) {
                    halvingNote.textContent = `Final period: ${poolInfo.currentPeriod}`;
                }
            }
        }

        // Emission chart
        function createEmissionChart() {
            const ctx = document.getElementById('emissionChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5-8'],
                    datasets: [{
                        label: 'TAMA Emission (Millions)',
                        data: [600, 150, 37.5, 9.375, 2.125],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#fff' } },
                        title: { display: true, text: 'Bitcoin-Style Halving Schedule', color: '#fff' }
                    },
                    scales: {
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadWithdrawals();
            updateDailyPool();
            updateHalvingCountdown();
            createEmissionChart();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadStats();
                loadWithdrawals();
                updateDailyPool();
                updateHalvingCountdown();
            }, 30000);
        });
    </script>
</body>
</html>

