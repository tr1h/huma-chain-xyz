# üîê SECURITY SETUP - –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–∫—Ä—É—Ç–∫–∏ –∏ —Å–∫–∞–º–∞

## ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê (–î–û):

```
‚ùå https://solanatamagotchi.com/slots.html?user_id=7401131043
   –õ—é–±–æ–π –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å user_id –≤ URL –∏:
   - –¢—Ä–∞—Ç–∏—Ç—å —á—É–∂–æ–π –±–∞–ª–∞–Ω—Å
   - –í—ã–∏–≥—Ä—ã–≤–∞—Ç—å –Ω–∞ —á—É–∂–æ–π –∞–∫–∫–∞—É–Ω—Ç
   - –ü–æ–¥–¥–µ–ª—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
```

## ‚úÖ –†–ï–®–ï–ù–ò–ï (–ü–û–°–õ–ï):

Telegram WebApp Authentication - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π** `initData`, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å –±–µ–∑ `BOT_TOKEN`.

---

## üõ°Ô∏è –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –ó–ê–©–ò–¢–ê:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–≥—Ä—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞
   ‚Üì
2. Telegram WebApp –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç initData
   (–ø–æ–¥–ø–∏—Å–∞–Ω–æ BOT_TOKEN - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á)
   ‚Üì
3. slots.html –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç initData –≤ API
   ‚Üì
4. API –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –∏—Å–ø–æ–ª—å–∑—É—è BOT_TOKEN
   ‚Üì
5. –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å—å –≤–∞–ª–∏–¥–Ω–∞:
      ‚úÖ –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å
      ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º user_id –∏–∑ initData (–Ω–µ –∏–∑ URL!)
   
   –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å—å –Ω–µ–≤–∞–ª–∏–¥–Ω–∞:
      ‚ùå –û—Ç–∫–ª–æ–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å (403 Unauthorized)
```

---

## üìã –ù–ê–°–¢–†–û–ô–ö–ê

### –®–∞–≥ 1: –î–æ–±–∞–≤—å BOT_TOKEN –≤ Render (API)

1. –û—Ç–∫—Ä–æ–π Render Dashboard
2. –ù–∞–π–¥–∏ –ø—Ä–æ–µ–∫—Ç —Å **API** (–Ω–µ –±–æ—Ç!)
3. –ü–µ—Ä–µ–π–¥–∏ –≤ **Environment**
4. –î–æ–±–∞–≤—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é:

```
BOT_TOKEN=YOUR_BOT_TOKEN_HERE
```

**–ì–¥–µ –≤–∑—è—Ç—å BOT_TOKEN?**

- –≠—Ç–æ —Ç–æ–∫–µ–Ω —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞ –æ—Ç @BotFather
- –ü—Ä–∏–º–µ—Ä: `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`

### –®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ API

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è `BOT_TOKEN`, Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç API.

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏

–í Render ‚Üí Logs ‚Üí API –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏:

```
‚úÖ Telegram auth validated for user: 7401131043
```

–ò–ª–∏ (–µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–¥–µ–ª–∞—Ç—å):

```
üö´ Telegram auth failed: Invalid hash - data may be tampered
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### ‚úÖ –õ–µ–≥–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:

1. –û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ –≤ Telegram
2. –ù–∞–∂–º–∏ `/slots`
3. –û—Ç–∫—Ä–æ–π –∏–≥—Ä—É
4. –°–¥–µ–ª–∞–π —Å–ø–∏–Ω ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

### ‚ùå –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–¥–µ–ª–∫–∏:

1. –û—Ç–∫—Ä–æ–π `https://solanatamagotchi.com/slots.html?user_id=–î–†–£–ì–û–ô_ID`
2. –ü–æ–ø—Ä–æ–±—É–π —Å–¥–µ–ª–∞—Ç—å —Å–ø–∏–Ω
3. –ü–æ–ª—É—á–∏—à—å –æ—à–∏–±–∫—É: `403 Unauthorized` ‚ùå

---

## üîí –ß–¢–û –ó–ê–©–ò–©–ï–ù–û:

### ‚úÖ Slots API (`/api/tama/slots/spin`):

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `initData` –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Å–ø–∏–Ω–æ–º
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `user_id` –∏–∑ `initData`, –∞ –ù–ï –∏–∑ URL
- –û—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é

### üîß –ß—Ç–æ –µ—â–µ –Ω—É–∂–Ω–æ –∑–∞—â–∏—Ç–∏—Ç—å (TODO):

- [ ] `/api/tama/balance` (GET) - –∑–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
- [ ] `/api/tama/balance` (POST) - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- [ ] Wheel game API
- [ ] Other game APIs

---

## üìä –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨, –ß–¢–û –ó–ê–©–ò–¢–ê –†–ê–ë–û–¢–ê–ï–¢:

### –¢–µ—Å—Ç 1: –õ–µ–≥–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å

```bash
# –û—Ç–∫—Ä–æ–π slots.html —á–µ—Ä–µ–∑ –±–æ—Ç–∞
# –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ API:
‚úÖ Telegram auth validated for user: 7401131043
üé∞ Slots spin request: {...}
‚úÖ Slots spin successful: balance = 33000
```

### –¢–µ—Å—Ç 2: –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–¥–µ–ª–∫–∏

```bash
# –ü–æ–ø—Ä–æ–±—É–π –∏–∑–º–µ–Ω–∏—Ç—å user_id –≤ URL
# –ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å –∑–∞–ø—Ä–æ—Å –±–µ–∑ initData
# –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ API:
üö´ Telegram auth failed: Invalid hash
‚ùå 403 Unauthorized
```

---

## üîê –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ê–ª–≥–æ—Ä–∏—Ç–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

1. **–ü–∞—Ä—Å–∏–Ω–≥ initData** (query string)
2. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ hash** –∏–∑ initData
3. **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ secret_key**:
   ```
   secret_key = HMAC-SHA256("WebAppData", BOT_TOKEN)
   ```
4. **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ expected_hash**:
   ```
   data_check_string = "key1=value1\nkey2=value2\n..."
   expected_hash = HMAC-SHA256(data_check_string, secret_key)
   ```
5. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ hash** (constant-time comparison)
6. **–ü—Ä–æ–≤–µ—Ä–∫–∞ auth_date** (–Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)

### –§–∞–π–ª—ã:

- `api/telegram_auth.php` - —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `api/tama_supabase.php` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ `handleSlotsSpin()`
- `slots.html` - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `initData` –≤ API

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û!

### DEV MODE (–±–µ–∑ BOT_TOKEN):

–ï—Å–ª–∏ `BOT_TOKEN` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, API —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ **DEV MODE**:
- ‚ö†Ô∏è –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `initData`
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `telegram_id` –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ!)
- ‚ö†Ô∏è –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!

```
‚ö†Ô∏è BOT_TOKEN not set - using unvalidated telegram_id (DEV MODE ONLY!)
```

### PRODUCTION MODE (—Å BOT_TOKEN):

–ï—Å–ª–∏ `BOT_TOKEN` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, API —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ **PRODUCTION MODE**:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `initData`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `user_id` –∏–∑ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ `initData`
- ‚úÖ –û—Ç–∫–ª–æ–Ω—è–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (403)

```
‚úÖ Telegram auth validated for user: 7401131043
```

---

## üöÄ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê (TODO)

### 1. Rate Limiting

–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```php
// –ú–∞–∫—Å–∏–º—É–º 10 —Å–ø–∏–Ω–æ–≤ –≤ –º–∏–Ω—É—Ç—É
if (getUserSpinCount($userId, 60) > 10) {
    http_response_code(429);
    echo json_encode(['error' => 'Too many requests']);
    exit();
}
```

### 2. Server-Side Game Logic

–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∞ –Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:

```php
// API –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–ø–∏–Ω–∞
$result = generateSlotResult(); // ['üçí', 'üçã', 'üçä']
$win = calculateWin($result, $bet);
```

### 3. Transaction Logging

–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:

```php
// –õ–æ–≥ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–¥–µ–ª–∫–∏
if (!$validation['valid']) {
    logSecurityEvent([
        'type' => 'auth_failed',
        'ip' => $_SERVER['REMOTE_ADDR'],
        'user_agent' => $_SERVER['HTTP_USER_AGENT'],
        'error' => $validation['error']
    ]);
}
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢

- [ ] `BOT_TOKEN` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Render (API)
- [ ] API –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç `‚úÖ Telegram auth validated`
- [ ] –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å `user_id` –≤ URL –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è (403)
- [ ] –õ–µ–≥–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏–≥—Ä–∞—Ç—å
- [ ] `BOT_WEBHOOK_URL` –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤)

---

## üéØ –ò–¢–û–ì–û

### –î–û:
```
‚ùå –õ—é–±–æ–π –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å user_id –≤ URL
‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏
‚ùå –í–æ–∑–º–æ–∂–Ω–∞ –Ω–∞–∫—Ä—É—Ç–∫–∞ –±–∞–ª–∞–Ω—Å–∞
```

### –ü–û–°–õ–ï:
```
‚úÖ Telegram WebApp Authentication
‚úÖ –ü–æ–¥–ø–∏—Å—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å user_id
‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–∫—Ä—É—Ç–∫–∏ –∏ —Å–∫–∞–º–∞
```

---

**–í–ê–ñ–ù–û:** –ù–∞—Å—Ç—Ä–æ–π `BOT_TOKEN` –≤ Render (API), —á—Ç–æ–±—ã –∑–∞—â–∏—Ç–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞!

