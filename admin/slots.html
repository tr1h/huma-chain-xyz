<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé∞ Slots Admin - All Spins</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a0033 0%, #330066 50%, #1a0033 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #FFD700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #FFD700;
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-top: 5px;
        }

        .filters {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .filters input, .filters select {
            padding: 10px;
            border-radius: 8px;
            border: none;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .filters button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }

        table {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        th {
            background: rgba(255,215,0,0.2);
            color: #FFD700;
        }

        .win {
            color: #8AC926;
        }

        .loss {
            color: #ff6b6b;
        }

        .jackpot {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∞ SLOTS ADMIN PANEL</h1>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-spins">-</div>
                <div class="stat-label">Total Spins</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-wagered">-</div>
                <div class="stat-label">Total Wagered</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-won">-</div>
                <div class="stat-label">Total Won</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="house-edge">-</div>
                <div class="stat-label">House Edge</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="jackpot-count">-</div>
                <div class="stat-label">Jackpots Won</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="current-pool">-</div>
                <div class="stat-label">Current Pool</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <input type="text" id="filter-user" placeholder="Telegram ID">
            <select id="filter-result">
                <option value="">All Results</option>
                <option value="win">Wins Only</option>
                <option value="loss">Losses Only</option>
                <option value="jackpot">Jackpots Only</option>
            </select>
            <input type="number" id="filter-min-bet" placeholder="Min Bet">
            <input type="number" id="filter-min-win" placeholder="Min Win">
            <button onclick="loadSpins()">üîç Filter</button>
            <button onclick="clearFilters()">üîÑ Reset</button>
            <button onclick="exportCSV()">üì• Export CSV</button>
        </div>

        <!-- Table -->
        <div id="loading" class="loading">Loading spins...</div>
        <table id="spins-table" style="display: none;">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>User</th>
                    <th>Symbols</th>
                    <th>Bet</th>
                    <th>Win</th>
                    <th>Multiplier</th>
                    <th>Balance After</th>
                </tr>
            </thead>
            <tbody id="spins-body"></tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination" id="pagination"></div>
    </div>

    <script src="../js/config.js"></script>
    <!-- Admin Authentication -->
    <script src="../admin-password.js"></script>
    <script src="../js/admin-auth.js"></script>
    <script>
        const SUPABASE_URL = window.CONFIG?.SUPABASE_URL || 'https://zfrazyupameidxpjihrh.supabase.co';
        const SUPABASE_KEY = window.CONFIG?.SUPABASE_KEY || '';
        const supabase = window.getSupabase ? window.getSupabase() : window.supabase?.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentPage = 1;
        const perPage = 50;
        let allSpins = [];

        async function loadStats() {
            try {
                // Get all transactions
                const { data: transactions, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .in('type', ['slots_bet', 'slots_win', 'slots_spin'])
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Calculate stats
                const bets = transactions.filter(t => t.type === 'slots_bet' || (t.amount < 0 && t.type === 'slots_spin'));
                const wins = transactions.filter(t => t.type === 'slots_win' || (t.amount > 0 && t.type === 'slots_spin'));

                const totalWagered = bets.reduce((sum, t) => sum + Math.abs(t.amount), 0);
                const totalWon = wins.reduce((sum, t) => sum + Math.abs(t.amount), 0);
                const houseEdge = totalWagered > 0 ? ((totalWagered - totalWon) / totalWagered * 100).toFixed(2) : 0;

                // Count jackpots
                const jackpots = transactions.filter(t => {
                    try {
                        const metadata = typeof t.metadata === 'string' ? JSON.parse(t.metadata) : t.metadata;
                        return metadata?.is_jackpot === true;
                    } catch {
                        return false;
                    }
                });

                // Get jackpot pool
                const { data: pool } = await supabase
                    .from('slots_jackpot_pool')
                    .select('current_pool')
                    .eq('id', 1)
                    .single();

                document.getElementById('total-spins').textContent = bets.length.toLocaleString();
                document.getElementById('total-wagered').textContent = totalWagered.toLocaleString();
                document.getElementById('total-won').textContent = totalWon.toLocaleString();
                document.getElementById('house-edge').textContent = houseEdge + '%';
                document.getElementById('jackpot-count').textContent = jackpots.length;
                document.getElementById('current-pool').textContent = (pool?.current_pool || 0).toLocaleString();

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadSpins() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('spins-table').style.display = 'none';

                let query = supabase
                    .from('transactions')
                    .select('*')
                    .in('type', ['slots_bet', 'slots_win', 'slots_spin'])
                    .order('created_at', { ascending: false })
                    .limit(1000);

                // Apply filters
                const filterUser = document.getElementById('filter-user').value;
                if (filterUser) {
                    query = query.eq('telegram_id', filterUser);
                }

                const { data: transactions, error } = await query;
                if (error) throw error;

                // Group by spin (bet + win)
                const spins = [];
                const processed = new Set();

                for (const tx of transactions) {
                    if (processed.has(tx.id)) continue;

                    const metadata = typeof tx.metadata === 'string' ? JSON.parse(tx.metadata) : (tx.metadata || {});

                    spins.push({
                        time: new Date(tx.created_at).toLocaleString(),
                        user: tx.telegram_id,
                        symbols: metadata.symbols || ['?', '?', '?'],
                        bet: metadata.bet || Math.abs(tx.amount),
                        win: metadata.win || 0,
                        multiplier: metadata.win && metadata.bet ? (metadata.win / metadata.bet).toFixed(1) : 0,
                        isJackpot: metadata.is_jackpot || false,
                        balanceAfter: tx.balance_after || 0
                    });

                    processed.add(tx.id);
                }

                // Apply result filter
                const filterResult = document.getElementById('filter-result').value;
                const filterMinBet = parseInt(document.getElementById('filter-min-bet').value) || 0;
                const filterMinWin = parseInt(document.getElementById('filter-min-win').value) || 0;

                allSpins = spins.filter(spin => {
                    if (filterResult === 'win' && spin.win === 0) return false;
                    if (filterResult === 'loss' && spin.win > 0) return false;
                    if (filterResult === 'jackpot' && !spin.isJackpot) return false;
                    if (spin.bet < filterMinBet) return false;
                    if (spin.win < filterMinWin) return false;
                    return true;
                });

                renderSpins();
                renderPagination();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('spins-table').style.display = 'table';

            } catch (error) {
                console.error('Error loading spins:', error);
                document.getElementById('loading').textContent = 'Error loading spins: ' + error.message;
            }
        }

        function renderSpins() {
            const tbody = document.getElementById('spins-body');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const pageSpins = allSpins.slice(start, end);

            for (const spin of pageSpins) {
                const row = tbody.insertRow();
                if (spin.isJackpot) row.className = 'jackpot';

                row.insertCell(0).textContent = spin.time;
                row.insertCell(1).textContent = spin.user;
                row.insertCell(2).textContent = spin.symbols.join(' ');
                row.insertCell(3).textContent = spin.bet.toLocaleString();

                const winCell = row.insertCell(4);
                winCell.textContent = spin.win.toLocaleString();
                winCell.className = spin.win > 0 ? 'win' : 'loss';

                row.insertCell(5).textContent = spin.multiplier > 0 ? `x${spin.multiplier}` : '-';
                row.insertCell(6).textContent = spin.balanceAfter.toLocaleString();
            }
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(allSpins.length / perPage);

            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚Üê Prev';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                currentPage--;
                renderSpins();
                renderPagination();
            };
            pagination.appendChild(prevBtn);

            for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = i === currentPage ? 'active' : '';
                btn.onclick = () => {
                    currentPage = i;
                    renderSpins();
                    renderPagination();
                };
                pagination.appendChild(btn);
            }

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next ‚Üí';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                currentPage++;
                renderSpins();
                renderPagination();
            };
            pagination.appendChild(nextBtn);
        }

        function clearFilters() {
            document.getElementById('filter-user').value = '';
            document.getElementById('filter-result').value = '';
            document.getElementById('filter-min-bet').value = '';
            document.getElementById('filter-min-win').value = '';
            loadSpins();
        }

        function exportCSV() {
            const csv = [
                ['Time', 'User', 'Symbols', 'Bet', 'Win', 'Multiplier', 'Balance After'].join(','),
                ...allSpins.map(spin => [
                    spin.time,
                    spin.user,
                    spin.symbols.join(' '),
                    spin.bet,
                    spin.win,
                    spin.multiplier,
                    spin.balanceAfter
                ].join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `slots-spins-${Date.now()}.csv`;
            a.click();
        }

        // Initialize
        loadStats();
        loadSpins();
        setInterval(loadStats, 30000); // Refresh stats every 30s
    </script>
</body>
</html>

