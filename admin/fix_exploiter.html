<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Exploit Fixer</title>
    <script src="../js/config.js"></script>
    <!-- Load config for API keys -->
    <style>
      body {
        background: #111;
        color: #fff;
        font-family: monospace;
        padding: 20px;
      }
      .log {
        white-space: pre-wrap;
        margin-top: 10px;
        color: #0f0;
      }
      .error {
        color: #f00;
      }
    </style>
  </head>
  <body>
    <h1>üõ°Ô∏è Automated Exploit Rollback Tool</h1>
    <div id="status">Initializing...</div>
    <div id="log" class="log"></div>

    <script>
      const log = (msg, type = 'info') => {
        const el = document.getElementById('log');
        const line = document.createElement('div');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        if (type === 'error') line.className = 'error';
        el.appendChild(line);
        console.log(msg);
      };

      const EXPLOITER_WALLET = '7mckTJhKqQXMbr7DNcWqc5Lf8QFtdTaQmoNkT6esrx96';
      const EXPLOITER_USER_ID = 'wallet_7mckTJhKqQXM';

      async function runRollback() {
        try {
          // 1. Config Check
          const SUPABASE_URL = window.CONFIG?.SUPABASE_URL;
          const SUPABASE_KEY = window.CONFIG?.SUPABASE_KEY;

          if (!SUPABASE_URL || !SUPABASE_KEY) {
            throw new Error('CONFIG.SUPABASE_URL or SUPABASE_KEY missing in js/config.js');
          }

          const headers = {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            Prefer: 'return=representation',
          };

          log(`Target: ${EXPLOITER_WALLET}`);

          // 2. Fetch current user data (to verify existence)
          log('Fetching user...');
          const checkRes = await fetch(
            `${SUPABASE_URL}/rest/v1/wallet_users?wallet_address=eq.${EXPLOITER_WALLET}&select=*`,
            { headers }
          );
          const checkData = await checkRes.json();

          if (!checkData.length) {
            throw new Error('User not found!');
          }
          const currentBalance = checkData[0].tama_balance;
          log(`Found user. Current Balance: ${currentBalance} TAMA`);

          if (currentBalance === 0) {
            log('‚úÖ Balance is already 0. No rollback needed.');
            return;
          }

          // 3. Reset Balance
          log('‚è≥ Resetting balance to 0...');
          const updateRes = await fetch(
            `${SUPABASE_URL}/rest/v1/wallet_users?wallet_address=eq.${EXPLOITER_WALLET}`,
            {
              method: 'PATCH',
              headers: headers,
              body: JSON.stringify({ tama_balance: 0, updated_at: new Date().toISOString() }),
            }
          );

          if (!updateRes.ok) throw new Error(`Update failed: ${updateRes.statusText}`);
          log('‚úÖ Balance reset success!');

          // 4. Log Transaction
          log('üìù Creating audit log...');
          const txRes = await fetch(`${SUPABASE_URL}/rest/v1/transactions`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              user_id: EXPLOITER_USER_ID,
              wallet_address: EXPLOITER_WALLET,
              amount: -currentBalance,
              type: 'admin_rollback',
              balance_before: currentBalance,
              balance_after: 0,
              metadata: {
                reason: 'Security exploit rollback',
                exploit_type: 'client_side_slots_manipulation',
                automated: true,
              },
            }),
          });

          if (!txRes.ok) throw new Error(`Transaction log failed: ${txRes.statusText}`);
          log('‚úÖ Audit log created.');

          document.getElementById('status').textContent = '‚úÖ ROLLBACK COMPLETE';
          document.getElementById('status').style.color = '#0f0';
        } catch (e) {
          log(e.message, 'error');
          document.getElementById('status').textContent = '‚ùå FAILED';
          document.getElementById('status').style.color = '#f00';
        }
      }

      // Auto-run on load
      setTimeout(runRollback, 1000);
    </script>
  </body>
</html>
