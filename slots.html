<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé∞ Lucky Slots - Solana Tamagotchi</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a0033 0%, #330066 50%, #1a0033 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            color: white;
            overflow-x: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .container {
            max-width: 500px;
            width: 100%;
        }

        .slot-machine {
            background: linear-gradient(135deg, #2d1b4e 0%, #1a0f2e 100%);
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                        inset 0 0 50px rgba(138, 201, 38, 0.1);
            border: 3px solid #8AC926;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 32px;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin-bottom: 5px;
        }

        .header p {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
        }

        .balance-section {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .balance-item {
            text-align: center;
        }

        .balance-label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 5px;
        }

        .balance-value {
            font-size: 20px;
            font-weight: bold;
            color: #8AC926;
        }

        .slots-container {
            background: linear-gradient(135deg, #000 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 3px solid #FFD700;
        }

        .slots-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(255,215,0,0.2) 0%, transparent 70%);
            pointer-events: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .slots-display {
            display: flex;
            gap: 10px;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .slot-reel {
            width: 80px;
            height: 100px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            border: 2px solid #8AC926;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            position: relative;
            overflow: hidden;
        }

        .slot-reel.spinning {
            animation: spin 0.1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100px); }
        }

        .win-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #FFD700, transparent);
            transform: translateY(-50%);
            opacity: 0;
        }

        .win-line.active {
            opacity: 1;
            animation: glow 0.5s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px #FFD700; }
            50% { box-shadow: 0 0 20px #FFD700, 0 0 30px #FFD700; }
        }

        .result-message {
            text-align: center;
            margin: 15px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-text {
            font-size: 18px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 10px;
            display: inline-block;
        }

        .result-text.win {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            animation: bounce 0.5s ease-in-out;
        }

        .result-text.lose {
            background: rgba(255,0,0,0.2);
            color: #ff4444;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .bet-section {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .bet-label {
            text-align: center;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 10px;
        }

        .bet-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .bet-btn {
            background: linear-gradient(135deg, #8AC926, #6fa01f);
            border: none;
            padding: 12px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .bet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(138, 201, 38, 0.4);
        }

        .bet-btn.active {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .spin-button {
            width: 100%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            padding: 20px;
            border-radius: 15px;
            color: #000;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }

        .spin-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }

        .spin-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .free-spin-button {
            width: 100%;
            background: linear-gradient(135deg, #8AC926, #6fa01f);
            border: none;
            padding: 15px;
            border-radius: 15px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .paytable {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 15px;
        }

        .paytable-title {
            text-align: center;
            font-size: 16px;
            color: #FFD700;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .paytable-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 14px;
        }

        .paytable-symbols {
            display: flex;
            gap: 5px;
            font-size: 20px;
        }

        .paytable-payout {
            color: #8AC926;
            font-weight: bold;
        }

        .history-section {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-title {
            text-align: center;
            font-size: 16px;
            color: #FFD700;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 12px;
        }

        .history-win {
            color: #8AC926;
            font-weight: bold;
        }

        .history-lose {
            color: #ff4444;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.7);
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #8AC926;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin-loader 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin-loader {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Confetti animation for big wins */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #FFD700;
            position: absolute;
            animation: confetti-fall 3s linear;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="slot-machine">
            <!-- Header -->
            <div class="header">
                <h1>üé∞ LUCKY SLOTS üé∞</h1>
                <p>Win up to 100x your bet!</p>
            </div>

            <!-- Balance Section -->
            <div class="balance-section">
                <div class="balance-item">
                    <div class="balance-label">Balance</div>
                    <div class="balance-value" id="balance">0</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">Free Spins</div>
                    <div class="balance-value" id="free-spins">3</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">Total Won</div>
                    <div class="balance-value" id="total-won">0</div>
                </div>
            </div>

            <!-- Jackpot Pool Section -->
            <div class="balance-section" style="background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.2)); border: 2px solid #FFD700; margin-bottom: 20px;">
                <div class="balance-item" style="width: 100%; text-align: center;">
                    <div class="balance-label" style="color: #FFD700; font-size: 14px; font-weight: bold;">üé∞ JACKPOT POOL üé∞</div>
                    <div class="balance-value" id="jackpot-pool" style="color: #FFD700; font-size: 24px; text-shadow: 0 0 10px rgba(255,215,0,0.5);">Loading...</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 5px;">5% of each bet goes to the pool</div>
                </div>
            </div>

            <!-- Slots Display -->
            <div class="slots-container">
                <div class="slots-glow"></div>
                <div class="slots-display">
                    <div class="slot-reel" id="reel1">üçí</div>
                    <div class="slot-reel" id="reel2">üçã</div>
                    <div class="slot-reel" id="reel3">üçä</div>
                </div>
                <div class="win-line" id="win-line"></div>
            </div>

            <!-- Result Message -->
            <div class="result-message">
                <div class="result-text" id="result-text" style="display: none;"></div>
            </div>

            <!-- Bet Selection -->
            <div class="bet-section">
                <div class="bet-label">Select Bet Amount (TAMA):</div>
                <div class="bet-buttons">
                    <button class="bet-btn active" data-bet="100" onclick="selectBet(100)">
                        üí∞ 100
                    </button>
                    <button class="bet-btn" data-bet="500" onclick="selectBet(500)">
                        üíé 500
                    </button>
                    <button class="bet-btn" data-bet="2000" onclick="selectBet(2000)">
                        üëë 2,000
                    </button>
                </div>
            </div>

            <!-- Spin Buttons -->
            <button class="spin-button" id="spin-btn" onclick="spin()">
                üé∞ SPIN - <span id="spin-cost">100</span> TAMA
            </button>

            <button class="free-spin-button" id="free-spin-btn" onclick="freeSpin()" style="display: none;">
                üéÅ USE FREE SPIN
            </button>

            <!-- Paytable -->
            <div class="paytable">
                <div class="paytable-title">üí∞ Prize Table üí∞</div>
                <div class="paytable-row">
                    <div class="paytable-symbols">
                        <span>üçí</span><span>üçí</span><span>üçí</span>
                    </div>
                    <div class="paytable-payout">x2</div>
                </div>
                <div class="paytable-row">
                    <div class="paytable-symbols">
                        <span>üçã</span><span>üçã</span><span>üçã</span>
                    </div>
                    <div class="paytable-payout">x5</div>
                </div>
                <div class="paytable-row">
                    <div class="paytable-symbols">
                        <span>üçä</span><span>üçä</span><span>üçä</span>
                    </div>
                    <div class="paytable-payout">x8</div>
                </div>
                <div class="paytable-row">
                    <div class="paytable-symbols">
                        <span>üíé</span><span>üíé</span><span>üíé</span>
                    </div>
                    <div class="paytable-payout">x10</div>
                </div>
                <div class="paytable-row">
                    <div class="paytable-symbols">
                        <span>‚≠ê</span><span>‚≠ê</span><span>‚≠ê</span>
                    </div>
                    <div class="paytable-payout">x20</div>
                </div>
                <div class="paytable-row">
                    <div class="paytable-symbols">
                        <span>üëë</span><span>üëë</span><span>üëë</span>
                    </div>
                    <div class="paytable-payout">x50</div>
                </div>
                <div class="paytable-row">
                    <div class="paytable-symbols">
                        <span>üé∞</span><span>üé∞</span><span>üé∞</span>
                    </div>
                    <div class="paytable-payout">x100 üî•</div>
                </div>
            </div>

            <!-- History -->
            <div class="history-section">
                <div class="history-title">üìú Recent Spins</div>
                <div id="history-list">
                    <div class="loading">No spins yet</div>
                </div>
            </div>

            <!-- Provably Fair Button -->
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="showProvablyFair()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px; color: white; cursor: pointer; font-size: 14px;">
                    ‚úÖ Provably Fair - View Statistics
                </button>
            </div>
        </div>
    </div>

    <!-- Provably Fair Modal -->
    <div id="provably-fair-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto;" onclick="closeProvablyFair()">
        <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); margin: 20px auto; max-width: 600px; padding: 20px; border-radius: 15px; color: white;" onclick="event.stopPropagation()">
            <h2 style="text-align: center; color: #FFD700; margin-bottom: 20px;">‚úÖ Provably Fair System</h2>
            
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #8AC926; margin-bottom: 10px;">üé≤ How It Works:</h3>
                <p style="line-height: 1.6; font-size: 14px;">
                    Our slots use <strong>weighted random selection</strong> with fixed probabilities for each symbol. 
                    All spins are generated client-side and verified server-side. You can view your complete spin history and statistics below.
                </p>
            </div>

            <div style="background: rgba(255,215,0,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #FFD700; margin-bottom: 10px;">üìä Symbol Probabilities:</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                    <div>üçí Cherry: <strong>28%</strong></div>
                    <div>üçã Lemon: <strong>24%</strong></div>
                    <div>üçä Orange: <strong>19%</strong></div>
                    <div>üíé Diamond: <strong>12%</strong></div>
                    <div>‚≠ê Star: <strong>9%</strong></div>
                    <div>üëë Crown: <strong>5%</strong></div>
                    <div style="grid-column: 1 / -1; color: #FFD700;">üé∞ Jackpot: <strong>3%</strong> (increased for monthly wins!)</div>
                </div>
            </div>

            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #8AC926; margin-bottom: 10px;">üìà Your Statistics:</h3>
                <div id="user-stats" style="font-size: 14px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>Total Spins: <strong id="stat-spins">0</strong></div>
                        <div>Total Wagered: <strong id="stat-wagered">0</strong></div>
                        <div>Total Won: <strong id="stat-won">0</strong></div>
                        <div>Win Rate: <strong id="stat-winrate">0%</strong></div>
                        <div>Biggest Win: <strong id="stat-bigwin">0</strong></div>
                        <div>RTP: <strong id="stat-rtp">0%</strong></div>
                    </div>
                </div>
            </div>

            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #FFD700; margin-bottom: 10px;">üîç Recent Spins:</h3>
                <div id="recent-spins" style="max-height: 200px; overflow-y: auto; font-size: 12px;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <button onclick="closeProvablyFair()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #FFD700, #FFA500); border: none; border-radius: 10px; color: #000; font-weight: bold; cursor: pointer; font-size: 16px;">
                Close
            </button>
        </div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // Supabase
        const SUPABASE_URL = 'https://zfrazyupameidxpjihrh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcmF6eXVwYW1laWR4cGppaHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5Mzc1NTAsImV4cCI6MjA3NTUxMzU1MH0.1EkMDqCNJoAjcJDh3Dd3yPfus-JpdcwE--z2dhjh7wU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Get user ID from Telegram or URL - with proper initialization
        function getUserId() {
            // Method 1: Try Telegram WebApp initDataUnsafe (most reliable)
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user && user.id) {
                    console.log('‚úÖ Got user ID from Telegram WebApp:', user.id);
                    return String(user.id);
                }
            }

            // Method 2: Try parsing initData manually
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
                try {
                    const params = new URLSearchParams(window.Telegram.WebApp.initData);
                    const userParam = params.get('user');
                    if (userParam) {
                        const parsedUser = JSON.parse(decodeURIComponent(userParam));
                        if (parsedUser && parsedUser.id) {
                            console.log('‚úÖ Got user ID from initData:', parsedUser.id);
                            return String(parsedUser.id);
                        }
                    }
                } catch (e) {
                    console.warn('Failed to parse initData:', e);
                }
            }

            // Method 3: Try URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user_id') || urlParams.get('tg_id');
            if (urlUserId) {
                console.log('‚úÖ Got user ID from URL:', urlUserId);
                return String(urlUserId);
            }

            // Method 4: Try localStorage
            const storedUserId = localStorage.getItem('telegram_user_id');
            if (storedUserId) {
                console.log('‚úÖ Got user ID from localStorage:', storedUserId);
                return String(storedUserId);
            }

            console.warn('‚ö†Ô∏è No user ID found, using demo mode');
            return '123456789'; // Demo mode
        }

        let userId = null;

        // Symbols and multipliers
        const SYMBOLS = ['üçí', 'üçã', 'üçä', 'üíé', '‚≠ê', 'üëë', 'üé∞'];
        const MULTIPLIERS = {
            'üçí': 2,
            'üçã': 5,
            'üçä': 8,
            'üíé': 10,
            '‚≠ê': 20,
            'üëë': 50,
            'üé∞': 100  // x100 + Jackpot Pool!
        };

        // Game state
        let currentBet = 100;
        let isSpinning = false;
        let balance = 0;
        let freeSpins = 3;
        let totalWon = 0;
        let spinHistory = [];
        let jackpotPool = 0;
        
        // Sound system
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        let soundEnabled = true;
        
        // Initialize audio on first user interaction
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
                console.log('üîä Audio initialized');
            }
        }
        
        // Sound effects
        const sounds = {
            spin: () => {
                if (!audioCtx || !soundEnabled) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.08);
            },
            
            reelStop: () => {
                if (!audioCtx || !soundEnabled) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 150;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.05);
            },
            
            win: () => {
                if (!audioCtx || !soundEnabled) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.3);
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
            },
            
            bigWin: () => {
                if (!audioCtx || !soundEnabled) return;
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const oscillator = audioCtx.createOscillator();
                        const gainNode = audioCtx.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioCtx.destination);
                        oscillator.frequency.setValueAtTime(500 + (i * 150), audioCtx.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(800 + (i * 200), audioCtx.currentTime + 0.2);
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.18, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                        oscillator.start(audioCtx.currentTime);
                        oscillator.stop(audioCtx.currentTime + 0.2);
                    }, i * 100);
                }
            },
            
            jackpot: () => {
                if (!audioCtx || !soundEnabled) return;
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        const oscillator = audioCtx.createOscillator();
                        const gainNode = audioCtx.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioCtx.destination);
                        oscillator.frequency.value = 600 + (i * 150);
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                        oscillator.start(audioCtx.currentTime);
                        oscillator.stop(audioCtx.currentTime + 0.15);
                    }, i * 80);
                }
            },
            
            loss: () => {
                if (!audioCtx || !soundEnabled) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 0.3);
                oscillator.type = 'sawtooth';
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
            }
        };
        
        // Load history from localStorage
        function loadHistory() {
            try {
                const saved = localStorage.getItem(`slots_history_${userId}`);
                if (saved) {
                    const loaded = JSON.parse(saved);
                    // Ensure most recent is first (by timestamp)
                    spinHistory = loaded.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    // Keep only last 50
                    if (spinHistory.length > 50) {
                        spinHistory = spinHistory.slice(0, 50);
                    }
                    updateHistoryDisplay();
                }
            } catch (e) {
                console.error('Failed to load history:', e);
                spinHistory = [];
            }
        }
        
        // Save history to localStorage
        function saveHistory() {
            try {
                localStorage.setItem(`slots_history_${userId}`, JSON.stringify(spinHistory.slice(0, 50))); // Keep last 50
            } catch (e) {
                console.error('Failed to save history:', e);
            }
        }

        // API Base URL
        const API_BASE = 'https://api.solanatamagotchi.com/api/tama';

        // Load user balance and data
        async function loadUserData() {
            // Ensure userId is set
            if (!userId) {
                userId = getUserId();
                console.log('üîç Loading balance for user ID:', userId);
            }

            if (!userId || userId === '123456789') {
                console.warn('‚ö†Ô∏è Invalid user ID, cannot load balance');
                document.getElementById('balance').textContent = '0';
                return;
            }

            try {
                // Load TAMA balance from API
                console.log(`üì° Fetching balance from API: ${API_BASE}/balance?telegram_id=${userId}`);
                const response = await fetch(`${API_BASE}/balance?telegram_id=${userId}`);

                if (response.ok) {
                    const data = await response.json();
                    // API returns database_tama or total_tama
                    balance = data.total_tama || data.database_tama || data.balance || 0;
                    console.log('‚úÖ Balance loaded from API:', balance, 'Full response:', data);
                    
                    // If API returned 0, try direct Supabase as fallback
                    if (balance === 0) {
                        console.warn('‚ö†Ô∏è API returned 0, trying Supabase fallback...');
                        try {
                            const { data: leaderboardData, error } = await supabase
                                .from('leaderboard')
                                .select('tama')
                                .eq('telegram_id', userId)
                                .maybeSingle();
                            
                            if (!error && leaderboardData) {
                                balance = leaderboardData.tama || 0;
                                console.log('‚úÖ Balance loaded from Supabase fallback:', balance);
                            }
                        } catch (e) {
                            console.error('‚ùå Supabase fallback failed:', e);
                        }
                    }
                    
                    document.getElementById('balance').textContent = formatNumber(balance);
                    // Save userId to localStorage for future use
                    if (userId && userId !== '123456789') {
                        localStorage.setItem('telegram_user_id', userId);
                    }
                } else {
                    console.warn('‚ö†Ô∏è API request failed:', response.status, response.statusText);
                    // Try alternative: direct Supabase query
                    try {
                        console.log('üì° Trying Supabase direct query...');
                        const { data: leaderboardData, error } = await supabase
                            .from('leaderboard')
                            .select('tama')
                            .eq('telegram_id', userId)
                            .maybeSingle();
                        
                        if (!error && leaderboardData) {
                            balance = leaderboardData.tama || 0;
                            console.log('‚úÖ Balance loaded from Supabase:', balance);
                            document.getElementById('balance').textContent = formatNumber(balance);
                            // Save userId to localStorage for future use
                            if (userId && userId !== '123456789') {
                                localStorage.setItem('telegram_user_id', userId);
                            }
                        } else {
                            console.error('‚ùå Supabase query error:', error);
                            document.getElementById('balance').textContent = '0';
                        }
                    } catch (e) {
                        console.error('‚ùå Failed to load balance from Supabase:', e);
                        document.getElementById('balance').textContent = '0';
                    }
                }

                // Load free spins from localStorage (reset daily)
                const today = new Date().toDateString();
                const lastSpinDate = localStorage.getItem('last_spin_date');
                if (lastSpinDate !== today) {
                    freeSpins = 3;
                    localStorage.setItem('last_spin_date', today);
                    localStorage.setItem('free_spins', '3');
                } else {
                    freeSpins = parseInt(localStorage.getItem('free_spins') || '3');
                }
                document.getElementById('free-spins').textContent = freeSpins;

                // Load total won
                totalWon = parseInt(localStorage.getItem('total_won') || '0');
                document.getElementById('total-won').textContent = formatNumber(totalWon);

                updateFreeSpinButton();

                // Load jackpot pool
                await loadJackpotPool();
            } catch (error) {
                console.error('Failed to load user data:', error);
            }
        }

        // Select bet
        function selectBet(amount) {
            if (isSpinning) return;

            currentBet = amount;
            document.querySelectorAll('.bet-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.bet) === amount) {
                    btn.classList.add('active');
                }
            });
            document.getElementById('spin-cost').textContent = formatNumber(amount);
        }

        // Spin the slots
        async function spin() {
            if (isSpinning) return;
            if (balance < currentBet) {
                showResult('‚ùå Insufficient balance!', false);
                return;
            }
            
            // Initialize audio on first interaction
            initAudio();

            isSpinning = true;
            document.getElementById('spin-btn').disabled = true;
            hideResult();

            // Deduct bet from balance
            balance -= currentBet;
            document.getElementById('balance').textContent = formatNumber(balance);

            // Update balance in backend (deduct bet)
            await updateBalance(-currentBet, []);

            // Play spin sound
            sounds.spin();

            // Spin animation
            await playSpinAnimation();

            // Determine result
            const result = getSpinResult();

            // Check win
            const isWin = result[0] === result[1] && result[1] === result[2];
            let winAmount = 0;
            const isJackpot = isWin && result[0] === 'üé∞';

            if (isWin) {
                const multiplier = MULTIPLIERS[result[0]];
                winAmount = currentBet * multiplier;

                // Update balance in backend with symbols (for jackpot detection)
                const apiResponse = await updateBalance(winAmount, result);

                // If jackpot was won, API already added it to balance
                if (isJackpot && apiResponse && apiResponse.jackpot && apiResponse.jackpot.jackpot_win > 0) {
                    winAmount += apiResponse.jackpot.jackpot_win;
                }

                balance += winAmount;
                totalWon += winAmount;

                document.getElementById('balance').textContent = formatNumber(balance);
                document.getElementById('total-won').textContent = formatNumber(totalWon);
                localStorage.setItem('total_won', totalWon.toString());

                // Play win sound based on multiplier
                if (isJackpot) {
                    sounds.jackpot();
                } else if (multiplier >= 20) {
                    sounds.bigWin();
                } else {
                    sounds.win();
                }

                // Show win (only if not jackpot, jackpot message already shown)
                if (!isJackpot || !apiResponse?.jackpot?.is_jackpot) {
                    document.getElementById('win-line').classList.add('active');
                    showResult(`üéâ YOU WON ${formatNumber(winAmount)} TAMA! (x${multiplier})`, true);
                }

                if (multiplier >= 20) {
                    createConfetti();
                }

                setTimeout(() => {
                    document.getElementById('win-line').classList.remove('active');
                }, 2000);
            } else {
                showResult('Try again! üé∞', false);
            }

            // Add to history
            addToHistory(result, winAmount, currentBet);

            isSpinning = false;
            document.getElementById('spin-btn').disabled = false;
        }

        // Free spin
        async function freeSpin() {
            if (isSpinning || freeSpins <= 0) return;

            freeSpins--;
            document.getElementById('free-spins').textContent = freeSpins;
            localStorage.setItem('free_spins', freeSpins.toString());
            updateFreeSpinButton();

            isSpinning = true;
            document.getElementById('free-spin-btn').disabled = true;
            hideResult();

            // Spin animation
            await playSpinAnimation();

            // Determine result
            const result = getSpinResult();

            // Check win
            const isWin = result[0] === result[1] && result[1] === result[2];
            let winAmount = 0;

            if (isWin) {
                const multiplier = MULTIPLIERS[result[0]];
                winAmount = 100 * multiplier; // Free spins use 100 TAMA bet
                const isFreeJackpot = result[0] === 'üé∞';

                // Update balance in backend with symbols (for jackpot detection)
                const apiResponse = await updateBalance(winAmount, result);

                // If jackpot was won, API already added it to balance
                if (isFreeJackpot && apiResponse && apiResponse.jackpot && apiResponse.jackpot.jackpot_win > 0) {
                    winAmount += apiResponse.jackpot.jackpot_win;
                }

                balance += winAmount;
                totalWon += winAmount;

                document.getElementById('balance').textContent = formatNumber(balance);
                document.getElementById('total-won').textContent = formatNumber(totalWon);
                localStorage.setItem('total_won', totalWon.toString());

                // Show win (only if not jackpot, jackpot message already shown)
                if (!isFreeJackpot || !apiResponse?.jackpot?.is_jackpot) {
                    document.getElementById('win-line').classList.add('active');
                    showResult(`üéÅ FREE SPIN WIN: ${formatNumber(winAmount)} TAMA! (x${multiplier})`, true);
                }

                if (multiplier >= 20) {
                    createConfetti();
                }

                setTimeout(() => {
                    document.getElementById('win-line').classList.remove('active');
                }, 2000);
            } else {
                showResult('Free spin - Try again! üéÅ', false);
            }

            // Add to history
            addToHistory(result, winAmount, 0);

            isSpinning = false;
            document.getElementById('free-spin-btn').disabled = false;
        }

        // Play spin animation
        function playSpinAnimation() {
            return new Promise(resolve => {
                const reels = ['reel1', 'reel2', 'reel3'];

                // Start spinning
                reels.forEach(reelId => {
                    const reel = document.getElementById(reelId);
                    reel.classList.add('spinning');
                });

                // Stop reels one by one
                setTimeout(() => {
                    document.getElementById('reel1').classList.remove('spinning');
                }, 1000);

                setTimeout(() => {
                    document.getElementById('reel2').classList.remove('spinning');
                }, 1500);

                setTimeout(() => {
                    document.getElementById('reel3').classList.remove('spinning');
                    resolve();
                }, 2000);
            });
        }

        // Get spin result
        function getSpinResult() {
            // Weighted random selection (optimized for better jackpot chances)
            const weights = {
                'üçí': 28,  // 28% chance
                'üçã': 24,  // 24% chance
                'üçä': 19,  // 19% chance
                'üíé': 12,  // 12% chance
                '‚≠ê': 9,   // 9% chance
                'üëë': 5,   // 5% chance
                'üé∞': 3    // 3% chance (JACKPOT!) - increased from 1% for ~monthly jackpots
            };

            const result = [];
            for (let i = 0; i < 3; i++) {
                const symbol = weightedRandom(weights);
                result.push(symbol);
                document.getElementById(`reel${i + 1}`).textContent = symbol;
            }

            return result;
        }

        // Weighted random
        function weightedRandom(weights) {
            const total = Object.values(weights).reduce((a, b) => a + b, 0);
            let random = Math.random() * total;

            for (const [symbol, weight] of Object.entries(weights)) {
                random -= weight;
                if (random <= 0) return symbol;
            }

            return 'üçí'; // Fallback
        }

        // Load jackpot pool
        async function loadJackpotPool() {
            try {
                const { data, error } = await supabase
                    .from('slots_jackpot_pool')
                    .select('current_pool')
                    .eq('id', 1)
                    .maybeSingle();

                if (!error && data) {
                    jackpotPool = data.current_pool || 0;
                    document.getElementById('jackpot-pool').textContent = formatNumber(jackpotPool) + ' TAMA';
                } else {
                    console.warn('Failed to load jackpot pool:', error);
                    document.getElementById('jackpot-pool').textContent = '0 TAMA';
                }
            } catch (e) {
                console.error('Error loading jackpot pool:', e);
                document.getElementById('jackpot-pool').textContent = '0 TAMA';
            }
        }

        // Update balance in backend
        async function updateBalance(amount, symbols = []) {
            // Ensure userId is set
            if (!userId) {
                userId = getUserId();
            }

            if (!userId || userId === '123456789') {
                console.warn('‚ö†Ô∏è Cannot update balance: invalid user ID');
                return null;
            }

            try {
                console.log(`üì° Updating balance: ${amount} for user ${userId}`, symbols);
                const response = await fetch(`${API_BASE}/slots/spin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_id: String(userId),
                        amount: amount,
                        bet: amount < 0 ? Math.abs(amount) : 0,
                        win: amount > 0 ? amount : 0,
                        symbols: symbols
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.balance !== undefined) {
                        balance = data.balance;
                        document.getElementById('balance').textContent = formatNumber(balance);
                    }

                    // Update jackpot pool
                    if (data.jackpot) {
                        jackpotPool = data.jackpot.current_pool || 0;
                        document.getElementById('jackpot-pool').textContent = formatNumber(jackpotPool) + ' TAMA';

                        // If jackpot won, show special message
                        if (data.jackpot.is_jackpot && data.jackpot.jackpot_win > 0) {
                            const jackpotWin = data.jackpot.jackpot_win;
                            showResult(`üé∞üé∞üé∞ JACKPOT!!! +${formatNumber(jackpotWin)} TAMA! üé∞üé∞üé∞`, true);
                            createConfetti();
                            // Reload pool after a delay
                            setTimeout(loadJackpotPool, 2000);
                        }
                    }

                    return data;
                } else {
                    console.error('Failed to update balance via API:', response.status);
                    // Fallback: update via Supabase directly
                    try {
                        console.log('üì° Fallback: updating balance via Supabase');
                        const { data: leaderboardData } = await supabase
                            .from('leaderboard')
                            .select('tama')
                            .eq('telegram_id', String(userId))
                            .maybeSingle();

                        if (leaderboardData) {
                            const currentBalance = leaderboardData.tama || 0;
                            const newBalance = currentBalance + amount;

                            await supabase
                                .from('leaderboard')
                                .update({ tama: newBalance })
                                .eq('telegram_id', String(userId));

                            balance = newBalance;
                            document.getElementById('balance').textContent = formatNumber(balance);

                            // Log transaction
                            await supabase.from('transactions').insert({
                                telegram_id: String(userId),
                                amount: amount,
                                type: amount > 0 ? 'slots_win' : 'slots_spin',
                                balance_before: currentBalance,
                                balance_after: newBalance,
                                metadata: JSON.stringify({ source: 'slots.html', fallback: true })
                            });
                        }
                    } catch (e) {
                        console.error('Failed to update balance via Supabase:', e);
                    }
                }
            } catch (error) {
                console.error('Failed to update balance:', error);
            }
        }

        // Show result
        function showResult(message, isWin) {
            const resultEl = document.getElementById('result-text');
            resultEl.textContent = message;
            resultEl.className = `result-text ${isWin ? 'win' : 'lose'}`;
            resultEl.style.display = 'inline-block';
        }

        // Hide result
        function hideResult() {
            document.getElementById('result-text').style.display = 'none';
        }

        // Update history display
        function updateHistoryDisplay() {
            const historyList = document.getElementById('history-list');
            if (!historyList) return;
            
            if (spinHistory.length === 0) {
                historyList.innerHTML = '<div class="loading">No spins yet</div>';
                return;
            }

            // Show most recent first (already in correct order after unshift)
            historyList.innerHTML = spinHistory.slice(0, 10).map(item => {
                const symbols = item.symbols || item.result?.split(' ') || ['?', '?', '?'];
                const symbolsText = symbols.join(' ');
                const winAmount = item.win || 0;
                const betAmount = item.bet || 0;
                const isWin = winAmount > 0;
                
                return `
                    <div class="history-item">
                        <div>${symbolsText}</div>
                        <div class="${isWin ? 'history-win' : 'history-lose'}">
                            ${isWin ? '+' : '-'}${formatNumber(isWin ? winAmount : betAmount)} TAMA
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add to history
        function addToHistory(result, winAmount, betAmount) {
            const historyItem = {
                result: result.join(' '),
                symbols: result,
                win: winAmount,
                bet: betAmount,
                multiplier: winAmount > 0 && betAmount > 0 ? Math.floor(winAmount / betAmount) : 0,
                time: new Date().toLocaleTimeString(),
                timestamp: Date.now()
            };

            // Add to beginning (most recent first)
            spinHistory.unshift(historyItem);
            
            // Keep only last 50 spins
            if (spinHistory.length > 50) {
                spinHistory = spinHistory.slice(0, 50);
            }
            
            // Save to localStorage
            saveHistory();

            // Update display immediately
            updateHistoryDisplay();
        }

        // Update free spin button visibility
        function updateFreeSpinButton() {
            const freeSpinBtn = document.getElementById('free-spin-btn');
            if (freeSpins > 0) {
                freeSpinBtn.style.display = 'block';
                freeSpinBtn.textContent = `üéÅ USE FREE SPIN (${freeSpins} left)`;
            } else {
                freeSpinBtn.style.display = 'none';
            }
        }

        // Create confetti
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = ['#FFD700', '#FFA500', '#FF6347', '#8AC926'][Math.floor(Math.random() * 4)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        // Format number
        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(Math.floor(num));
        }

        // Initialize - wait for Telegram Web App to be ready
        function initialize() {
            // Wait a bit for Telegram Web App to initialize
            if (window.Telegram && window.Telegram.WebApp) {
                // Telegram Web App is available, get user ID
                userId = getUserId();
                console.log('üöÄ Initializing with user ID:', userId);

                // Load user data and history
                loadUserData();
                loadHistory();
                loadJackpotPool();
            } else {
                // Wait for Telegram Web App to load
                let attempts = 0;
                const maxAttempts = 10;
                const checkTelegram = setInterval(() => {
                    attempts++;
                    if (window.Telegram && window.Telegram.WebApp) {
                        clearInterval(checkTelegram);
                        userId = getUserId();
                        console.log('üöÄ Telegram Web App ready, user ID:', userId);
                        loadUserData();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkTelegram);
                        // Fallback: try to get user ID anyway
                        userId = getUserId();
                        console.log('‚ö†Ô∏è Telegram Web App not available, using fallback, user ID:', userId);
                        loadUserData();
                    }
                }, 100);
            }
        }

        // Provably Fair functions
        function showProvablyFair() {
            document.getElementById('provably-fair-modal').style.display = 'block';
            calculateUserStats();
            displayRecentSpins();
        }

        function closeProvablyFair() {
            document.getElementById('provably-fair-modal').style.display = 'none';
        }

        function calculateUserStats() {
            if (spinHistory.length === 0) {
                document.getElementById('stat-spins').textContent = '0';
                document.getElementById('stat-wagered').textContent = '0';
                document.getElementById('stat-won').textContent = '0';
                document.getElementById('stat-winrate').textContent = '0%';
                document.getElementById('stat-bigwin').textContent = '0';
                document.getElementById('stat-rtp').textContent = '0%';
                return;
            }

            const totalSpins = spinHistory.length;
            const totalWagered = spinHistory.reduce((sum, spin) => sum + (spin.bet || 0), 0);
            const totalWon = spinHistory.reduce((sum, spin) => sum + (spin.win || 0), 0);
            const wins = spinHistory.filter(spin => spin.win > 0).length;
            const winRate = ((wins / totalSpins) * 100).toFixed(1);
            const biggestWin = Math.max(...spinHistory.map(spin => spin.win || 0));
            const rtp = totalWagered > 0 ? ((totalWon / totalWagered) * 100).toFixed(1) : 0;

            document.getElementById('stat-spins').textContent = totalSpins.toLocaleString();
            document.getElementById('stat-wagered').textContent = totalWagered.toLocaleString();
            document.getElementById('stat-won').textContent = totalWon.toLocaleString();
            document.getElementById('stat-winrate').textContent = winRate + '%';
            document.getElementById('stat-bigwin').textContent = biggestWin.toLocaleString();
            document.getElementById('stat-rtp').textContent = rtp + '%';
        }

        function displayRecentSpins() {
            const container = document.getElementById('recent-spins');
            container.innerHTML = '';

            const recent = spinHistory.slice(0, 10);
            if (recent.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.5);">No spins yet</div>';
                return;
            }

            for (const spin of recent) {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 8px; margin-bottom: 5px; background: rgba(255,255,255,0.05); border-radius: 5px; display: flex; justify-content: space-between;';
                
                const symbols = spin.symbols || spin.result?.split(' ') || ['?', '?', '?'];
                const symbolsText = symbols.join(' ');
                const winText = spin.win > 0 ? `+${spin.win.toLocaleString()}` : '0';
                const color = spin.win > 0 ? '#8AC926' : '#ff6b6b';
                
                div.innerHTML = `
                    <span>${symbolsText}</span>
                    <span>Bet: ${(spin.bet || 0).toLocaleString()}</span>
                    <span style="color: ${color}; font-weight: bold;">${winText}</span>
                `;
                container.appendChild(div);
            }
        }

        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            // DOM already loaded
            setTimeout(initialize, 100);
        }
    </script>
</body>
</html>

