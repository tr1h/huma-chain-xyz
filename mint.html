<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L7LVQM50LV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-L7LVQM50LV');
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>Mint NFT Tamagotchi Pets on Solana | Earn 2-5x TAMA Boost | Solana Tamagotchi</title>
    <meta name="title" content="Mint NFT Tamagotchi Pets on Solana | Earn 2-5x TAMA Boost">
    <meta name="description" content="Mint unique NFT Tamagotchi pets on Solana blockchain! Earn 2-5x TAMA boost, passive income 50-10,000 TAMA/day. 5 tiers: Bronze (5000 TAMA), Silver (1 SOL), Gold (3 SOL), Platinum (10 SOL), Diamond (50 SOL). Limited supply, bonding curve pricing. Real on-chain NFTs.">
    <meta name="keywords" content="mint nft, solana nft mint, tamagotchi nft, buy nft pet, nft minting, solana nft, tama token, nft boost, crypto nft, blockchain pets, solana blockchain, nft collection, play to earn, p2e, nft gaming, solana devnet, phantom wallet, metaplex nft">
    <meta name="author" content="Solana Tamagotchi">
    <meta name="publisher" content="Solana Tamagotchi">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    <meta name="rating" content="general">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://solanatamagotchi.com/mint">
    
    <!-- Favicon - Google prefers .ico format -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/logo.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/logo.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/logo.png">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="theme-color" content="#1D3557">
    <meta name="msapplication-TileColor" content="#1D3557">
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://api.solanatamagotchi.com">
    <link rel="dns-prefetch" href="https://api.devnet.solana.com">
    <link rel="dns-prefetch" href="https://zfrazyupameidxpjihrh.supabase.co">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Solana Tamagotchi">
    <meta property="og:url" content="https://solanatamagotchi.com/mint">
    <meta property="og:title" content="Mint NFT Tamagotchi Pets | Earn 2-5x TAMA Boost on Solana">
    <meta property="og:description" content="Mint unique NFT Tamagotchi pets on Solana! Earn passive income 50-10,000 TAMA/day and 2-5x boost multiplier. 5 tiers available. Limited supply with bonding curve pricing. Real on-chain NFTs.">
    <meta property="og:image" content="https://solanatamagotchi.com/nft-preview.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Solana Tamagotchi NFT Collection - Mint Your Pet">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@solanatamagotchi">
    <meta name="twitter:creator" content="@solanatamagotchi">
    <meta name="twitter:url" content="https://solanatamagotchi.com/mint">
    <meta name="twitter:title" content="Mint NFT Tamagotchi Pets | Earn 2-5x TAMA Boost">
    <meta name="twitter:description" content="Mint unique NFT pets on Solana! Earn passive income and boost your TAMA earnings. 5 tiers available. Limited supply.">
    <meta name="twitter:image" content="https://solanatamagotchi.com/nft-preview.png">
    <meta name="twitter:image:alt" content="Solana Tamagotchi NFT Collection">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="geo.region" content="US">
    <meta name="geo.placename" content="Global">
    <meta name="application-name" content="Solana Tamagotchi">
    <meta name="apple-mobile-web-app-title" content="Tamagotchi NFT">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Structured Data - JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "Mint NFT Tamagotchi Pets on Solana",
        "description": "Mint unique NFT Tamagotchi pets on Solana blockchain. Earn 2-5x TAMA boost and passive income. 5 tiers available with limited supply.",
        "url": "https://solanatamagotchi.com/mint.html",
        "inLanguage": "en-US",
        "isPartOf": {
            "@type": "WebSite",
            "name": "Solana Tamagotchi",
            "url": "https://solanatamagotchi.com"
        },
        "breadcrumb": {
            "@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "Home",
                    "item": "https://solanatamagotchi.com"
                },
                {
                    "@type": "ListItem",
                    "position": 2,
                    "name": "Mint NFT",
                    "item": "https://solanatamagotchi.com/mint.html"
                }
            ]
        },
        "mainEntity": {
            "@type": "Product",
            "name": "Solana Tamagotchi NFT Collection",
            "description": "Unique NFT Tamagotchi pets on Solana blockchain with earning multipliers and passive income",
            "brand": {
                "@type": "Brand",
                "name": "Solana Tamagotchi"
            },
            "offers": {
                "@type": "AggregateOffer",
                "offerCount": "5",
                "lowPrice": "0.15",
                "highPrice": "50",
                "priceCurrency": "SOL",
                "availability": "https://schema.org/InStock",
                "itemCondition": "https://schema.org/NewCondition"
            },
            "category": "NFT",
            "additionalProperty": [
                {
                    "@type": "PropertyValue",
                    "name": "Blockchain",
                    "value": "Solana"
                },
                {
                    "@type": "PropertyValue",
                    "name": "Network",
                    "value": "Devnet"
                },
                {
                    "@type": "PropertyValue",
                    "name": "Total Supply",
                    "value": "5000"
                },
                {
                    "@type": "PropertyValue",
                    "name": "Earning Boost",
                    "value": "2x-5x"
                }
            ]
        }
    }
    </script>
    
    <!-- NFT Collection Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "CollectionPage",
        "name": "Solana Tamagotchi NFT Collection",
        "description": "Collection of 5000 unique NFT Tamagotchi pets on Solana blockchain",
        "url": "https://solanatamagotchi.com/mint.html",
        "mainEntity": {
            "@type": "ItemList",
            "numberOfItems": "5000",
            "itemListElement": [
                {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "Bronze NFT",
                    "description": "Common tier NFT - 4500 available, 5000 TAMA or 0.15 SOL, 2x earning boost"
                },
                {
                    "@type": "ListItem",
                    "position": 2,
                    "name": "Silver NFT",
                    "description": "Uncommon tier NFT - 350 available, 1 SOL, 2.3x earning boost"
                },
                {
                    "@type": "ListItem",
                    "position": 3,
                    "name": "Gold NFT",
                    "description": "Rare tier NFT - 130 available, 3 SOL, 2.7x earning boost"
                },
                {
                    "@type": "ListItem",
                    "position": 4,
                    "name": "Platinum NFT",
                    "description": "Epic tier NFT - 18 available, 10 SOL, 3.5x earning boost"
                },
                {
                    "@type": "ListItem",
                    "position": 5,
                    "name": "Diamond NFT",
                    "description": "Legendary tier NFT - 2 available, 50 SOL, 5x earning boost"
                }
            ]
        }
    }
    </script>
    
    <!-- Organization Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Solana Tamagotchi",
        "url": "https://solanatamagotchi.com",
        "logo": "https://solanatamagotchi.com/logo.png",
        "sameAs": [
            "https://twitter.com/solanatamagotchi",
            "https://t.me/solanatamagotchi"
        ],
        "description": "Play-to-earn Tamagotchi game on Solana blockchain with NFT pets and TAMA token rewards"
    }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* LOGO - LEFT SIDE */
        .game-logo {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 10000;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .game-logo:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .game-logo img {
            height: 70px;
            width: auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 5px;
        }

        @media (max-width: 768px) {
            .game-logo {
                top: 10px;
                left: 10px;
            }

            .game-logo img {
                height: 50px;
            }
        }
        
        /* HEADER - EPIC STYLE */
        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease;
        }
        .header h1 {
            font-size: 32px;
            background: linear-gradient(135deg, #FFD700, #FF6B35, #8AC926);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        .header .subtitle {
            font-size: 12px;
            color: #8AC926;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        /* WALLET SECTION */
        .wallet-section {
            background: rgba(138, 201, 38, 0.1);
            border: 2px solid rgba(138, 201, 38, 0.3);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .wallet-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .wallet-info div {
            font-size: 10px;
            color: #8AC926;
        }
        .btn-connect {
            padding: 12px 24px;
            background: linear-gradient(135deg, #8AC926, #FFD700);
            border: none;
            border-radius: 10px;
            color: #1d3557;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(138, 201, 38, 0.6);
        }
        
        .btn-my-nfts {
            padding: 12px 24px;
            background: linear-gradient(135deg, #9C27B0, #E91E63);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-my-nfts:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.6);
        }
        
        .btn-faucet {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 2px solid #FFD700;
            border-radius: 10px;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
            animation: pulse-glow 2s infinite;
        }
        .btn-faucet:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.6), 0 0 30px rgba(255, 215, 0, 0.4);
            border-color: #FFA500;
        }
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
        }
        
        /* COLLECTION STATS */
        .collection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            animation: fadeIn 1s ease;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(29, 53, 87, 0.8), rgba(69, 123, 157, 0.4));
            border: 2px solid rgba(138, 201, 38, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #8AC926;
            box-shadow: 0 10px 30px rgba(138, 201, 38, 0.4);
        }
        
        .stat-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 24px;
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 10px;
            color: #8AC926;
            text-transform: uppercase;
            opacity: 0.9;
        }
        
        /* RECENT MINTS SECTION */
        .recent-mints-section {
            background: linear-gradient(135deg, rgba(29, 53, 87, 0.6), rgba(69, 123, 157, 0.3));
            border: 2px solid rgba(138, 201, 38, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            animation: fadeIn 1s ease;
        }
        
        .sidebar-title {
            font-size: 14px;
            color: #FFD700;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(138, 201, 38, 0.3);
        }
        
        .recent-mints-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            min-height: 400px; /* –ú–∏–Ω–∏–º—É–º 2 —Å—Ç—Ä–æ–∫–∏ */
            max-height: 600px; /* –ú–∞–∫—Å–∏–º—É–º 3-4 —Å—Ç—Ä–æ–∫–∏ */
            overflow-y: auto;
            padding-right: 10px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        .recent-mints-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .recent-mints-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        .recent-mints-list::-webkit-scrollbar-thumb {
            background: rgba(138, 201, 38, 0.5);
            border-radius: 3px;
        }
        
        .recent-mints-list::-webkit-scrollbar-thumb:hover {
            background: rgba(138, 201, 38, 0.7);
        }
        
        .mint-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(138, 201, 38, 0.2);
            border-radius: 10px;
            padding: 15px;
            animation: fadeInUp 0.5s ease;
            transition: all 0.3s;
        }
        
        .mint-item:hover {
            transform: translateY(-5px);
            border-color: #8AC926;
            box-shadow: 0 10px 30px rgba(138, 201, 38, 0.3);
            background: rgba(138, 201, 38, 0.1);
        }
        
        .mint-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .mint-tier-badge {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .mint-tier-badge.bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); }
        .mint-tier-badge.silver { background: linear-gradient(135deg, #C0C0C0, #808080); }
        .mint-tier-badge.gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .mint-tier-badge.platinum { background: linear-gradient(135deg, #E5E4E2, #00CED1); }
        .mint-tier-badge.diamond { background: linear-gradient(135deg, #B9F2FF, #00A8CC); }
        
        .mint-time {
            font-size: 8px;
            color: #999;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .mint-explorer-link {
            color: #8AC926 !important;
            text-decoration: none;
            font-size: 12px !important;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .mint-explorer-link:hover {
            opacity: 1;
            text-decoration: none;
        }
        
        .mint-user {
            font-size: 10px;
            color: #8AC926;
            margin-bottom: 5px;
        }
        
        .mint-details {
            font-size: 9px;
            color: #ccc;
            display: flex;
            justify-content: space-between;
        }
        
        .sidebar-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(138, 201, 38, 0.3);
            text-align: center;
            font-size: 9px;
            color: #8AC926;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .pulse-dot {
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .loading-mints {
            grid-column: 1 / -1;
            text-align: center;
            color: #999;
            font-size: 10px;
            padding: 20px;
        }
        
        /* FAQ SECTION */
        .faq-section {
            background: linear-gradient(135deg, rgba(29, 53, 87, 0.6), rgba(69, 123, 157, 0.3));
            border: 2px solid rgba(138, 201, 38, 0.3);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            animation: fadeIn 1s ease;
        }
        
        .faq-title {
            font-size: 20px;
            color: #FFD700;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .faq-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
        }
        
        .faq-item {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(138, 201, 38, 0.2);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .faq-item:hover {
            border-color: #8AC926;
        }
        
        .faq-question {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #FFD700;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .faq-question:hover {
            background: rgba(138, 201, 38, 0.1);
        }
        
        .faq-toggle {
            font-size: 24px;
            color: #8AC926;
            transition: transform 0.3s;
        }
        
        .faq-item.active .faq-toggle {
            transform: rotate(45deg);
        }
        
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            padding: 0 20px;
            font-size: 10px;
            color: #ccc;
            line-height: 1.8;
            font-family: Arial, sans-serif;
            transition: all 0.4s ease;
        }
        
        .faq-item.active .faq-answer {
            max-height: 500px;
            padding: 0 20px 20px 20px;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* NFT BENEFITS SECTION */
        .nft-benefits-section {
            background: linear-gradient(135deg, rgba(138, 201, 38, 0.05), rgba(255, 215, 0, 0.05));
            border: 2px solid rgba(138, 201, 38, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            animation: fadeIn 1s ease;
        }
        
        .benefits-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .benefits-header h2 {
            font-size: 20px;
            color: #FFD700;
            margin-bottom: 15px;
        }
        
        .benefits-subtitle {
            font-size: 11px;
            color: #8AC926;
            opacity: 0.9;
            font-family: Arial, sans-serif;
        }
        
        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .benefit-card {
            background: rgba(29, 53, 87, 0.5);
            border: 2px solid rgba(138, 201, 38, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .benefit-card:hover {
            transform: translateY(-5px);
            border-color: #8AC926;
            box-shadow: 0 10px 30px rgba(138, 201, 38, 0.3);
        }
        
        .benefit-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .benefit-title {
            font-size: 12px;
            color: #FFD700;
            margin-bottom: 10px;
        }
        
        .benefit-description {
            font-size: 9px;
            color: #ccc;
            margin-bottom: 15px;
            font-family: Arial, sans-serif;
            line-height: 1.5;
        }
        
        .benefit-amount {
            font-size: 11px;
            color: #8AC926;
            font-weight: bold;
        }
        
        /* EARNINGS CALCULATOR */
        .earnings-calculator {
            background: rgba(29, 53, 87, 0.7);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
        }
        
        .earnings-calculator h3 {
            text-align: center;
            font-size: 16px;
            color: #FFD700;
            margin-bottom: 25px;
        }
        
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .calc-tier {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(138, 201, 38, 0.3);
            border-radius: 10px;
            padding: 15px;
        }
        
        .calc-tier-name {
            font-size: 12px;
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(138, 201, 38, 0.3);
        }
        
        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 9px;
            color: #ccc;
        }
        
        .calc-row strong {
            color: #fff;
            font-size: 10px;
        }
        
        .calc-row .highlight {
            color: #8AC926;
        }
        
        .calc-row .success {
            color: #4CAF50;
        }
        
        .calc-note {
            text-align: center;
            font-size: 8px;
            color: #999;
            margin-top: 15px;
            font-family: Arial, sans-serif;
            font-style: italic;
        }
        
        /* TIER GRID - EPIC CARDS */
        .tier-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }
        .tier-card {
            background: linear-gradient(135deg, rgba(138, 201, 38, 0.05), rgba(29, 53, 87, 0.1));
            backdrop-filter: blur(20px);
            border: 3px solid;
            border-radius: 20px;
            padding: 25px 20px;
            width: 260px;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.4s;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        .tier-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 60px rgba(138, 201, 38, 0.4);
        }
        .tier-card.bronze { border-color: #CD7F32; }
        .tier-card.silver { border-color: #C0C0C0; }
        .tier-card.gold { border-color: #FFD700; }
        .tier-card.platinum { border-color: #E5E4E2; }
        .tier-card.diamond { border-color: #B9F2FF; }
        
        .fomo-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #FF006E, #FF4500);
            color: white;
            font-size: 9px;
            padding: 6px 10px;
            border-radius: 15px;
            animation: pulse 2s infinite;
            z-index: 10;
        }
        .tier-icon {
            font-size: 50px;
            text-align: center;
            margin: 10px 0;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.5));
        }
        .tier-name {
            font-size: 16px;
            text-align: center;
            margin: 8px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            line-height: 1.4;
            word-wrap: break-word;
            min-height: 2.8em;
        }
        .tier-supply {
            font-size: 9px;
            text-align: center;
            opacity: 0.8;
            margin-bottom: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            min-height: 2.8em;
        }
        .tier-price {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            padding: 15px;
            margin: 4px 0 15px 0;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: left;
        }
        .tier-price .main-price {
            font-size: 22px;
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 8px;
            white-space: nowrap;
        }
        .tier-price .usd-price {
            font-size: 13px;
            opacity: 0.85;
            margin-bottom: 6px;
        }
        .tier-price .next-price {
            font-size: 10px;
            opacity: 0.75;
        }
        .tier-boost {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-size: 11px;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }
        .passive-income {
            font-size: 11px;
            color: #8AC926;
            margin-bottom: 15px;
            text-align: left;
        }
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        /* Tier-specific progress bar gradients */
        .progress-fill.bronze {
            background: linear-gradient(90deg, #CD7F32, #FFB703);
        }
        .progress-fill.silver {
            background: linear-gradient(90deg, #C0C0C0, #E5E5E5);
        }
        .progress-fill.gold {
            background: linear-gradient(90deg, #FFD700, #FFED4E);
        }
        .progress-fill.platinum {
            background: linear-gradient(90deg, #E5E4E2, #FFFFFF);
        }
        .progress-fill.diamond {
            background: linear-gradient(90deg, #B9F2FF, #00D9FF);
        }
        .tier-minted-count {
            font-size: 10px;
            text-align: center;
            opacity: 0.8;
            margin-bottom: 15px;
        }
        .mint-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #8AC926, #FFD700);
            border: none;
            border-radius: 10px;
            color: #1d3557;
            font-family: 'Press Start 2P', cursive;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: auto;
        }
        .mint-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(138, 201, 38, 0.6);
        }
        .bronze-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: auto;
        }
        .bronze-btn {
            padding: 12px;
            background: linear-gradient(135deg, #8AC926, #FFD700);
            border: none;
            border-radius: 10px;
            color: #1d3557;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
        }
        .bronze-btn.sol {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Custom Confirmation Modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }
        .confirm-modal.hidden {
            display: none;
        }
        .confirm-modal-content {
            background: linear-gradient(135deg, #1D3557, #457B9D);
            border: 4px solid #FFCA3A;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #FFCA3A;
            color: #FFCA3A;
            font-size: 24px;
            font-weight: bold;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            line-height: 1;
            padding: 0;
        }
        .modal-close-btn:hover {
            background: #FFCA3A;
            color: #1D3557;
            transform: rotate(90deg);
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .confirm-modal-content h3 {
            font-size: 18px;
            color: #FFCA3A;
            margin: 0 0 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .confirm-modal-content p {
            font-size: 14px;
            color: #F1FAEE;
            margin: 0 0 30px 0;
            line-height: 1.6;
            white-space: pre-line;
        }
        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .confirm-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .confirm-ok {
            background: linear-gradient(135deg, #8AC926, #FFD700);
            color: #1d3557;
        }
        .confirm-ok:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(138, 201, 38, 0.6);
        }
        .confirm-cancel {
            background: rgba(255, 202, 58, 0.1);
            border: 2px solid #FFCA3A;
            color: #FFCA3A;
        }
        .confirm-cancel:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 202, 58, 0.5);
            background: rgba(255, 202, 58, 0.2);
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #8AC926;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Beautiful Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: linear-gradient(135deg, #1D3557, #457B9D);
            border: 3px solid;
            border-radius: 15px;
            padding: 20px 25px;
            min-width: 320px;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: toastSlideIn 0.4s ease, toastFadeOut 0.3s ease 4.7s forwards;
            pointer-events: auto;
            position: relative;
            overflow: hidden;
        }
        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #8AC926, #FFD700, #FF6B35);
            animation: toastProgress 5s linear forwards;
        }
        .toast.success {
            border-color: #8AC926;
        }
        .toast.error {
            border-color: #FF006E;
        }
        .toast.warning {
            border-color: #FFCA3A;
        }
        .toast.info {
            border-color: #457B9D;
        }
        .toast-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: bold;
        }
        .toast-icon {
            font-size: 24px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        .toast-title {
            flex: 1;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .toast-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .toast-close:hover {
            color: #fff;
            transform: scale(1.1);
        }
        .toast-message {
            font-size: 11px;
            line-height: 1.6;
            color: #F1FAEE;
            white-space: pre-line;
            word-wrap: break-word;
        }
        .toast-link {
            display: inline-block;
            margin-top: 8px;
            color: #8AC926;
            text-decoration: underline;
            font-size: 10px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .toast-link:hover {
            color: #FFD700;
        }
        @keyframes toastSlideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes toastFadeOut {
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        @keyframes toastProgress {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }
        
        /* PROGRESS SPINNER */
        .progress-spinner {
            border: 6px solid rgba(255, 202, 58, 0.2);
            border-top: 6px solid #FFCA3A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .header h1 { font-size: 20px; }
            .header .subtitle { font-size: 10px; }
            
            .wallet-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .wallet-info {
                justify-content: space-around;
                width: 100%;
            }
            
            .btn-connect, .btn-my-nfts {
                width: 100%;
                padding: 15px;
            }
            
            .collection-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-icon {
                font-size: 28px;
            }
            
            .stat-value {
                font-size: 18px;
            }
            
            .stat-label {
                font-size: 9px;
            }
            
            .recent-mints-list {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 10px;
            }
            
            .nft-benefits-section {
                padding: 20px 15px;
            }
            
            .benefits-header h2 {
                font-size: 16px;
            }
            
            .benefits-subtitle {
                font-size: 10px;
            }
            
            .benefits-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .benefit-icon {
                font-size: 40px;
            }
            
            .benefit-title {
                font-size: 11px;
            }
            
            .benefit-description {
                font-size: 8px;
            }
            
            .earnings-calculator {
                padding: 20px 15px;
            }
            
            .earnings-calculator h3 {
                font-size: 14px;
            }
            
            .calculator-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .calc-tier-name {
                font-size: 11px;
            }
            
            .calc-row {
                font-size: 8px;
            }
            
            .calc-row strong {
                font-size: 9px;
            }
            
            .calc-note {
                font-size: 7px;
            }
            
            .tier-card {
                min-width: 280px;
            }
            
            .faq-section {
                padding: 20px 15px;
            }
            
            .faq-title {
                font-size: 16px;
            }
            
            .faq-grid {
                grid-template-columns: 1fr;
            }
            
            .faq-question {
                font-size: 10px;
                padding: 15px;
            }
            
            .faq-answer {
                font-size: 9px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .collection-stats {
                grid-template-columns: 1fr;
            }
            
            .recent-mints-list {
                grid-template-columns: 1fr;
            }
            
            .calculator-grid {
                grid-template-columns: 1fr;
            }
            
            .tier-card {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Devnet Notice Banner -->
    <div id="devnet-banner" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                color: white; 
                padding: 12px 20px; 
                text-align: center; 
                font-family: 'Press Start 2P', cursive; 
                font-size: 11px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                position: relative;
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;">
        <span>‚ö†Ô∏è TESTNET MODE (Devnet)</span>
        <span style="color: #FFD700;">|</span>
        <span>Need test SOL?</span>
        <a href="https://faucet.solana.com/" target="_blank" 
           style="color: #FFD700; 
                  text-decoration: none;
                  padding: 6px 12px;
                  background: rgba(255, 215, 0, 0.2);
                  border-radius: 6px;
                  border: 1px solid #FFD700;
                  transition: all 0.3s;
                  display: inline-block;"
           onmouseover="this.style.background='rgba(255, 215, 0, 0.4)'"
           onmouseout="this.style.background='rgba(255, 215, 0, 0.2)'">
            üö∞ Get Free SOL
        </a>
        <span style="color: #FFD700;">|</span>
        <span style="color: #A8D5FF;">Mint NFTs for testing</span>
    </div>
    
    <!-- Logo - Left Side -->
    <a href="/" class="game-logo" title="Back to Home">
        <img src="logo.png" alt="Solana Tamagotchi">
    </a>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <main class="container" role="main">
        <header class="header">
            <h1>üé® MINT YOUR NFT PET</h1>
            <p class="subtitle">5 TIERS | BONDING CURVE | FIXED BOOSTS</p>
        </header>
        
        <section class="wallet-section" aria-label="Wallet Connection">
            <div class="wallet-info">
                <div>üëõ <span id="wallet-status">Connect Wallet</span></div>
                <div>SOL: <span id="sol-balance">0</span></div>
                <div>TAMA: <span id="tama-balance">Loading...</span></div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-connect" onclick="connectWallet()">Connect Wallet</button>
                <button class="btn-faucet" onclick="openFaucet()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: 2px solid #FFD700;">üö∞ Get Test SOL</button>
                <button class="btn-my-nfts" onclick="viewMyNFTs()">üñºÔ∏è MY NFTs</button>
            </div>
        </section>
        
        <!-- NFT CARDS - –ì–õ–ê–í–ù–û–ï –ü–ï–†–í–´–ú! -->
        <section class="tier-grid" aria-label="NFT Collection Tiers">
            <!-- Bronze Card -->
            <div class="tier-card bronze">
                <div class="tier-icon">üü´</div>
                <div class="tier-name">BRONZE</div>
                <div class="tier-supply">Common ¬∑ 4,500 available</div>
                <div class="tier-price">
                    <div class="main-price">5000 TAMA</div>
                    <div class="usd-price">$25</div>
                    <div class="next-price">or 0.15 SOL</div>
                </div>
                <div class="tier-boost">√ó2.0 EARNING</div>
                <div class="passive-income">üéÅ +50 TAMA/day</div>
                <div class="progress-bar"><div class="progress-fill bronze" id="progress-bronze" style="width: 0%"></div></div>
                <div class="tier-minted-count">Minted: <span id="minted-bronze">0</span> / <span id="max-bronze">4500</span></div>
                <div class="bronze-buttons">
                    <button class="bronze-btn" onclick="mintBronze()">FREE</button>
                    <button class="bronze-btn sol" onclick="mintBronzeSOL()">0.15 SOL</button>
                </div>
            </div>
            
            <!-- Silver Card -->
            <div class="tier-card silver">
                <div class="fomo-badge">üî• PRICE ‚Üë</div>
                <div class="tier-icon">ü•à</div>
                <div class="tier-name">SILVER</div>
                <div class="tier-supply">Uncommon ¬∑ 350 available</div>
                <div class="tier-price">
                    <div class="main-price"><span id="price-silver-sol">1</span> SOL</div>
                    <div class="usd-price">$<span id="price-silver-usd">164</span></div>
                    <div class="next-price">Next: <span id="next-silver">1.01</span> SOL (+0.6%)</div>
                </div>
                <div class="tier-boost">√ó2.3 EARNING</div>
                <div class="passive-income">üéÅ +150 TAMA/day</div>
                <div class="progress-bar"><div class="progress-fill silver" id="progress-silver" style="width: 0%"></div></div>
                <div class="tier-minted-count">Minted: <span id="minted-silver">0</span> / <span id="max-silver">350</span></div>
                <button class="mint-btn" onclick="mintSOL('Silver')">üíé MINT SILVER</button>
            </div>
            
            <!-- Gold Card -->
            <div class="tier-card gold">
                <div class="fomo-badge">üî• PRICE ‚Üë</div>
                <div class="tier-icon">ü•á</div>
                <div class="tier-name">GOLD</div>
                <div class="tier-supply">Rare ¬∑ 130 available</div>
                <div class="tier-price">
                    <div class="main-price"><span id="price-gold-sol">3</span> SOL</div>
                    <div class="usd-price">$<span id="price-gold-usd">492</span></div>
                    <div class="next-price">Next: <span id="next-gold">3.05</span> SOL (+1.8%)</div>
                </div>
                <div class="tier-boost">√ó2.7 EARNING</div>
                <div class="passive-income">üéÅ +500 TAMA/day</div>
                <div class="progress-bar"><div class="progress-fill gold" id="progress-gold" style="width: 0%"></div></div>
                <div class="tier-minted-count">Minted: <span id="minted-gold">0</span> / <span id="max-gold">130</span></div>
                <button class="mint-btn" onclick="mintSOL('Gold')">üèÜ MINT GOLD</button>
            </div>
            
            <!-- Platinum Card -->
            <div class="tier-card platinum">
                <div class="fomo-badge">üî• RARE!</div>
                <div class="tier-icon">üíé</div>
                <div class="tier-name">PLATINUM</div>
                <div class="tier-supply">Epic ¬∑ Only 18!</div>
                <div class="tier-price">
                    <div class="main-price"><span id="price-platinum-sol">10</span> SOL</div>
                    <div class="usd-price">$<span id="price-platinum-usd">1,641</span></div>
                    <div class="next-price">Next: <span id="next-platinum">11.11</span> SOL (+11%)</div>
                </div>
                <div class="tier-boost">√ó3.5 EARNING</div>
                <div class="passive-income">üéÅ +2000 TAMA/day</div>
                <div class="progress-bar"><div class="progress-fill platinum" id="progress-platinum" style="width: 0%"></div></div>
                <div class="tier-minted-count">Minted: <span id="minted-platinum">0</span> / <span id="max-platinum">18</span></div>
                <button class="mint-btn" onclick="mintSOL('Platinum')">‚ö° MINT PLATINUM</button>
            </div>
            
            <!-- Diamond Card -->
            <div class="tier-card diamond">
                <div class="fomo-badge">‚ö†Ô∏è ONLY 2!</div>
                <div class="tier-icon">üî∑</div>
                <div class="tier-name">DIAMOND</div>
                <div class="tier-supply">Legendary ¬∑ ONLY 2 EXIST!</div>
                <div class="tier-price">
                    <div class="main-price"><span id="price-diamond-sol">50</span> SOL</div>
                    <div class="usd-price">$<span id="price-diamond-usd">8,204</span></div>
                    <div class="next-price">Next: <span id="next-diamond">100</span> SOL (+100%)</div>
                </div>
                <div class="tier-boost">√ó5.0 MAXIMUM!</div>
                <div class="passive-income">üéÅ +10000 TAMA/day</div>
                <div class="progress-bar"><div class="progress-fill diamond" id="progress-diamond" style="width: 0%"></div></div>
                <div class="tier-minted-count">Minted: <span id="minted-diamond">0</span> / <span id="max-diamond">2</span></div>
                <button class="mint-btn" onclick="mintSOL('Diamond')">üëë MINT DIAMOND</button>
            </div>
        </section>
        
        <!-- COLLECTION STATS -->
        <section class="collection-stats" aria-label="Collection Statistics">
            <div class="stat-card">
                <div class="stat-icon">üé®</div>
                <div class="stat-value" id="total-minted">0</div>
                <div class="stat-label">NFTs Minted</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="unique-holders">0</div>
                <div class="stat-label">Happy Owners</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="total-volume">0 SOL</div>
                <div class="stat-label">Total Volume</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-value" id="floor-price">0.15 SOL</div>
                <div class="stat-label">Floor Price</div>
            </div>
        </section>
        
        <!-- LIVE RECENT MINTS -->
        <section class="recent-mints-section" aria-label="Recent NFT Mints">
            <h2 class="sidebar-title">üî• LIVE ACTIVITY</h2>
            <div id="recent-mints-list" class="recent-mints-list">
                <div class="loading-mints">Loading recent mints...</div>
            </div>
            <div class="sidebar-footer">
                <div class="pulse-dot"></div>
                <span>Live updates every 30s</span>
            </div>
        </section>
        
        <!-- NFT BENEFITS SECTION -->
        <section class="nft-benefits-section" aria-label="NFT Benefits and Earnings">
            <header class="benefits-header">
                <h2>üíé WHY MINT NFT?</h2>
                <p class="benefits-subtitle">Your NFT is not just art - it's a money-making machine! üöÄ</p>
            </header>
            <div class="benefits-grid">
                <div class="benefit-card">
                    <div class="benefit-icon">üí∞</div>
                    <div class="benefit-title">PASSIVE INCOME</div>
                    <div class="benefit-description">Earn TAMA tokens every day automatically!</div>
                    <div class="benefit-amount">+50 to +10,000 TAMA/day</div>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">üöÄ</div>
                    <div class="benefit-title">EARNING BOOST</div>
                    <div class="benefit-description">Multiply your click rewards in the game!</div>
                    <div class="benefit-amount">√ó2.0 to √ó5.0 Multiplier</div>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">üìà</div>
                    <div class="benefit-title">PRICE GROWTH</div>
                    <div class="benefit-description">Bonding curve = price increases with demand!</div>
                    <div class="benefit-amount">+0.6% to +100% per mint</div>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">üîó</div>
                    <div class="benefit-title">REAL ON-CHAIN</div>
                    <div class="benefit-description">Your NFT lives on Solana blockchain forever!</div>
                    <div class="benefit-amount">Trade on marketplaces</div>
                </div>
            </div>
            
            <!-- EARNINGS CALCULATOR -->
            <div class="earnings-calculator">
                <h3>üí∏ EARNINGS CALCULATOR</h3>
                <div class="calculator-grid">
                    <div class="calc-tier">
                        <div class="calc-tier-name">ü•â Bronze</div>
                        <div class="calc-row">
                            <span>Daily:</span>
                            <strong>+50 TAMA</strong>
                        </div>
                        <div class="calc-row">
                            <span>Monthly:</span>
                            <strong class="highlight">+1,500 TAMA</strong>
                        </div>
                        <div class="calc-row">
                            <span>ROI:</span>
                            <strong class="success">~10 days</strong>
                        </div>
                    </div>
                    <div class="calc-tier">
                        <div class="calc-tier-name">ü•à Silver</div>
                        <div class="calc-row">
                            <span>Daily:</span>
                            <strong>+150 TAMA</strong>
                        </div>
                        <div class="calc-row">
                            <span>Monthly:</span>
                            <strong class="highlight">+4,500 TAMA</strong>
                        </div>
                        <div class="calc-row">
                            <span>ROI:</span>
                            <strong class="success">~7 days</strong>
                        </div>
                    </div>
                    <div class="calc-tier">
                        <div class="calc-tier-name">ü•á Gold</div>
                        <div class="calc-row">
                            <span>Daily:</span>
                            <strong>+500 TAMA</strong>
                        </div>
                        <div class="calc-row">
                            <span>Monthly:</span>
                            <strong class="highlight">+15,000 TAMA</strong>
                        </div>
                        <div class="calc-row">
                            <span>ROI:</span>
                            <strong class="success">~6 days</strong>
                        </div>
                    </div>
                    <div class="calc-tier">
                        <div class="calc-tier-name">üíé Diamond</div>
                        <div class="calc-row">
                            <span>Daily:</span>
                            <strong>+10,000 TAMA</strong>
                        </div>
                        <div class="calc-row">
                            <span>Monthly:</span>
                            <strong class="highlight">+300,000 TAMA</strong>
                        </div>
                        <div class="calc-row">
                            <span>ROI:</span>
                            <strong class="success">~5 days</strong>
                        </div>
                    </div>
                </div>
                <div class="calc-note">
                    * Calculations based on passive earnings only. With x2-x5 boost multiplier your earnings will be even higher! üöÄ
                </div>
            </div>
        </div>
        
        <!-- FAQ SECTION -->
        <div class="faq-section">
            <h2 class="faq-title">‚ùì FREQUENTLY ASKED QUESTIONS</h2>
            <div class="faq-grid">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>üé® What do I get when I mint an NFT?</span>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        You get a unique NFT Tamagotchi pet stored on Solana blockchain! It includes:
                        <br>‚Ä¢ <strong>Passive Income</strong> - earn 50-10,000 TAMA daily automatically
                        <br>‚Ä¢ <strong>Earning Boost</strong> - multiply your game rewards by 2x-5x
                        <br>‚Ä¢ <strong>Real Ownership</strong> - fully yours, tradeable on marketplaces
                        <br>‚Ä¢ <strong>Unique Design</strong> - one of 5000 unique pets with different rarities
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>üëõ What wallet do I need?</span>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        You need <strong>Phantom Wallet</strong> (recommended) or any Solana-compatible wallet.
                        <br>‚Ä¢ Click "Connect Wallet" button above
                        <br>‚Ä¢ Make sure you're on <strong>Devnet</strong> network
                        <br>‚Ä¢ Have at least 0.2 SOL for gas fees + mint price
                        <br><br>
                        üì≤ <a href="https://phantom.app/" target="_blank" style="color: #8AC926;">Download Phantom Wallet ‚Üí</a>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>üí∞ How does the earning boost work?</span>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        Your NFT multiplies ALL your earnings in the game:
                        <br>‚Ä¢ <strong>Without NFT:</strong> Click = +1 TAMA
                        <br>‚Ä¢ <strong>With Silver NFT (√ó2.3):</strong> Click = +2.3 TAMA
                        <br>‚Ä¢ <strong>With Diamond NFT (√ó5.0):</strong> Click = +5 TAMA
                        <br><br>
                        Plus you get passive income every day even when you're not playing! üöÄ
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>üîÑ Can I sell or trade my NFT?</span>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        Yes! Your NFT is <strong>100% yours</strong> and lives on Solana blockchain:
                        <br>‚Ä¢ Trade on marketplaces like Magic Eden
                        <br>‚Ä¢ Transfer to another wallet
                        <br>‚Ä¢ Sell to other players
                        <br>‚Ä¢ Keep forever - it's immutable and can't be taken away
                        <br><br>
                        ‚ö†Ô∏è Note: Selling removes your in-game boost until you buy another NFT
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>üìà Why do prices increase?</span>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        We use a <strong>Bonding Curve</strong> mechanism:
                        <br>‚Ä¢ Each mint increases the price for the next buyer
                        <br>‚Ä¢ Early buyers get the best prices! üéØ
                        <br>‚Ä¢ Silver: +0.6% per mint
                        <br>‚Ä¢ Gold: +1.8% per mint
                        <br>‚Ä¢ Diamond: +100% per mint (only 2 exist!)
                        <br><br>
                        This creates natural scarcity and rewards early supporters üöÄ
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>‚ö° How long does minting take?</span>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <strong>Bronze (TAMA payment):</strong> Instant! ‚ö°
                        <br>‚Ä¢ Uses off-chain system for speed
                        <br>‚Ä¢ Your boost activates immediately
                        <br><br>
                        <strong>Silver/Gold/Platinum/Diamond (SOL payment):</strong>
                        <br>‚Ä¢ 30-60 seconds to mint on Solana blockchain
                        <br>‚Ä¢ 100% real on-chain NFT with provable ownership
                        <br>‚Ä¢ View your NFT on Solana Explorer after mint
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>üö∞ Where can I get test SOL for Devnet?</span>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        This is a <strong>testnet (Devnet)</strong> deployment for testing. Get free test SOL from these faucets:
                        <br><br>
                        <strong>üåä Official Solana Faucet</strong>
                        <br>‚Ä¢ <a href="https://faucet.solana.com/" target="_blank" style="color: #8AC926;">https://faucet.solana.com/</a>
                        <br>‚Ä¢ Gives: 1-2 SOL per request
                        <br>‚Ä¢ Fast and reliable
                        <br><br>
                        <strong>üíß SolFaucet</strong>
                        <br>‚Ä¢ <a href="https://solfaucet.com/" target="_blank" style="color: #8AC926;">https://solfaucet.com/</a>
                        <br>‚Ä¢ Gives: 1 SOL per request
                        <br>‚Ä¢ Simple and quick
                        <br><br>
                        üí° <strong>Tip:</strong> You'll need at least <strong>0.5 SOL</strong> for minting + gas fees. Click the <strong>"üö∞ Get Test SOL"</strong> button above for quick access!
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Custom Confirmation Modal -->
        <div id="confirm-modal" class="confirm-modal hidden">
            <div class="confirm-modal-content">
                <button class="modal-close-btn" onclick="document.getElementById('confirm-modal').classList.add('hidden')">√ó</button>
                <h3 id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</h3>
                <p id="confirm-message"></p>
                <div class="confirm-buttons">
                    <button id="confirm-ok" class="confirm-btn confirm-ok">‚úÖ OK</button>
                    <button id="confirm-cancel" class="confirm-btn confirm-cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Solana Web3.js - defer (not critical for first render) -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js" defer></script>
    
    <!-- Metaplex SDK - defer (not critical for first render) -->
    <script src="https://unpkg.com/@metaplex-foundation/js@latest/dist/index.umd.js" defer></script>
    
    <!-- Metaplex Minter Module - defer -->
    <script src="js/metaplex-mint.js" defer></script>
    
    <!-- Supabase - defer -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    
    <!-- Unified Auth System - defer -->
    <script src="js/auth.js" defer></script>
    <script src="js/profile-widget.js" defer></script>
    
    <!-- Keep-Alive Ping (prevents Render.com free instance from spinning down) - defer -->
    <script src="js/keep-alive.js?v=1" defer></script>
    
    <!-- Legal Checkbox for Minting - defer -->
    <script src="js/legal-checkbox.js" defer></script>
    
    <script>
        // ==============================================
        // CONFIG
        // ==============================================
        const SUPABASE_URL = 'https://zfrazyupameidxpjihrh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcmF6eXVwYW1laWR4cGppaHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5Mzc1NTAsImV4cCI6MjA3NTUxMzU1MH0.1EkMDqCNJoAjcJDh3Dd3yPfus-JpdcwE--z2dhjh7wU';
        // Use shared supabase client from auth.js if available, otherwise create one
        // This prevents multiple GoTrueClient instances warning
        let mintSupabase;
        if (window.GotchiAuth && window.GotchiAuth.getState && window.supabase) {
            // Try to get supabase from auth.js internal state (if exposed)
            // Otherwise create with same config but different storage key
            mintSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: {
                    storageKey: 'mint-supabase-auth-token', // Different storage key to avoid conflicts
                    autoRefreshToken: true,
                    persistSession: false // Don't persist session here, auth.js handles it
                }
            });
        } else if (window.supabase) {
            mintSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: {
                    storageKey: 'mint-supabase-auth-token',
                    autoRefreshToken: true,
                    persistSession: false
                }
            });
        } else {
            mintSupabase = null;
        }

        // API Base URL
        const TAMA_API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8002/api/tama'
            : 'https://api.solanatamagotchi.com/api/tama';

        // Load SOL/USD rate from cache or use default
        let SOL_USD_RATE = parseFloat(localStorage.getItem('sol_usd_rate')) || 164.07;
        
        // Use unified auth system
        let TELEGRAM_USER_ID = null;
        let WALLET_ADDRESS = null;
        let WALLET_USER_ID = null;
        let isWalletUser = false;
        
        // Check for wallet authentication
        if (window.WALLET_ADDRESS) {
            WALLET_ADDRESS = window.WALLET_ADDRESS;
            WALLET_USER_ID = window.WALLET_USER_ID;
            isWalletUser = true;
            console.log('‚úÖ Wallet user detected:', WALLET_ADDRESS);
        }
        
        // Wait for auth to initialize
        window.addEventListener('gotchiAuthReady', (e) => {
            if (window.GotchiAuth && window.GotchiAuth.isAuthenticated()) {
                TELEGRAM_USER_ID = window.GotchiAuth.getTelegramId();
                console.log('‚úÖ Auth ready, Telegram ID:', TELEGRAM_USER_ID);
                // Update TAMA balance if authenticated
                if (TELEGRAM_USER_ID) {
                    loadTAMABalance();
                }
            }
        });
        
        // Also check for wallet auth on page load
        if (window.WalletAuth && window.WalletAuth.isAuthenticated && window.WalletAuth.isAuthenticated()) {
            WALLET_ADDRESS = window.WalletAuth.getWalletAddress();
            WALLET_USER_ID = window.WalletAuth.getUserId();
            isWalletUser = true;
            console.log('‚úÖ Wallet auth detected:', WALLET_ADDRESS);
            if (WALLET_ADDRESS) {
                loadTAMABalance();
            }
        }
        
        // Fallback to old method if auth not ready
        function getTelegramUserId() {
            if (window.GotchiAuth && window.GotchiAuth.isAuthenticated()) {
                return window.GotchiAuth.getTelegramId();
            }
            
            // Try to get from URL params
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('user_id')) {
                return parseInt(urlParams.get('user_id'));
            }
            
            // Try Telegram WebApp API
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user && user.id) {
                    return user.id;
                }
            }
            
            return null;
        }
        
        // Initialize
        TELEGRAM_USER_ID = getTelegramUserId();

        // Treasury Wallet Addresses (Devnet)
        const TREASURY_MAIN = '6rY5inYo8JmDTj91UwMKLr1MyxyAAQGjLpJhSi6dNpFM';
        const TREASURY_LIQUIDITY = 'CeeKjLEVfY15fmiVnPrGzjneN5i3UsrRW4r4XHdavGk1';
        const TREASURY_TEAM = 'Amy5EJqZWp713SaT3nieXSSZjxptVXJA1LhtpTE7Ua8';

        // State
        let walletConnected = false;
        let walletAddress = null;
        let tamaBalance = 0;

        // ==============================================
        // BEAUTIFUL NOTIFICATIONS
        // ==============================================
        function showNotification(type, title, message, link = null) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            // SECURITY: Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            const safeTitle = escapeHtml(title);
            const safeMessage = escapeHtml(message);
            
            toast.innerHTML = `
                <div class="toast-header">
                    <span class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</span>
                    <span class="toast-title">${safeTitle}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
                <div class="toast-message">${safeMessage}</div>
                ${link ? `<a href="${escapeHtml(link)}" target="_blank" class="toast-link">üîó View on Explorer ‚Üí</a>` : ''}
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'toastFadeOut 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        // ==============================================
        // LOADING PROGRESS INDICATOR
        // ==============================================
        function showLoadingProgress(title, subtitle = '') {
            // Create progress modal
            let progressModal = document.getElementById('progress-modal');
            if (!progressModal) {
                progressModal = document.createElement('div');
                progressModal.id = 'progress-modal';
                progressModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.85);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                    backdrop-filter: blur(10px);
                `;
                
                progressModal.innerHTML = `
                    <div style="background: linear-gradient(135deg, #1D3557, #457B9D);
                                border: 4px solid #FFCA3A;
                                border-radius: 20px;
                                padding: 40px;
                                text-align: center;
                                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                                max-width: 400px;
                                width: 90%;">
                        <div class="progress-spinner" style="margin: 0 auto 20px; width: 60px; height: 60px;"></div>
                        <h3 id="progress-title" style="color: #FFCA3A; font-size: 20px; margin: 0 0 10px 0; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">${title}</h3>
                        <p id="progress-subtitle" style="color: #F1FAEE; font-size: 14px; margin: 0 0 20px 0; line-height: 1.6;">${subtitle}</p>
                        <div id="progress-steps" style="text-align: left; color: #8AC926; font-size: 13px; line-height: 1.8;"></div>
                    </div>
                `;
                
                document.body.appendChild(progressModal);
            }
            
            progressModal.style.display = 'flex';
            document.getElementById('progress-title').textContent = title;
            document.getElementById('progress-subtitle').textContent = subtitle;
            document.getElementById('progress-steps').innerHTML = '';
        }
        
        function updateLoadingProgress(step) {
            const stepsContainer = document.getElementById('progress-steps');
            if (stepsContainer) {
                const stepEl = document.createElement('div');
                stepEl.innerHTML = `‚úì ${step}`;
                stepEl.style.cssText = 'margin: 5px 0; opacity: 0; animation: fadeIn 0.5s forwards;';
                stepsContainer.appendChild(stepEl);
                
                // Auto-scroll to bottom
                stepsContainer.scrollTop = stepsContainer.scrollHeight;
            }
        }
        
        function hideLoadingProgress() {
            const progressModal = document.getElementById('progress-modal');
            if (progressModal) {
                progressModal.style.display = 'none';
            }
        }

        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        function getTelegramUserId() {
            // Try to get from URL params
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('user_id')) {
                return parseInt(urlParams.get('user_id'));
            }
            
            // Try Telegram WebApp API
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user && user.id) {
                    return user.id;
                }
            }
            
            // Fallback for testing
            return 123456789;
        }

        function goToMyNFTs() {
            window.location.href = `my-nfts.html?user_id=${TELEGRAM_USER_ID}`;
        }

        // ==============================================
        // SOL/USD PRICE FETCHING
        // ==============================================
        async function fetchSOLPrice() {
            try {
                // Try CoinGecko API (free, no API key needed)
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
                if (response.ok) {
                    const data = await response.json();
                    if (data.solana && data.solana.usd) {
                        const newRate = data.solana.usd;
                        if (newRate > 0 && newRate < 10000) { // Sanity check
                            SOL_USD_RATE = newRate;
                            localStorage.setItem('sol_usd_rate', newRate.toString());
                            console.log(`‚úÖ SOL/USD rate updated: $${SOL_USD_RATE.toFixed(2)}`);
                            // Update all USD prices
                            updateAllUSDPrices();
                            return true;
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to fetch SOL price from CoinGecko:', error);
            }

            // Fallback: Try alternative API (Binance)
            try {
                const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=SOLUSDT');
                if (response.ok) {
                    const data = await response.json();
                    if (data.price) {
                        const newRate = parseFloat(data.price);
                        if (newRate > 0 && newRate < 10000) {
                            SOL_USD_RATE = newRate;
                            localStorage.setItem('sol_usd_rate', newRate.toString());
                            console.log(`‚úÖ SOL/USD rate updated (Binance): $${SOL_USD_RATE.toFixed(2)}`);
                            updateAllUSDPrices();
                            return true;
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to fetch SOL price from Binance:', error);
            }

            console.warn('‚ö†Ô∏è Using default SOL/USD rate:', SOL_USD_RATE);
            return false;
        }

        function updateAllUSDPrices() {
            // Update Bronze USD price
            const bronzeUsdSpan = document.getElementById('price-bronze-usd');
            if (bronzeUsdSpan) {
                bronzeUsdSpan.textContent = Math.round(0.15 * SOL_USD_RATE);
            }

            // Update all tier USD prices
            const tierNames = ['silver', 'gold', 'platinum', 'diamond'];
            tierNames.forEach(tierName => {
                const solSpan = document.getElementById(`price-${tierName}-sol`);
                const usdSpan = document.getElementById(`price-${tierName}-usd`);
                
                if (solSpan && usdSpan) {
                    const solPrice = parseFloat(solSpan.textContent);
                    if (!isNaN(solPrice) && solPrice > 0) {
                        const usdPrice = solPrice * SOL_USD_RATE;
                        usdSpan.textContent = Math.round(usdPrice).toLocaleString();
                    }
                }
            });

            // Also update in confirmation modals if they're open
            // This will be handled when modals are shown
        }

        function updateWalletUI() {
            if (walletConnected && walletAddress) {
                const walletAddressEl = document.getElementById('wallet-address');
                const connectWalletEl = document.getElementById('connect-wallet');
                const walletInfoEl = document.getElementById('wallet-info');
                
                if (walletAddressEl) {
                    walletAddressEl.textContent = 
                        walletAddress.substring(0, 4) + '...' + walletAddress.substring(walletAddress.length - 4);
                }
                
                if (connectWalletEl) {
                    connectWalletEl.textContent = '‚úÖ Connected';
                }
                
                if (walletInfoEl) {
                    walletInfoEl.style.display = 'block';
                }
                
                // Update wallet status
                const walletStatusEl = document.getElementById('wallet-status');
                if (walletStatusEl) {
                    walletStatusEl.textContent = walletAddress.substring(0, 4) + '...' + walletAddress.substring(walletAddress.length - 4);
                }
                
                const connectBtn = document.querySelector('.btn-connect');
                if (connectBtn) {
                    connectBtn.textContent = '‚úÖ Connected';
                }
            }
        }
        
        // Update SOL balance function
        async function updateWalletBalance() {
            if (!walletAddress) {
                console.warn('‚ö†Ô∏è No wallet address to update balance');
                return;
            }
            
            try {
                const connection = new solanaWeb3.Connection('https://api.devnet.solana.com');
                const publicKey = new solanaWeb3.PublicKey(walletAddress);
                const balance = await connection.getBalance(publicKey);
                const solBalance = balance / 1e9;
                
                const solBalanceEl = document.getElementById('sol-balance');
                if (solBalanceEl) {
                    solBalanceEl.textContent = solBalance.toFixed(4);
                }
                
                console.log('‚úÖ SOL balance updated:', solBalance.toFixed(4), 'SOL');
            } catch (err) {
                console.error('‚ùå Failed to update SOL balance:', err);
            }
        }

        // ==============================================
        // WALLET FUNCTIONS
        // ==============================================
        
        // Navigate to My NFTs page
        function viewMyNFTs() {
            // If wallet connected, pass wallet address as parameter
            if (window.walletConnected && window.walletAddress) {
                window.location.href = `my-nfts.html?wallet=${window.walletAddress}`;
            } else {
                // Otherwise just open the page (user can connect there)
                window.location.href = 'my-nfts.html';
            }
        }
        
        // Open Solana Devnet Faucet
        function openFaucet() {
            const faucetOptions = [
                {
                    name: 'Official Solana Faucet',
                    url: 'https://faucet.solana.com/',
                    amount: '1-2 SOL',
                    emoji: 'üåä'
                },
                {
                    name: 'SolFaucet',
                    url: 'https://solfaucet.com/',
                    amount: '1 SOL',
                    emoji: 'üíß'
                }
            ];
            
            // Show modal with faucet options
            showCustomModal(
                'üö∞ Get Test SOL for Devnet',
                `
                <div style="text-align: left; font-size: 14px; line-height: 1.6;">
                    <p style="margin-bottom: 15px; text-align: center; color: #666;">
                        Choose a faucet to get free test SOL for minting NFTs on Devnet:
                    </p>
                    ${faucetOptions.map(faucet => `
                        <div style="background: #f8f9fa; 
                                    padding: 15px; 
                                    margin-bottom: 10px; 
                                    border-radius: 8px; 
                                    border: 2px solid #e9ecef;
                                    cursor: pointer;
                                    transition: all 0.3s;"
                             onclick="window.open('${faucet.url}', '_blank'); document.getElementById('confirm-modal').classList.add('hidden');"
                             onmouseover="this.style.borderColor='#667eea'; this.style.background='#f0f4ff';"
                             onmouseout="this.style.borderColor='#e9ecef'; this.style.background='#f8f9fa';">
                            <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                ${faucet.emoji} ${faucet.name}
                            </div>
                            <div style="color: #666; font-size: 12px;">
                                Gives: ${faucet.amount}
                            </div>
                        </div>
                    `).join('')}
                    <p style="margin-top: 15px; text-align: center; color: #999; font-size: 12px;">
                        üí° Tip: You'll need at least 0.5 SOL for minting + gas fees
                    </p>
                </div>
                `
            );
        }
        
        // Show custom modal (for faucet list)
        function showCustomModal(title, htmlContent) {
            const modal = document.getElementById('confirm-modal');
            const titleEl = document.getElementById('confirm-title');
            const messageEl = document.getElementById('confirm-message');
            
            titleEl.textContent = title;
            messageEl.innerHTML = htmlContent;
            modal.classList.remove('hidden');
            
            // Hide OK button, only show Cancel (Close)
            const okBtn = document.getElementById('confirm-ok');
            const cancelBtn = document.getElementById('confirm-cancel');
            okBtn.style.display = 'none';
            cancelBtn.textContent = 'Close';
            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
                okBtn.style.display = 'inline-block';
                cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';
            };
        }
        
        // Make connectWallet globally accessible
        window.connectWallet = async function connectWallet() {
            try {
                // Use unified auth system if available
                if (window.GotchiAuth) {
                    const result = await window.GotchiAuth.authViaWallet();
                    if (result.success) {
                        walletAddress = result.walletAddress;
                        walletConnected = true;
                        window.walletAddress = walletAddress;
                        window.walletConnected = walletConnected;
                        
                        // Update UI
                        updateWalletUI();
                        // Update balance (function is defined below)
                        if (typeof updateWalletBalance === 'function') {
                            await updateWalletBalance();
                        }
                        showNotification('success', 'Wallet Connected', `Connected: ${walletAddress.substring(0, 8)}...${walletAddress.substring(walletAddress.length - 6)}`);
                        return;
                    }
                }
                
                // Fallback to direct connection
                if (!window.solana || !window.solana.isPhantom) {
                    showNotification('error', 'Wallet Required', 'Please install Phantom wallet to continue!');
                    window.open('https://phantom.app/', '_blank');
                    return;
                }

                const resp = await window.solana.connect();
                walletAddress = resp.publicKey.toString();
                walletConnected = true;

                // Save wallet address to localStorage for persistence
                localStorage.setItem('phantom_wallet_address', walletAddress);
                console.log('‚úÖ Wallet address saved to localStorage:', walletAddress);

                // Save wallet address to database
                try {
                    const saveWalletUrl = `${TAMA_API_BASE}/update-wallet`;
                    const saveWalletResponse = await fetch(saveWalletUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telegram_id: TELEGRAM_USER_ID,
                            wallet_address: walletAddress
                        })
                    });
                    
                    if (saveWalletResponse.ok) {
                        const saveResult = await saveWalletResponse.json();
                        console.log('‚úÖ Wallet address saved to database:', saveResult);
                    } else {
                        console.warn('‚ö†Ô∏è Failed to save wallet to database:', saveWalletResponse.status);
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Error saving wallet to database:', err);
                }

                document.getElementById('wallet-status').textContent = 
                    walletAddress.substring(0, 4) + '...' + walletAddress.substring(walletAddress.length - 4);
                
                document.querySelector('.btn-connect').textContent = '‚úÖ Connected';

                // Get SOL balance
                const connection = new solanaWeb3.Connection('https://api.devnet.solana.com');
                const balance = await connection.getBalance(resp.publicKey);
                const solBalance = balance / 1e9;
                document.getElementById('sol-balance').textContent = solBalance.toFixed(4);

                console.log('‚úÖ Wallet connected:', walletAddress);
                console.log('üí∞ SOL balance:', solBalance.toFixed(4), 'SOL');
                
                // Check if balance is low
                if (solBalance < 0.5) {
                    showNotification('warning', 'Low SOL Balance', `You have ${solBalance.toFixed(4)} SOL. You may need more for minting + gas fees. Click "üö∞ Get Test SOL" button above!`);
                    
                    // Show faucet modal after 2 seconds if balance is very low
                    if (solBalance < 0.1) {
                        setTimeout(() => {
                            showConfirmModal(
                                'üí∞ Low Balance Detected',
                                `Your wallet has only ${solBalance.toFixed(4)} SOL.\n\nYou need at least 0.5 SOL for minting NFTs.\n\nWould you like to get free test SOL from faucet?`
                            ).then(confirmed => {
                                if (confirmed) {
                                    openFaucet();
                                }
                            });
                        }, 2000);
                    }
                } else {
                    showNotification('success', 'Wallet Connected', `Connected: ${walletAddress.substring(0, 4)}...${walletAddress.substring(walletAddress.length - 4)}`);
                }
            } catch (err) {
                console.error('‚ùå Wallet connection failed:', err);
                showNotification('error', 'Connection Failed', 'Failed to connect wallet. Please try again.');
            }
        }

        // ==============================================
        // LOAD PRICES & STATS
        // ==============================================
        // ‚ö° Loading flags to prevent duplicate requests
        let isLoadingPrices = false;
        let isLoadingBalance = false;
        
        async function loadPricesAndStats() {
            // Prevent duplicate requests
            if (isLoadingPrices) {
                console.log('‚è≥ Prices already loading, skipping...');
                return;
            }
            
            try {
                isLoadingPrices = true;
                console.log('üìä Loading prices and stats...');

                // Get bonding state
                const { data: bondingData, error: bondingError } = await supabase
                    .from('nft_bonding_state')
                    .select('*');

                if (bondingError) {
                    console.error('‚ùå Error loading bonding state:', bondingError);
                    return;
                }

                console.log('‚úÖ Bonding state loaded:', bondingData);

                // Update UI for each tier
                bondingData.forEach(tier => {
                    updateTierUI(tier);
                });
                
                // Update all USD prices with current SOL/USD rate
                updateAllUSDPrices();

            } catch (err) {
                console.error('‚ùå Error loading prices:', err);
            } finally {
                isLoadingPrices = false;
            }
        }

        function updateTierUI(tier) {
            const tierName = tier.tier_name.toLowerCase();
            
            // Special handling for Bronze (TAMA) - fixed price 5000 TAMA
            if (tierName === 'bronze') {
                // Fixed price 5000 TAMA - update minted count only
                const mintedSpan = document.getElementById('minted-bronze');
                if (mintedSpan) mintedSpan.textContent = tier.minted_count;
                
                const maxSpan = document.getElementById('max-bronze');
                if (maxSpan) maxSpan.textContent = tier.max_supply;
                
                // Update progress bar
                const progressFill = document.querySelector('#progress-bronze');
                if (progressFill) {
                    const percentage = (tier.minted_count / tier.max_supply) * 100;
                    progressFill.style.width = percentage + '%';
                }
                return;
            }
            
            // Special handling for Bronze_SOL (fixed price, update USD only)
            if (tierName === 'bronze_sol') {
                // Fixed price 0.15 SOL - update USD price only
                const bronzeUsdSpan = document.getElementById('price-bronze-usd');
                if (bronzeUsdSpan) {
                    bronzeUsdSpan.textContent = Math.round(0.15 * SOL_USD_RATE);
                }
                return;
            }
            
            // Update minted count
            const mintedSpan = document.getElementById(`minted-${tierName}`);
            if (mintedSpan) mintedSpan.textContent = tier.minted_count;

            // Update max supply
            const maxSpan = document.getElementById(`max-${tierName}`);
            if (maxSpan) maxSpan.textContent = tier.max_supply;

            // Update progress bar
            const progressFill = document.querySelector(`#progress-${tierName}`);
            if (progressFill) {
                const percentage = (tier.minted_count / tier.max_supply) * 100;
                progressFill.style.width = percentage + '%';
            }

            // Update prices for SOL tiers
            if (tier.payment_type === 'SOL') {
                // Helper: format SOL price (remove .00 for whole numbers)
                const formatSOL = (num) => {
                    return num % 1 === 0 ? num.toString() : num.toFixed(2);
                };
                
                const solSpan = document.getElementById(`price-${tierName}-sol`);
                if (solSpan) solSpan.textContent = formatSOL(parseFloat(tier.current_price));

                const usdSpan = document.getElementById(`price-${tierName}-usd`);
                if (usdSpan) {
                    const usdPrice = parseFloat(tier.current_price) * SOL_USD_RATE;
                    usdSpan.textContent = Math.round(usdPrice).toLocaleString();
                }

                const nextSpan = document.getElementById(`next-${tierName}`);
                if (nextSpan) {
                    const nextPrice = parseFloat(tier.current_price) + parseFloat(tier.increment_per_mint);
                    nextSpan.textContent = formatSOL(nextPrice);
                }
            }
        }

        // Flag to track if balance was modified (mint/withdrawal)
        let balanceModified = false;

        async function loadTAMABalance() {
            // Prevent duplicate requests
            if (isLoadingBalance) {
                console.log('‚è≥ Balance already loading, skipping...');
                return;
            }
            
            isLoadingBalance = true;
            try {
                // Get authenticated user ID from all possible sources
                let userId = null;
                
                // Priority 1: authState from unified auth system
                if (window.authState && window.authState.telegramId) {
                    userId = window.authState.telegramId;
                    console.log('üîê Using telegram_id from authState:', userId);
                } 
                // Priority 2: authState wallet
                else if (window.authState && window.authState.walletAddress) {
                    userId = window.authState.walletAddress;
                    console.log('üîê Using wallet from authState:', userId);
                }
                // Priority 3: Global variables
                else if (TELEGRAM_USER_ID) {
                    userId = TELEGRAM_USER_ID;
                    console.log('üîê Using TELEGRAM_USER_ID:', userId);
                }
                else if (WALLET_ADDRESS && isWalletUser) {
                    userId = WALLET_ADDRESS;
                    console.log('üîê Using WALLET_ADDRESS:', userId);
                }
                // Priority 4: URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Ç–æ–ª—å–∫–æ –Ω–∞ –ø–µ—Ä–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É)
                else {
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlUserId = urlParams.get('user_id');
                    const urlTama = urlParams.get('tama');
                    
                    if (urlTama && !balanceModified) {
                        tamaBalance = parseInt(urlTama) || 0;
                        document.getElementById('tama-balance').textContent = tamaBalance.toLocaleString();
                        console.log('‚úÖ TAMA balance from URL (first load):', tamaBalance);
                        isLoadingBalance = false;
                        return;
                    }
                    
                    if (urlUserId) {
                        userId = urlUserId;
                        console.log('üîê Using user_id from URL:', userId);
                    }
                }
                
                if (!userId) {
                    console.warn('‚ö†Ô∏è No user ID found, setting balance to 0');
                    tamaBalance = 0;
                    document.getElementById('tama-balance').textContent = '0';
                    isLoadingBalance = false;
                    return;
                }

                // Determine if it's a wallet address or telegram_id
                const isWalletAddress = /^[A-Za-z0-9]{32,44}$/.test(userId);
                
                if (isWalletAddress) {
                    // Load balance from wallet_users table
                    console.log('üì° Loading TAMA balance for wallet user:', userId);
                    
                    const { data: walletData, error: walletError } = await supabase
                        .from('wallet_users')
                        .select('tama_balance, clicks')
                        .eq('wallet_address', userId)
                        .single();
                    
                    if (walletError || !walletData) {
                        console.warn('‚ö†Ô∏è Wallet user not found in DB, creating entry...');
                        // Create entry if doesn't exist
                        const { error: insertError } = await supabase
                            .from('wallet_users')
                            .insert([{
                                wallet_address: userId,
                                tama_balance: 0,
                                clicks: 0
                            }]);
                        
                        if (!insertError) {
                            console.log('‚úÖ Created new wallet_users entry');
                        }
                        
                        tamaBalance = 0;
                        document.getElementById('tama-balance').textContent = '0';
                        isLoadingBalance = false;
                        return;
                    }
                    
                    tamaBalance = parseFloat(walletData.tama_balance) || 0;
                    document.getElementById('tama-balance').textContent = tamaBalance.toLocaleString();
                    console.log('‚úÖ TAMA balance loaded from wallet_users:', tamaBalance);
                } else {
                    // Load balance from API for Telegram user
                    const apiUrl = `${TAMA_API_BASE}/balance?telegram_id=${userId}`;
                    console.log('üì° Loading TAMA balance from API:', apiUrl);

                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.success) {
                        tamaBalance = result.database_tama || result.total_tama || 0;
                        document.getElementById('tama-balance').textContent = tamaBalance.toLocaleString();
                        console.log('‚úÖ TAMA balance loaded from API:', tamaBalance);
                    } else {
                        console.warn('‚ö†Ô∏è API returned error:', result.error);
                        tamaBalance = 0;
                        document.getElementById('tama-balance').textContent = '0';
                    }
                }
            } catch (err) {
                console.error('‚ùå Error loading TAMA balance:', err);
                tamaBalance = 0;
                document.getElementById('tama-balance').textContent = '0';
            } finally {
                isLoadingBalance = false;
            }
        }

        // ==============================================
        // SOL DISTRIBUTION FUNCTION
        // ==============================================
        async function createAndSendDistributionTransaction(priceSOL) {
            try {
                const { Transaction, SystemProgram, PublicKey, Connection } = solanaWeb3;
                const connection = new Connection('https://api.devnet.solana.com');
                
                // Create transaction with 3 transfers
                const transaction = new Transaction();
                
                // Transfer 1: 50% to Treasury Main
                transaction.add(
                    SystemProgram.transfer({
                        fromPubkey: new PublicKey(walletAddress),
                        toPubkey: new PublicKey(TREASURY_MAIN),
                        lamports: Math.floor(priceSOL * 1e9 * 0.50)
                    })
                );
                
                // Transfer 2: 30% to Treasury Liquidity
                transaction.add(
                    SystemProgram.transfer({
                        fromPubkey: new PublicKey(walletAddress),
                        toPubkey: new PublicKey(TREASURY_LIQUIDITY),
                        lamports: Math.floor(priceSOL * 1e9 * 0.30)
                    })
                );
                
                // Transfer 3: 20% to Treasury Team
                transaction.add(
                    SystemProgram.transfer({
                        fromPubkey: new PublicKey(walletAddress),
                        toPubkey: new PublicKey(TREASURY_TEAM),
                        lamports: Math.floor(priceSOL * 1e9 * 0.20)
                    })
                );
                
                // Get recent blockhash and set fee payer
                const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash('confirmed');
                transaction.recentBlockhash = blockhash;
                transaction.lastValidBlockHeight = lastValidBlockHeight;
                transaction.feePayer = new PublicKey(walletAddress);
                
                console.log('üí∞ Creating SOL distribution transaction...');
                console.log(`  üè¶ Treasury Main: ${(priceSOL * 0.50).toFixed(6)} SOL (50%)`);
                console.log(`  üíß Treasury Liquidity: ${(priceSOL * 0.30).toFixed(6)} SOL (30%)`);
                console.log(`  üë• Treasury Team: ${(priceSOL * 0.20).toFixed(6)} SOL (20%)`);
                
                // Request signature from Phantom
                const signed = await window.solana.signAndSendTransaction(transaction);
                
                // Wait for confirmation
                await connection.confirmTransaction(signed, 'confirmed');
                
                // Extract signature from response (Phantom returns {signature: '...', publicKey: '...'})
                const signature = typeof signed === 'string' ? signed : (signed.signature || signed);
                
                console.log('‚úÖ SOL distribution transaction confirmed:', signature);
                const explorerUrl = `https://explorer.solana.com/tx/${signature}?cluster=devnet`;
                console.log(`üîó View on Explorer: ${explorerUrl}`);
                
                return signature;
                
            } catch (err) {
                console.error('‚ùå Distribution transaction failed:', err);
                throw new Error('Failed to create distribution transaction: ' + err.message);
            }
        }

        // ==============================================
        // MINT FUNCTIONS
        // ==============================================
        // Prevent double-click / double-call protection
        let isMintingBronze = false;
        
        async function mintBronze() {
            // üõ°Ô∏è PROTECTION: Prevent double-call
            if (isMintingBronze) {
                console.warn('‚ö†Ô∏è Mint already in progress, ignoring duplicate call');
                return;
            }
            
            try {
                isMintingBronze = true;
                console.log('üü´ Minting Bronze NFT...');

                // Check if user came from game (has telegram_id OR wallet with activity)
                let userHasPlayed = false;
                let userIdentifier = null;
                
                if (WALLET_ADDRESS && isWalletUser) {
                    // Check if wallet user has played (clicks > 0)
                    const { data: walletData, error: walletError } = await supabase
                        .from('wallet_users')
                        .select('clicks, tama_balance')
                        .eq('wallet_address', WALLET_ADDRESS)
                        .single();
                    
                    if (walletError || !walletData) {
                        showNotification('warning', 'Game Required', 
                            'To mint with TAMA, you need to play the game first!\n\n' +
                            'üéÆ Play the game in browser\n' +
                            'üí∞ Earn TAMA tokens by clicking\n' +
                            'üîó Then come back here to mint NFT\n\n' +
                            'üí° Or mint with SOL instead (no game required)!'
                        );
                        return;
                    }
                    
                    // Check if user has activity (clicks > 0)
                    if (walletData.clicks > 0) {
                        userHasPlayed = true;
                        userIdentifier = 'wallet';
                    } else {
                        showNotification('warning', 'Game Required', 
                            'To mint with TAMA, you need to play the game first!\n\n' +
                            'üéÆ Play the game in browser (click your pet!)\n' +
                            'üí∞ Earn TAMA tokens\n' +
                            'üîó Then come back here to mint NFT\n\n' +
                            'üí° Or mint with SOL instead (no game required)!'
                        );
                        return;
                    }
                } else if (TELEGRAM_USER_ID && TELEGRAM_USER_ID !== 123456789) {
                    userHasPlayed = true;
                    userIdentifier = 'telegram';
                }
                
                if (!userHasPlayed) {
                    showNotification('warning', 'Game Required', 
                        'To mint with TAMA, you need to play the game first!\n\n' +
                        'üéÆ Go to Telegram bot and play the game\n' +
                        'üí∞ Earn TAMA tokens\n' +
                        'üîó Then come back here to mint NFT\n\n' +
                        'üí° Or mint with SOL instead (no game required)!'
                    );
                    return;
                }

                // Check TAMA balance
                if (tamaBalance < 5000) {
                    showNotification('error', 'Insufficient Balance', `You need 5,000 TAMA to mint Bronze NFT.\n\nYour balance: ${tamaBalance.toLocaleString()} TAMA`);
                    return;
                }

                // Custom confirmation modal
                const confirmed = await showConfirmModal(
                    'Mint Bronze NFT',
                    'Mint Bronze NFT for 5,000 TAMA?\n\nYou will get √ó2.0 earning boost!'
                );
                
                if (!confirmed) {
                    return;
                }

                // Show loading with progress indicator
                showLoadingProgress('üé® Minting Bronze NFT...', 'Please wait, this may take 30-60 seconds');

                // ============================================
                // DIRECT SUPABASE APPROACH (bypasses PHP API)
                // ============================================
                updateLoadingProgress('üí∞ Checking TAMA balance...');
                
                let currentTama = 0;
                let newTama = 0;
                
                if (userIdentifier === 'wallet' && WALLET_ADDRESS) {
                    // Wallet user: use wallet_users table
                    console.log('üìä Checking balance from wallet_users...');
                    
                    const { data: walletData, error: walletError } = await supabase
                        .from('wallet_users')
                        .select('tama_balance')
                        .eq('wallet_address', WALLET_ADDRESS)
                        .single();
                    
                    if (walletError || !walletData) {
                        throw new Error('Could not fetch TAMA balance. Please try again.');
                    }
                    
                    currentTama = parseFloat(walletData.tama_balance) || 0;
                    if (currentTama < 5000) {
                        throw new Error(`Insufficient TAMA balance. You have ${currentTama}, need 5000.`);
                    }
                    
                    console.log('üí∞ Current TAMA balance:', currentTama);
                    
                    // Deduct 5000 TAMA from wallet_users
                    updateLoadingProgress('üí≥ Deducting 5000 TAMA...');
                    newTama = currentTama - 5000;
                    const { error: updateError } = await supabase
                        .from('wallet_users')
                        .update({ tama_balance: newTama })
                        .eq('wallet_address', WALLET_ADDRESS);
                    
                    if (updateError) {
                        throw new Error('Failed to deduct TAMA: ' + updateError.message);
                    }
                    
                    console.log('‚úÖ Deducted 5000 TAMA, new balance:', newTama);
                } else if (userIdentifier === 'telegram' && TELEGRAM_USER_ID) {
                    // Telegram user: use leaderboard table
                    console.log('üìä Checking balance from leaderboard...');
                    
                    const { data: leaderboardData, error: leaderboardError } = await supabase
                        .from('leaderboard')
                        .select('tama')
                        .eq('telegram_id', Number(TELEGRAM_USER_ID))
                        .single();
                    
                    if (leaderboardError || !leaderboardData) {
                        throw new Error('Could not fetch TAMA balance. Please try again.');
                    }
                    
                    currentTama = leaderboardData.tama || 0;
                    if (currentTama < 5000) {
                        throw new Error(`Insufficient TAMA balance. You have ${currentTama}, need 5000.`);
                    }
                    
                    console.log('üí∞ Current TAMA balance:', currentTama);
                    
                    // Deduct 5000 TAMA from leaderboard
                    updateLoadingProgress('üí≥ Deducting 5000 TAMA...');
                    newTama = currentTama - 5000;
                    const { error: updateError } = await supabase
                        .from('leaderboard')
                        .update({ tama: newTama })
                        .eq('telegram_id', Number(TELEGRAM_USER_ID));
                    
                    if (updateError) {
                        throw new Error('Failed to deduct TAMA: ' + updateError.message);
                    }
                    
                    console.log('‚úÖ Deducted 5000 TAMA, new balance:', newTama);
                } else {
                    throw new Error('Invalid user identifier');
                }
                
                // Mark balance as modified to force API fetch on next loadTAMABalance()
                balanceModified = true;
                
                // ============================================
                // üí∞ TAMA DISTRIBUTION (40% Burn / 30% Treasury / 30% P2E Pool)
                // ============================================
                updateLoadingProgress('üî• Processing TAMA distribution...');
                
                const TAMA_AMOUNT = 5000;
                const burnAmount = Math.floor(TAMA_AMOUNT * 0.40);      // 2000 TAMA
                const treasuryAmount = Math.floor(TAMA_AMOUNT * 0.30);  // 1500 TAMA
                const poolAmount = Math.floor(TAMA_AMOUNT * 0.30);      // 1500 TAMA
                
                console.log('üí∞ TAMA Distribution:');
                console.log(`  üî• Burn: ${burnAmount} TAMA (40%)`);
                console.log(`  üíé Treasury: ${treasuryAmount} TAMA (30%)`);
                console.log(`  üéÆ P2E Pool: ${poolAmount} TAMA (30%)`);
                
                // Store transaction IDs for later signature updates
                let burnTransactionId = null;
                let treasuryTransactionId = null;
                
                try {
                    // 1. Record BURN transaction
                    // Save transaction ID for later signature update
                    const { data: burnTx, error: burnTxError } = await mintSupabase.from('transactions').insert({
                        user_id: 'SYSTEM_BURN',
                        type: 'tama_burn',
                        amount: burnAmount,
                        metadata: {
                            reason: 'nft_mint_bronze',
                            from_user: String(TELEGRAM_USER_ID),
                            burn_percentage: 40,
                            onchain_signature: null // Will be updated after on-chain transfer
                        }
                    }).select('id').single();
                    
                    if (!burnTxError && burnTx) {
                        burnTransactionId = burnTx.id;
                    }
                    console.log('‚úÖ Burn transaction recorded', burnTransactionId ? `(ID: ${burnTransactionId})` : '');
                    
                    // 2. Add TAMA to Treasury (use wallet address as ID)
                    const TREASURY_MAIN = '6rY5inYo8JmDTj91UwMKLr1MyxyAAQGjLpJhSi6dNpFM';
                    const { data: treasuryData } = await supabase
                        .from('leaderboard')
                        .select('tama')
                        .eq('wallet_address', TREASURY_MAIN)
                        .single();
                    
                    if (treasuryData) {
                        // Update existing treasury balance
                        await mintSupabase.from('leaderboard').update({
                            tama: (treasuryData.tama || 0) + treasuryAmount
                        }).eq('wallet_address', TREASURY_MAIN);
                    } else {
                        // Create treasury account
                        await mintSupabase.from('leaderboard').insert({
                            telegram_id: '999999999',
                            telegram_username: 'Treasury',
                            wallet_address: TREASURY_MAIN,
                            tama: treasuryAmount,
                            level: 1,
                            xp: 0
                        });
                    }
                    console.log('‚úÖ Treasury TAMA added');
                    
                    // 2.1. Record Treasury transaction (save ID for later signature update)
                    let treasuryTransactionId = null;
                    try {
                        const { data: treasuryTx, error: treasuryTxError } = await mintSupabase.from('transactions').insert({
                            user_id: TREASURY_MAIN,
                            username: 'üí∞ Treasury Main V2',
                            type: 'treasury_income_from_nft',
                            amount: treasuryAmount, // ‚úÖ POSITIVE: Treasury receives TAMA
                            balance_before: treasuryData?.tama || 0,
                            balance_after: (treasuryData?.tama || 0) + treasuryAmount,
                            metadata: {
                                reason: 'nft_mint_bronze',
                                from_user: String(TELEGRAM_USER_ID),
                                tier: 'Bronze',
                                treasury_percentage: 30,
                                onchain_signature: null // Will be updated after on-chain transfer
                            }
                        }).select('id').single();
                        
                        if (!treasuryTxError && treasuryTx) {
                            treasuryTransactionId = treasuryTx.id;
                        }
                        console.log('‚úÖ Treasury transaction recorded', treasuryTransactionId ? `(ID: ${treasuryTransactionId})` : '');
                    } catch (treasuryTxError) {
                        console.warn('‚ö†Ô∏è Failed to record Treasury transaction:', treasuryTxError);
                    }
                    
                    // 3. Add TAMA to P2E Pool
                    const P2E_POOL = 'HPQf1MG8e41MoMayD8iqFmadqZ2NteScx4dQuwc1fCQw';
                    const { data: poolData } = await supabase
                        .from('leaderboard')
                        .select('tama')
                        .eq('wallet_address', P2E_POOL)
                        .single();
                    
                    if (poolData) {
                        // Update existing pool balance
                        await mintSupabase.from('leaderboard').update({
                            tama: (poolData.tama || 0) + poolAmount
                        }).eq('wallet_address', P2E_POOL);
                    } else {
                        // Create P2E Pool account
                        await mintSupabase.from('leaderboard').insert({
                            telegram_id: '888888888',
                            telegram_username: 'P2E_Pool',
                            wallet_address: P2E_POOL,
                            tama: poolAmount,
                            level: 1,
                            xp: 0
                        });
                    }
                    console.log('‚úÖ P2E Pool TAMA added');
                    
                    // 3.1. Record P2E Pool transaction
                    try {
                        await mintSupabase.from('transactions').insert({
                            user_id: P2E_POOL,
                            username: 'üéÆ P2E Pool',
                            type: 'p2e_pool_refund_from_nft',
                            amount: poolAmount, // ‚úÖ POSITIVE: P2E Pool receives TAMA
                            balance_before: poolData?.tama || 0,
                            balance_after: (poolData?.tama || 0) + poolAmount,
                            metadata: {
                                reason: 'nft_mint_bronze',
                                from_user: String(TELEGRAM_USER_ID),
                                tier: 'Bronze',
                                p2e_pool_percentage: 30,
                                note: 'TAMA remain in P2E Pool (no on-chain transfer)'
                            }
                        });
                        console.log('‚úÖ P2E Pool transaction recorded');
                    } catch (p2eTxError) {
                        console.warn('‚ö†Ô∏è Failed to record P2E Pool transaction:', p2eTxError);
                    }
                    
                } catch (distributionError) {
                    console.warn('‚ö†Ô∏è TAMA distribution error:', distributionError);
                    // Don't throw - not critical, mint can continue
                }
                
                // ============================================
                // üîó ON-CHAIN SPL TOKEN TRANSFERS (Real blockchain transactions!)
                // ============================================
                updateLoadingProgress('üîó Executing on-chain TAMA transfers...');
                
                let onchainTransfers = null;
                try {
                    const TREASURY_MAIN = '6rY5inYo8JmDTj91UwMKLr1MyxyAAQGjLpJhSi6dNpFM';
                    
                    const transferResponse = await fetch('https://solanatamagotchi-onchain.onrender.com/api/tama-transfer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            amount: TAMA_AMOUNT,
                            distributions: [
                                { to: 'BURN', amount: burnAmount, label: 'üî• Burn' },
                                { to: TREASURY_MAIN, amount: treasuryAmount, label: 'üíé Treasury' }
                                // P2E Pool: 1500 TAMA remain in P2E Pool (no transfer needed)
                            ]
                        })
                    });
                    
                    if (transferResponse.ok) {
                        const transferResult = await transferResponse.json();
                        console.log('‚úÖ On-chain TAMA transfers successful:', transferResult);
                        onchainTransfers = transferResult.transfers; // Save for transaction record
                        
                        // Helper function to update ANY transaction with signature
                        const updateTransactionSignature = async (userId, transactionType, signature, explorer) => {
                            try {
                                const { data: recentTx, error: selectError } = await supabase
                                    .from('transactions')
                                    .select('id')
                                    .eq('user_id', userId)
                                    .eq('type', transactionType)
                                    .order('created_at', { ascending: false })
                                    .limit(1)
                                    .single();
                                
                                if (selectError || !recentTx) {
                                    console.warn(`‚ö†Ô∏è ${transactionType} transaction not found for update:`, selectError);
                                    return;
                                }
                                
                                // Update via PHP API (has server-side permissions)
                                const response = await fetch('https://api.solanatamagotchi.com/api/update-transaction-signature.php', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        transaction_id: recentTx.id,
                                        signature: signature,
                                        explorer: explorer
                                    })
                                });
                                
                                const result = await response.json();
                                if (result.success) {
                                    console.log(`‚úÖ ${transactionType} updated with signature`);
                                } else {
                                    console.warn(`‚ö†Ô∏è Failed to update ${transactionType}:`, result.error);
                                }
                            } catch (err) {
                                console.warn(`‚ö†Ô∏è Error updating ${transactionType} signature:`, err);
                            }
                        };
                        
                        // Log each transfer signature and update database
                        if (transferResult.transfers) {
                            // Store signatures for later use
                            const signatures = {};
                            
                            transferResult.transfers.forEach(tx => {
                                console.log(`  ${tx.label}: ${tx.amount} TAMA`);
                                console.log(`  üìç Signature: ${tx.signature}`);
                                console.log(`  üîó ${tx.explorer}`);
                                
                                if (tx.label === 'üî• Burn' && tx.signature) {
                                    signatures.burn = { signature: tx.signature, explorer: tx.explorer };
                                }
                                
                                if (tx.label === 'üíé Treasury' && tx.signature) {
                                    signatures.treasury = { signature: tx.signature, explorer: tx.explorer };
                                }
                            });
                            
                            // Update transactions with signatures directly via Supabase (using saved IDs)
                            if (signatures.burn && burnTransactionId) {
                                try {
                                    const { data: burnTx } = await supabase
                                        .from('transactions')
                                        .select('metadata')
                                        .eq('id', burnTransactionId)
                                        .single();
                                    
                                    if (burnTx) {
                                        const metadata = typeof burnTx.metadata === 'string' ? JSON.parse(burnTx.metadata) : (burnTx.metadata || {});
                                        metadata.onchain_signature = signatures.burn.signature;
                                        metadata.transaction_signature = signatures.burn.signature;
                                        metadata.explorer = signatures.burn.explorer;
                                        
                                        const { error: updateError } = await supabase
                                            .from('transactions')
                                            .update({ metadata: metadata })
                                            .eq('id', burnTransactionId);
                                        
                                        if (!updateError) {
                                            console.log('‚úÖ Burn transaction updated with signature:', signatures.burn.signature);
                                        } else {
                                            console.warn('‚ö†Ô∏è Failed to update burn signature:', updateError);
                                        }
                                    }
                                } catch (e) {
                                    console.warn('‚ö†Ô∏è Error updating burn signature:', e);
                                }
                            }
                            
                            if (signatures.treasury && treasuryTransactionId) {
                                try {
                                    const { data: treasuryTx } = await supabase
                                        .from('transactions')
                                        .select('metadata')
                                        .eq('id', treasuryTransactionId)
                                        .single();
                                    
                                    if (treasuryTx) {
                                        const metadata = typeof treasuryTx.metadata === 'string' ? JSON.parse(treasuryTx.metadata) : (treasuryTx.metadata || {});
                                        metadata.onchain_signature = signatures.treasury.signature;
                                        metadata.transaction_signature = signatures.treasury.signature;
                                        metadata.explorer = signatures.treasury.explorer;
                                        
                                        const { error: updateError } = await supabase
                                            .from('transactions')
                                            .update({ metadata: metadata })
                                            .eq('id', treasuryTransactionId);
                                        
                                        if (!updateError) {
                                            console.log('‚úÖ Treasury transaction updated with signature:', signatures.treasury.signature);
                                        } else {
                                            console.warn('‚ö†Ô∏è Failed to update treasury signature:', updateError);
                                }
                                    }
                                } catch (e) {
                                    console.warn('‚ö†Ô∏è Error updating treasury signature:', e);
                                }
                            }
                        }
                        
                        // Show notification with explorer link
                        if (transferResult.transfers && transferResult.transfers.length > 0) {
                            const firstTx = transferResult.transfers[0];
                            // Convert from raw units (with decimals) to TAMA
                            const tamaAmount = (transferResult.total_transferred / 1e9).toLocaleString('en-US', { maximumFractionDigits: 2 });
                            showNotification('success', 'On-Chain Transfers Complete', 
                                `${tamaAmount} TAMA transferred on Solana blockchain`, 
                                firstTx.explorer);
                        }
                    } else {
                        const errorData = await transferResponse.json();
                        console.warn('‚ö†Ô∏è On-chain transfer failed:', errorData);
                        showNotification('warning', 'On-Chain Transfer Issue', 
                            'NFT minted, but some on-chain transfers may have failed. Check admin panel.');
                    }
                } catch (onchainError) {
                    console.error('‚ùå On-chain transfer error:', onchainError);
                    showNotification('warning', 'On-Chain Transfer Error', 
                        'NFT minted successfully, but on-chain transfers failed. Contact support.');
                }
                
                // ‚úÖ Record transaction with balance_after (for admin panel)
                // üõ°Ô∏è PROTECTION: Check for duplicate transaction first
                try {
                    const userId = userIdentifier === 'wallet' ? WALLET_USER_ID : String(TELEGRAM_USER_ID);
                    const transactionId = userIdentifier === 'wallet' 
                        ? `nft_mint_wallet_${WALLET_ADDRESS}_${Date.now()}`
                        : `nft_mint_${TELEGRAM_USER_ID}_${Date.now()}`;
                    
                    // Check if similar transaction exists in last 5 seconds (prevent duplicates)
                    const { data: recentTx } = await supabase
                        .from('transactions')
                        .select('id')
                        .eq('user_id', userId)
                        .eq('type', 'nft_mint_tama')
                        .gte('created_at', new Date(Date.now() - 5000).toISOString())
                        .limit(1);
                    
                    if (recentTx && recentTx.length > 0) {
                        console.warn('‚ö†Ô∏è Duplicate transaction detected, skipping insert');
                    } else {
                    const { error: txError } = await supabase
                        .from('transactions')
                        .insert({
                            user_id: userId,
                            type: 'nft_mint_tama',
                                amount: -5000, // ‚úÖ NEGATIVE: User SPENDS TAMA to mint NFT
                            balance_before: currentTama,
                            balance_after: newTama,
                            metadata: {
                                tier: 'Bronze',
                                rarity: 'Common',
                                payment_type: 'TAMA',
                                    transaction_id: transactionId, // Unique ID for deduplication
                                distribution: {
                                    burn: burnAmount,
                                    treasury: treasuryAmount,
                                    pool: poolAmount
                                },
                                onchain_transfers: onchainTransfers, // Include blockchain signatures
                                wallet_address: userIdentifier === 'wallet' ? WALLET_ADDRESS : null,
                                telegram_id: userIdentifier === 'telegram' ? TELEGRAM_USER_ID : null
                            }
                        });
                    
                    if (txError) {
                        console.warn('‚ö†Ô∏è Failed to record transaction:', txError);
                        // Don't throw - not critical
                    } else {
                        console.log('‚úÖ Transaction recorded with balance_after:', newTama);
                        }
                    }
                } catch (txRecordError) {
                    console.warn('‚ö†Ô∏è Transaction recording error:', txRecordError);
                    // Don't throw - not critical
                }
                
                // 3. Get random Bronze design (only unminted ones)
                updateLoadingProgress('üé® Selecting NFT design...');
                const { data: designs, error: designError } = await supabase
                    .from('nft_designs')
                    .select('*')
                    .eq('tier_name', 'Bronze')
                    .eq('is_minted', false);
                
                if (designError || !designs || designs.length === 0) {
                    // Rollback TAMA deduction
                    if (userIdentifier === 'wallet' && WALLET_ADDRESS) {
                        await mintSupabase.from('wallet_users').update({ tama_balance: currentTama }).eq('wallet_address', WALLET_ADDRESS);
                    } else if (userIdentifier === 'telegram' && TELEGRAM_USER_ID) {
                        await mintSupabase.from('leaderboard').update({ tama: currentTama }).eq('telegram_id', Number(TELEGRAM_USER_ID));
                    }
                    throw new Error('No Bronze NFT designs available');
                }
                
                const randomDesign = designs[Math.floor(Math.random() * designs.length)];
                console.log('üé® Selected design:', randomDesign);
                
                // 4. Create NFT record
                updateLoadingProgress('üíæ Creating NFT record...');
                let nftMintAddress;
                let nftData;
                
                if (userIdentifier === 'wallet' && WALLET_ADDRESS) {
                    // Wallet user: use direct INSERT (RPC function doesn't support wallet_address)
                    nftMintAddress = `bronze_wallet_${WALLET_ADDRESS.substring(0, 8)}_${Date.now()}_${randomDesign.id}`;
                    console.log('üîç Creating NFT for wallet user:', WALLET_ADDRESS);
                    
                    const { data: insertResult, error: nftError } = await supabase
                        .from('user_nfts')
                        .insert({
                            wallet_address: WALLET_ADDRESS,
                            telegram_id: null,
                            nft_design_id: randomDesign.id,
                            nft_mint_address: nftMintAddress,
                            tier_name: 'Bronze',
                            rarity: 'Common',
                            earning_multiplier: 2.0,
                            purchase_price_tama: 5000,
                            is_active: true
                        })
                        .select()
                        .single();
                    
                    if (nftError) {
                        console.error('‚ùå NFT creation error:', nftError);
                        // Rollback TAMA deduction
                        await supabase.from('wallet_users').update({ tama_balance: currentTama }).eq('wallet_address', WALLET_ADDRESS);
                        throw new Error('Failed to create NFT: ' + nftError.message);
                    }
                    
                    nftData = insertResult;
                    console.log('‚úÖ NFT created for wallet user:', nftData);
                } else if (userIdentifier === 'telegram' && TELEGRAM_USER_ID) {
                    // Telegram user: use RPC function
                    nftMintAddress = `bronze_${TELEGRAM_USER_ID}_${Date.now()}_${randomDesign.id}`;
                    
                    // CRITICAL: Send telegram_id as STRING to RPC function
                    // The RPC function accepts TEXT and casts to BIGINT internally
                    // This completely bypasses PostgREST's type conversion issues
                    const telegramIdString = String(TELEGRAM_USER_ID);
                    console.log('üîç Creating NFT with telegram_id as STRING:', telegramIdString, 'type:', typeof telegramIdString);
                    
                    // Use RPC function with TEXT parameter (bypasses PostgREST type conversion issues)
                    const { data: rpcResult, error: nftError } = await supabase.rpc('insert_user_nft', {
                        p_telegram_id: telegramIdString,  // Send as STRING, RPC function will cast to BIGINT
                        p_nft_design_id: randomDesign.id,
                        p_nft_mint_address: nftMintAddress,
                        p_tier_name: 'Bronze',
                        p_rarity: 'Common',
                        p_earning_multiplier: 2.0,
                        p_purchase_price_tama: 5000,
                        p_is_active: true
                    });
                    
                    // RPC function returns array
                    nftData = Array.isArray(rpcResult) && rpcResult.length > 0 ? rpcResult[0] : rpcResult;
                    
                    if (nftData) {
                        console.log('‚úÖ NFT created via RPC:', nftData);
                    }
                    
                    if (nftError) {
                        console.error('‚ùå NFT creation error:', nftError);
                        // Rollback TAMA deduction
                        await supabase.from('leaderboard').update({ tama: currentTama }).eq('telegram_id', Number(TELEGRAM_USER_ID));
                        throw new Error('Failed to create NFT: ' + nftError.message);
                    }
                    
                    console.log('‚úÖ NFT created:', nftData);
                } else {
                    throw new Error('Invalid user identifier for NFT creation');
                }
                
                // üî• NEW: Mint real on-chain NFT (same as SOL mint)
                if (nftData && nftData.id) {
                    updateLoadingProgress('üíé Creating on-chain NFT...');
                    console.log('üíé Starting on-chain NFT mint for Bronze TAMA purchase...');
                    
                    try {
                        // Determine backend URL
                        const onchainApiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                            ? 'http://localhost:3001/api/mint-nft-onchain'
                            : 'https://api.solanatamagotchi.com/api/mint-nft-onchain';
                        
                        updateLoadingProgress('üåê Uploading metadata to blockchain...');
                        console.log('üì° Calling on-chain mint API:', onchainApiUrl);
                        
                        const onchainResponse = await fetch(onchainApiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                nft_id: nftData.id,
                                tier: 'Bronze',
                                rarity: 'Common',
                                design_number: randomDesign.design_number,
                                imageUrl: getNFTImageUrl('Bronze', 'Common')
                            })
                        });
                        
                        if (!onchainResponse.ok) {
                            throw new Error(`HTTP error! status: ${onchainResponse.status}`);
                        }
                        
                        const onchainResult = await onchainResponse.json();
                        
                        if (onchainResult.success && onchainResult.mintAddress) {
                            updateLoadingProgress('üéâ On-chain NFT created!');
                            console.log('‚úÖ On-chain NFT minted successfully!');
                            console.log('üìç Mint Address:', onchainResult.mintAddress);
                            console.log('üîó Explorer:', `https://explorer.solana.com/address/${onchainResult.mintAddress}?cluster=devnet`);
                        } else {
                            updateLoadingProgress('‚ö†Ô∏è On-chain mint failed, but NFT is saved');
                            console.error('‚ùå On-chain mint failed:', onchainResult.error);
                            // Don't throw - database record is already created
                            // User will see "Off-Chain Only" badge but NFT is still functional
                        }
                    } catch (onchainError) {
                        updateLoadingProgress('‚ö†Ô∏è On-chain mint error, but NFT is saved');
                        console.error('‚ùå On-chain mint error:', onchainError);
                        // Don't throw - database record is already created
                        // User will see "Off-Chain Only" badge but NFT is still functional
                    }
                }
                
                // 5. Mark design as minted
                const { error: markMintedError } = await supabase
                    .from('nft_designs')
                    .update({
                        is_minted: true,
                        minted_by: Number(TELEGRAM_USER_ID),
                        minted_at: new Date().toISOString()
                    })
                    .eq('id', randomDesign.id);
                
                if (markMintedError) {
                    console.warn('‚ö†Ô∏è Failed to mark design as minted:', markMintedError);
                    // Don't throw - NFT is already created, this is just metadata
                } else {
                    console.log('‚úÖ Design marked as minted');
                }
                
                // 6. Update bonding state minted_count
                console.log('üìä Updating bonding state minted_count...');
                const { data: bondingData, error: bondingError } = await supabase
                    .from('nft_bonding_state')
                    .select('minted_count')
                    .eq('tier_name', 'Bronze')
                    .eq('payment_type', 'TAMA')
                    .single();
                
                if (bondingError) {
                    console.warn('‚ö†Ô∏è Failed to get bonding state:', bondingError);
                } else {
                    const currentMinted = bondingData.minted_count || 0;
                    const { error: updateBondingError } = await supabase
                        .from('nft_bonding_state')
                        .update({ minted_count: currentMinted + 1 })
                        .eq('tier_name', 'Bronze')
                        .eq('payment_type', 'TAMA');
                    
                    if (updateBondingError) {
                        console.warn('‚ö†Ô∏è Failed to update bonding state:', updateBondingError);
                    } else {
                        console.log(`‚úÖ Bonding state updated: minted_count = ${currentMinted + 1}`);
                    }
                }

                // Remove loading
                updateLoadingProgress('‚úÖ NFT minted successfully!');
                setTimeout(() => {
                    hideLoadingProgress();
                    showNotification('success', 'üéâ NFT Minted!', 
                        `Bronze NFT minted successfully!\n\n` +
                        `Design: #${randomDesign.design_number}\n` +
                        `Boost: √ó2.0\n` +
                        `Theme: ${randomDesign.design_theme}\n` +
                        `Variant: ${randomDesign.design_variant}`
                    );
                }, 1000);
                
                // Reload prices & balance
                await loadPricesAndStats();
                await loadTAMABalance();
                
                // Reset flag on success
                isMintingBronze = false;

            } catch (err) {
                console.error('‚ùå Mint Bronze failed:', err);
                hideLoadingProgress();
                showNotification('error', 'Mint Failed', err.message || 'Failed to mint Bronze NFT. Please try again.');
                
                // Reset flag on error
                isMintingBronze = false;
            }
        }

        async function mintBronzeSOL() {
            try {
                console.log('‚ö° Minting Bronze NFT (SOL Express)...');

                if (!walletConnected) {
                    showNotification('warning', 'Wallet Required', 'Please connect your wallet first to mint with SOL!');
                    return;
                }

                // Fixed price: 0.15 SOL
                const bronzeSolPrice = 0.15;
                const priceUSD = (bronzeSolPrice * SOL_USD_RATE).toFixed(2);

                // Custom confirmation modal
                const confirmed = await showConfirmModal(
                    'Mint Bronze NFT (Express)',
                    `Mint Bronze NFT (Express) for ${bronzeSolPrice} SOL ($${priceUSD})?\n\n‚ö° Skip the wait - instant mint!\n‚úÖ Same √ó2.0 boost as TAMA version\nüíé Fixed price - no FOMO stress!\nüéÅ +50 TAMA passive income daily!`
                );
                
                if (!confirmed) {
                    return;
                }

                // Show loading
                const spinner = document.createElement('div');
                spinner.className = 'spinner';
                spinner.id = 'loading-spinner';
                document.querySelector('.container').appendChild(spinner);

                // Create and send SOL distribution transaction
                let transactionSignature = null;
                try {
                    transactionSignature = await createAndSendDistributionTransaction(bronzeSolPrice);
                    console.log('‚úÖ Distribution transaction completed:', transactionSignature);
                } catch (distError) {
                    console.error('‚ö†Ô∏è Distribution transaction failed, but continuing with mint:', distError);
                    // Continue with mint even if distribution fails (user can manually distribute later)
                }

                // Call API - use absolute path for GitHub Pages (REST API version)
                const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'api/mint-nft-bronze-sol-rest.php'
                    : 'https://api.solanatamagotchi.com/api/mint-nft-bronze-sol-rest.php';
                
                console.log('üì° Calling API:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_id: (TELEGRAM_USER_ID && TELEGRAM_USER_ID !== 123456789) ? TELEGRAM_USER_ID : null, // Send null if no real telegram_id
                        wallet_address: walletAddress,
                        price_sol: bronzeSolPrice,
                        transaction_signature: transactionSignature // ‚úÖ Send transaction signature!
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', response.status, errorText);
                    throw new Error(`API error: ${response.status} - ${errorText.substring(0, 100)}`);
                }

                const result = await response.json();

                // Remove loading
                document.getElementById('loading-spinner')?.remove();

                if (result.success) {
                    let message = `Bronze NFT #${result.design_number} minted!\n\n` +
                        `Boost: √ó2.0 earning\n` +
                        `Passive: +50 TAMA/day\n` +
                        `Price: ${result.price_sol} SOL ($${(result.price_sol * SOL_USD_RATE).toFixed(2)})\n` +
                        `Theme: ${result.design_theme}\n` +
                        `Variant: ${result.design_variant}\n\n` +
                        `üíé Fixed price - always 0.15 SOL!`;
                    
                    let explorerLink = null;
                    if (result.distribution_logged && transactionSignature) {
                        message += `\n\nüí∞ SOL Distribution logged!`;
                        explorerLink = `https://explorer.solana.com/tx/${transactionSignature}?cluster=devnet`;
                    }
                    
                    showNotification('success', 'üéâ Express Mint Success!', message, explorerLink);
                    
                    // üíé Mint on-chain NFT (same as other tiers)
                    if (result.nft_id) {
                        // Show loading modal
                        showLoadingProgress(
                            '‚è≥ Creating On-Chain NFT...',
                            'Your Bronze NFT is being created on Solana blockchain.\n\nThis may take 30-60 seconds...'
                        );
                        
                        // Update progress steps
                        const stepsDiv = document.getElementById('progress-steps');
                        if (stepsDiv) {
                            stepsDiv.innerHTML = `
                                ‚è≥ Uploading metadata to Arweave...<br>
                                ‚è≥ Minting NFT on blockchain...<br>
                                ‚è≥ Please wait...
                            `;
                        }
                        
                        mintOnChainNFTAsync({
                            nft_id: result.nft_id,
                            tier: 'Bronze',
                            rarity: result.rarity || 'Common',
                            multiplier: 2.0,
                            design_number: result.design_number,
                            telegram_id: TELEGRAM_USER_ID,
                            wallet_address: walletAddress
                        }).catch(err => {
                            console.warn('‚ö†Ô∏è On-chain mint failed (non-critical):', err);
                            // Don't show error to user - off-chain NFT already works
                            // Close progress modal
                            document.getElementById('progress-modal')?.remove();
                        });
                    }
                    
                    // Reload prices & balance
                    await loadPricesAndStats();
                    await loadTAMABalance(); // Update TAMA balance (might have passive income)
                } else {
                    showNotification('error', 'Mint Failed', result.error || 'Unknown error occurred');
                }

            } catch (err) {
                console.error('‚ùå Mint Bronze SOL failed:', err);
                showNotification('error', 'Mint Failed', err.message || 'Failed to mint Bronze NFT (SOL). Please try again.');
                document.getElementById('loading-spinner')?.remove();
            }
        }

        async function mintSOL(tierName) {
            try {
                console.log(`üíé Minting ${tierName} NFT...`);

                if (!walletConnected) {
                    showNotification('warning', 'Wallet Required', 'Please connect your wallet first to mint with SOL!');
                    return;
                }
                
                // For SOL minting, telegram_id is optional (can create temporary player)
                // But show info if no telegram_id
                if (!TELEGRAM_USER_ID || TELEGRAM_USER_ID === 123456789) {
                    const confirmed = await showConfirmModal(
                        'Direct Mint (No Game Account)',
                        'You are minting without a game account.\n\n' +
                        '‚úÖ NFT will be minted successfully\n' +
                        'üíæ Wallet address will be saved\n' +
                        'üîó Later you can link this wallet to your Telegram account via bot\n\n' +
                        'Continue with mint?'
                    );
                    if (!confirmed) {
                        return;
                    }
                }

                // Get current price
                const { data: tierData, error } = await supabase
                    .from('nft_bonding_state')
                    .select('current_price')
                    .eq('tier_name', tierName)
                    .single();

                if (error || !tierData) {
                    showNotification('error', 'Price Error', 'Failed to get current price. Please refresh and try again.');
                    return;
                }

                const price = parseFloat(tierData.current_price);
                const priceUSD = (price * SOL_USD_RATE).toFixed(2);

                const boostMap = {
                    'Silver': 2.3,
                    'Gold': 2.7,
                    'Platinum': 3.5,
                    'Diamond': 5.0
                };

                // Custom confirmation modal
                const confirmed = await showConfirmModal(
                    `Mint ${tierName} NFT`,
                    `Mint ${tierName} NFT for ${price} SOL ($${priceUSD})?\n\nYou will get √ó${boostMap[tierName]} earning boost!`
                );
                
                if (!confirmed) {
                    return;
                }

                // Show loading
                const spinner = document.createElement('div');
                spinner.className = 'spinner';
                spinner.id = 'loading-spinner';
                document.querySelector('.container').appendChild(spinner);

                // Create and send SOL distribution transaction
                let transactionSignature = null;
                try {
                    transactionSignature = await createAndSendDistributionTransaction(price);
                    console.log('‚úÖ Distribution transaction completed:', transactionSignature);
                } catch (distError) {
                    console.error('‚ö†Ô∏è Distribution transaction failed, but continuing with mint:', distError);
                    // Continue with mint even if distribution fails (user can manually distribute later)
                }

                // Call API - use absolute path for GitHub Pages (REST API version)
                const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'api/mint-nft-sol-rest.php'
                    : 'https://api.solanatamagotchi.com/api/mint-nft-sol-rest.php';
                
                console.log('üì° Calling API:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_id: (TELEGRAM_USER_ID && TELEGRAM_USER_ID !== 123456789) ? TELEGRAM_USER_ID : null, // Send null if no real telegram_id
                        wallet_address: walletAddress,
                        tier_name: tierName,
                        price_sol: price,
                        transaction_signature: transactionSignature // ‚úÖ Send transaction signature!
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', response.status, errorText);
                    throw new Error(`API error: ${response.status} - ${errorText.substring(0, 100)}`);
                }

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('‚ùå API returned non-JSON:', text.substring(0, 500));
                    throw new Error(`API returned HTML instead of JSON. Status: ${response.status}. Check server logs.`);
                }

                const result = await response.json();

                // Remove loading
                document.getElementById('loading-spinner')?.remove();

                if (result.success) {
                    let message = `${tierName} NFT #${result.design_number} minted!\n\n` +
                        `Boost: √ó${boostMap[tierName]}\n` +
                        `Price: ${price} SOL\n` +
                        `Theme: ${result.design_theme}\n` +
                        `Variant: ${result.design_variant}`;
                    
                    let explorerLink = null;
                    if (result.distribution_logged && transactionSignature) {
                        message += `\n\nüí∞ SOL Distribution logged!`;
                        explorerLink = `https://explorer.solana.com/tx/${transactionSignature}?cluster=devnet`;
                    }
                    
                    showNotification('success', `üéâ ${tierName} NFT Minted!`, message, explorerLink);
                    
                    // üíé Mint on-chain NFT (async, don't block UI)
                    if (result.nft_id) {
                        // Show loading modal (same as Bronze)
                        showLoadingProgress(
                            '‚è≥ Creating On-Chain NFT...',
                            `Your ${tierName} NFT is being created on Solana blockchain.\n\nThis may take 30-60 seconds...`
                        );
                        
                        // Update progress steps
                        const stepsDiv = document.getElementById('progress-steps');
                        if (stepsDiv) {
                            stepsDiv.innerHTML = `
                                ‚è≥ Uploading metadata to Arweave...<br>
                                ‚è≥ Minting NFT on blockchain...<br>
                                ‚è≥ Please wait...
                            `;
                        }
                        
                        mintOnChainNFTAsync({
                            nft_id: result.nft_id,
                            tier: tierName,
                            rarity: result.rarity,
                            multiplier: result.earning_multiplier,
                            design_number: result.design_number,
                            telegram_id: TELEGRAM_USER_ID,
                            wallet_address: walletAddress
                        }).catch(err => {
                            console.warn('‚ö†Ô∏è On-chain mint failed (non-critical):', err);
                            // Don't show error to user - off-chain NFT already works
                            // Close progress modal
                            document.getElementById('progress-modal')?.remove();
                        });
                    }
                    
                    // Reload prices and balance (balance might have changed)
                    await loadPricesAndStats();
                    await loadTAMABalance(); // Update TAMA balance after mint
                } else {
                    showNotification('error', 'Mint Failed', result.error || 'Unknown error occurred');
                }

            } catch (err) {
                console.error(`‚ùå Mint ${tierName} failed:`, err);
                const errorMsg = err.message || 'Unknown error';
                showNotification('error', 'Mint Failed', `Failed to mint ${tierName} NFT!\n\n${errorMsg}`);
                document.getElementById('loading-spinner')?.remove();
            }
        }

        // ==============================================
        // ON-CHAIN NFT MINTING
        // ==============================================
            async function mintOnChainNFTAsync({ nft_id, tier, rarity, multiplier, design_number, telegram_id, wallet_address }) {
                try {
                    console.log('üíé Starting on-chain NFT mint...', { nft_id, tier, rarity });
                    
                    // Get NFT image URL
                    const imageUrl = getNFTImageUrl(tier, rarity);
                    
                    // Determine backend URL
                    const onchainApiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                        ? 'http://localhost:3001/api/mint-nft-onchain'
                        : 'https://api.solanatamagotchi.com/api/mint-nft-onchain';
                    
                    console.log('üì° Calling on-chain mint API:', onchainApiUrl);
                    
                    // Create AbortController for timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minutes timeout
                    
                    try {
                        const response = await fetch(onchainApiUrl, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                nft_id: nft_id,
                                tier: tier,
                                rarity: rarity,
                                multiplier: multiplier,
                                imageUrl: imageUrl,
                                telegramId: telegram_id,
                                walletAddress: wallet_address,
                                design_number: design_number
                            }),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMessage = `On-chain mint API error: ${response.status}`;
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMessage = errorJson.error || errorMessage;
                        } catch (e) {
                            errorMessage += ' - ' + errorText.substring(0, 200);
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const onchainResult = await response.json();
                    
                    if (onchainResult.success) {
                        console.log('‚úÖ On-chain NFT minted successfully!');
                        console.log('üìç Mint Address:', onchainResult.mintAddress);
                        console.log('üîó Explorer:', onchainResult.explorerUrl);
                        
                        // Close progress modal
                        document.getElementById('progress-modal')?.remove();
                        
                        // Show success notification
                        showNotification('success', 'üé® On-Chain NFT Minted!', 
                            `Your ${tier} NFT is now on Solana blockchain!\n\n` +
                            `Mint Address: ${onchainResult.mintAddress.substring(0, 8)}...${onchainResult.mintAddress.substring(onchainResult.mintAddress.length - 8)}\n\n` +
                            `‚úÖ View in Phantom Wallet or Solana Explorer!`,
                            onchainResult.explorerUrl
                        );
                    } else {
                        // Close progress modal on error
                        document.getElementById('progress-modal')?.remove();
                        throw new Error(onchainResult.error || 'On-chain mint failed');
                    }
                    
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        if (fetchError.name === 'AbortError') {
                            throw new Error('On-chain mint request timed out (took longer than 2 minutes). The NFT may still be processing on the server.');
                        }
                        throw fetchError;
                    }
                } catch (error) {
                    console.error('‚ùå On-chain mint error:', error);
                    // Show warning but don't block - off-chain NFT already works
                    let errorMessage = 'On-chain mint failed (non-critical). Off-chain NFT is still valid!';
                    
                    if (error.message && error.message.includes('CORS')) {
                        errorMessage = 'On-chain minting is not available on production yet. Off-chain NFT is still valid!';
                    } else if (error.message && error.message.includes('timeout')) {
                        errorMessage = 'On-chain mint is taking longer than expected. The NFT may still be processing on the server. Off-chain NFT is still valid!';
                    } else if (error.message && error.message.includes('Insufficient SOL')) {
                        errorMessage = 'On-chain mint failed: Server needs SOL for Arweave storage. Off-chain NFT is still valid!';
                    } else if (error.message && error.message.includes('funding')) {
                        errorMessage = 'On-chain mint failed: Server needs SOL for Arweave storage. Off-chain NFT is still valid!';
                    }
                    
                    // Show notification to user
                    showNotification('warning', '‚ö†Ô∏è On-Chain Mint Delayed', errorMessage);
                    
                    console.warn('‚ö†Ô∏è', errorMessage);
                    console.warn('Error details:', error.message);
                    // Don't throw - off-chain NFT already works
                }
            }
        
        // Helper function to get NFT image URL
        function getNFTImageUrl(tier, rarity) {
            // üé® NFT Images stored on IPFS via Lighthouse Storage
            // Uploaded: 2025-11-21
            // See nft-assets/ipfs-urls.json for all URLs
            
            const NFT_IMAGES = {
                bronze: {
                    common: 'https://gateway.lighthouse.storage/ipfs/bafkreidvxzsnozwpgjqbydcncpumcgk3aqmr3evxhqjmf6ibzmrmuv565i',
                    uncommon: 'https://gateway.lighthouse.storage/ipfs/bafkreibnoiown4k6dyhxvv642ep6av6xwkgtqvusrhhn7l4janrgfjixbq',
                    rare: 'https://gateway.lighthouse.storage/ipfs/bafkreia7mldvzaw52wvz42od4xdj7asw2fqc7gba7zhdbpfg3d6z3byl5y',
                    epic: 'https://gateway.lighthouse.storage/ipfs/bafkreiefw2xgoo5w37jkpd6etgr6eurgu7z64tsb7e6bhbbqa5z3qidbbq',
                    legendary: 'https://gateway.lighthouse.storage/ipfs/bafkreidvxzsnozwpgjqbydcncpumcgk3aqmr3evxhqjmf6ibzmrmuv565i' // TODO: Upload real Legendary image
                },
                silver: {
                    uncommon: 'https://gateway.lighthouse.storage/ipfs/bafkreibp7zxf6fqilehacookucnyhzbqkvaqqbuk3jel7irsa2dzzvnw2a',
                    rare: 'https://gateway.lighthouse.storage/ipfs/bafkreidnwtfwftmcsexgmf6p5qn5jorgwmtl4w2jegyyo7gnynvq2qe334',
                    epic: 'https://gateway.lighthouse.storage/ipfs/bafkreifkxigyyudtynmn4ffmt2gx7getqs3jfzy2nqdjrzaplpelf3tozq',
                    legendary: 'https://gateway.lighthouse.storage/ipfs/bafkreigywjdjw3vxopv4blicqioyx5fyqpwcvs22s2ea377rofvh2sslnm'
                },
                gold: {
                    common: 'https://gateway.lighthouse.storage/ipfs/bafkreicywzvyse3immuhakmd4dvv22gxsikmzhn4q7cjkmzjpp7253ftse',
                    uncommon: 'https://gateway.lighthouse.storage/ipfs/bafkreibp7zxf6fqilehacookucnyhzbqkvaqqbuk3jel7irsa2dzzvnw2a',
                    rare: 'https://gateway.lighthouse.storage/ipfs/bafkreidnwtfwftmcsexgmf6p5qn5jorgwmtl4w2jegyyo7gnynvq2qe334',
                    epic: 'https://gateway.lighthouse.storage/ipfs/bafkreifkxigyyudtynmn4ffmt2gx7getqs3jfzy2nqdjrzaplpelf3tozq'
                },
                platinum: {
                    rare: 'https://gateway.lighthouse.storage/ipfs/bafkreib72mfqqs5qa3g7asjy4jtoiorxpok3bniknisqznf572haifakcq',
                    epic: 'https://gateway.lighthouse.storage/ipfs/bafkreiell36dnbe5oomfigv6yxk65rkbj2eo62t6ihrprbyqbomjraobo4',
                    legendary: 'https://gateway.lighthouse.storage/ipfs/bafkreihrwin3ld34uner7rpwggke2pfnn5beb3eyrw7vrjmw6n5hen5hie'
                },
                diamond: {
                    rare: 'https://gateway.lighthouse.storage/ipfs/bafkreigflr4x4xczfyl7gavdmaos7uupi73xm2yainwl2tlfn3nabqpsly',
                    epic: 'https://gateway.lighthouse.storage/ipfs/bafkreib3la6mkyzjtethphozhsuccp6b4x63dilrz6rsb4tsjvqdxdl5pq',
                    legendary: 'https://gateway.lighthouse.storage/ipfs/bafkreidtqr62aeflchsghhdoo4m7tv33j7za5w3ttzqziwkl4u4cmgz7tq'
                }
            };
            
            // Fallback to placeholder if image not found
            const imageUrl = NFT_IMAGES[tier.toLowerCase()]?.[rarity.toLowerCase()];
            if (imageUrl) {
                return imageUrl;
            }
            
            // Fallback placeholder
            const tierColors = {
                bronze: 'CD7F32',
                silver: 'C0C0C0',
                gold: 'FFD700',
                platinum: 'E5E4E2',
                diamond: '00BFFF'
            };
            const tierEmojis = {
                bronze: 'ü•â',
                silver: 'ü•à',
                gold: 'ü•á',
                platinum: 'üíé',
                diamond: 'üí†'
            };
            const color = tierColors[tier.toLowerCase()] || 'CCCCCC';
            const emoji = tierEmojis[tier.toLowerCase()] || 'üéÆ';
            const text = `${emoji}+${tier}+${rarity}`;
            return `https://via.placeholder.com/1000x1000/${color}/FFFFFF?text=${encodeURIComponent(text)}`;
        }
        
        // ==============================================
        // CUSTOM CONFIRMATION MODAL
        // ==============================================
        function showConfirmModal(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const okBtn = document.getElementById('confirm-ok');
                const cancelBtn = document.getElementById('confirm-cancel');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                modal.classList.remove('hidden');
                
                const cleanup = () => {
                    modal.classList.add('hidden');
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    modal.onclick = null;
                };
                
                okBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                
                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
                
                // Close on background click
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        cleanup();
                        resolve(false);
                    }
                };
            });
        }

        // ==============================================
        // INIT
        // ==============================================
        // ==============================================
        // COLLECTION STATS
        // ==============================================
        async function loadCollectionStats() {
            try {
                // Fetch all NFTs with real price data
                const { data: allNFTs, error } = await supabase
                    .from('user_nfts')
                    .select('*')
                    .eq('is_active', true);

                if (error) throw error;

                // Also fetch transactions for more accurate price data
                const { data: transactions, error: txError } = await supabase
                    .from('transactions')
                    .select('metadata, type, amount')
                    .in('type', ['nft_mint_sol', 'nft_mint_onchain'])
                    .order('created_at', { ascending: false });

                // Create a map of prices from transactions
                const priceMap = new Map();
                if (transactions && !txError) {
                    transactions.forEach(tx => {
                        try {
                            const metadata = typeof tx.metadata === 'string' ? JSON.parse(tx.metadata) : tx.metadata;
                            if (metadata && metadata.price_sol) {
                                const price = parseFloat(metadata.price_sol);
                                if (price > 0) {
                                    // Use tier as key
                                    const tier = metadata.tier || 'Unknown';
                                    if (!priceMap.has(tier) || price < priceMap.get(tier)) {
                                        priceMap.set(tier, price);
                                    }
                                }
                            }
                        } catch (e) {
                            // Skip invalid metadata
                        }
                    });
                }

                // Calculate stats
                const totalMinted = allNFTs.length;
                const uniqueHolders = new Set(allNFTs.map(nft => nft.telegram_id)).size;
                
                // ‚úÖ Calculate total volume from ACTUAL TRANSACTIONS (not current prices)
                let totalVolume = 0;
                let solPrices = []; // For floor price calculation
                
                // Count volume from transactions (real money paid)
                if (transactions && !txError) {
                    transactions.forEach(tx => {
                        try {
                            const metadata = typeof tx.metadata === 'string' ? JSON.parse(tx.metadata) : tx.metadata;
                            if (metadata && metadata.price_sol) {
                                const price = parseFloat(metadata.price_sol);
                                if (price > 0) {
                                    totalVolume += price; // Sum of all purchases
                                }
                            }
                        } catch (e) {
                            // Skip invalid metadata
                        }
                    });
                }
                
                // Calculate floor price from current NFT prices
                allNFTs.forEach(nft => {
                    let price = 0;
                    
                    // Priority 1: Use purchase_price_sol if available (most accurate)
                    if (nft.purchase_price_sol && parseFloat(nft.purchase_price_sol) > 0) {
                        price = parseFloat(nft.purchase_price_sol);
                    }
                    // Priority 2: Get from transactions metadata
                    else if (nft.tier_name && priceMap.has(nft.tier_name)) {
                        price = priceMap.get(nft.tier_name);
                    }
                    // Priority 3: Estimate from tier (fallback)
                    else if (nft.tier_name && nft.tier_name !== 'Bronze') {
                        if (nft.tier_name === 'Silver') price = 1.0;
                        else if (nft.tier_name === 'Gold') price = 3.0;
                        else if (nft.tier_name === 'Platinum') price = 10.0;
                        else if (nft.tier_name === 'Diamond') price = 50.0;
                    }
                    // Bronze SOL price
                    else if (nft.tier_name === 'Bronze') {
                        price = 0.15; // Default Bronze SOL price
                    }
                    
                    if (price > 0) {
                        solPrices.push(price);
                    }
                });

                // Calculate Floor Price (minimum price among active NFTs)
                let floorPrice = 0.15; // Default Bronze price
                if (solPrices.length > 0) {
                    floorPrice = Math.min(...solPrices);
                }

                // Update UI
                document.getElementById('total-minted').textContent = totalMinted;
                document.getElementById('unique-holders').textContent = uniqueHolders;
                document.getElementById('total-volume').textContent = totalVolume.toFixed(1) + ' SOL';
                document.getElementById('floor-price').textContent = floorPrice.toFixed(2) + ' SOL';
                
                console.log('‚úÖ Collection stats loaded (REAL DATA):', { 
                    totalMinted, 
                    uniqueHolders, 
                    totalVolume: totalVolume.toFixed(1) + ' SOL',
                    floorPrice: floorPrice.toFixed(2) + ' SOL',
                    priceSources: 'purchase_price_sol + transactions metadata'
                });
            } catch (error) {
                console.error('‚ùå Failed to load collection stats:', error);
            }
        }

        // ==============================================
        // RECENT MINTS
        // ==============================================
        async function loadRecentMints() {
            try {
                // Fetch recent NFTs
                const { data: recentNFTs, error } = await supabase
                    .from('user_nfts')
                    .select('*')
                    .eq('is_active', true)
                    .order('minted_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                const listEl = document.getElementById('recent-mints-list');
                if (!recentNFTs || recentNFTs.length === 0) {
                    listEl.innerHTML = '<div class="loading-mints">No mints yet. Be the first! üöÄ</div>';
                    return;
                }

                // ‚úÖ Fetch wallet addresses from leaderboard (instead of usernames)
                const telegramIds = [...new Set(recentNFTs.map(nft => nft.telegram_id))];
                const walletMap = new Map();
                
                if (telegramIds.length > 0) {
                    const { data: users, error: usersError } = await supabase
                        .from('leaderboard')
                        .select('telegram_id, wallet_address')
                        .in('telegram_id', telegramIds);
                    
                    if (!usersError && users) {
                        users.forEach(user => {
                            if (user.wallet_address) {
                                walletMap.set(user.telegram_id, user.wallet_address);
                            }
                        });
                    }
                }
                
                // ‚úÖ Fetch transaction signatures for NFTs (for explorer links)
                const signatureMap = new Map();
                
                try {
                    // Get signatures from transactions table for recent NFTs
                    // Match by telegram_id and type nft_mint_sol or nft_mint
                    const { data: transactions, error: txError } = await supabase
                        .from('transactions')
                        .select('metadata, type, user_id')
                        .in('type', ['nft_mint_sol', 'nft_mint'])
                        .in('user_id', telegramIds.map(id => String(id)))
                        .order('created_at', { ascending: false })
                        .limit(50);
                    
                    if (!txError && transactions) {
                        transactions.forEach(tx => {
                            try {
                                let metadata = tx.metadata;
                                if (typeof metadata === 'string') {
                                    metadata = JSON.parse(metadata);
                                }
                                
                                if (metadata) {
                                    const signature = metadata.onchain_signature || metadata.transaction_signature || metadata.signature;
                                    const nftId = metadata.nft_id || metadata.design_number;
                                    
                                    if (signature && tx.user_id) {
                                        // Map by user_id + nft_id if available, or just user_id
                                        const key = nftId ? `${tx.user_id}_${nftId}` : tx.user_id;
                                        signatureMap.set(key, signature);
                                    }
                                }
                            } catch (e) {
                                // Skip invalid metadata
                            }
                        });
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Failed to fetch transaction signatures:', e);
                }

                listEl.innerHTML = '';
                recentNFTs.forEach(nft => {
                    const timeAgo = getTimeAgo(nft.minted_at);
                    
                    // ‚úÖ Show wallet address instead of username (more unique)
                    let displayAddress = '';
                    const wallet = walletMap.get(nft.telegram_id);
                    if (wallet) {
                        // Show first 4 and last 4 characters: "AX4v...JFk3"
                        displayAddress = `${wallet.substring(0, 4)}...${wallet.substring(wallet.length - 4)}`;
                    } else {
                        // Fallback: use telegram_id
                        displayAddress = `User${String(nft.telegram_id).substring(0, 6)}`;
                    }
                    
                    const tierClass = nft.tier_name.toLowerCase();
                    
                    // Check if real on-chain NFT
                    const isOnChain = nft.nft_mint_address && nft.nft_mint_address.length > 30 && !nft.nft_mint_address.includes('_');
                    const onChainBadge = isOnChain ? ' üîó' : '';
                    
                    // Get explorer link
                    let explorerLink = '';
                    let explorerUrl = null;
                    
                    // Try to get signature from transactions (by user_id + nft_id or just user_id)
                    const signatureKey1 = `${nft.telegram_id}_${nft.id}`;
                    const signatureKey2 = String(nft.telegram_id);
                    const signature = signatureMap.get(signatureKey1) || signatureMap.get(signatureKey2);
                    
                    if (signature) {
                        explorerUrl = `https://solscan.io/tx/${signature}?cluster=devnet`;
                        explorerLink = `<a href="${explorerUrl}" target="_blank" class="mint-explorer-link" title="View transaction on Solscan">üìé</a>`;
                    } else if (isOnChain && nft.nft_mint_address) {
                        // Use NFT mint address for on-chain NFTs
                        explorerUrl = `https://solscan.io/account/${nft.nft_mint_address}?cluster=devnet`;
                        explorerLink = `<a href="${explorerUrl}" target="_blank" class="mint-explorer-link" title="View NFT on Solscan">üìé</a>`;
                    }
                    
                    const mintItem = document.createElement('div');
                    mintItem.className = 'mint-item';
                    mintItem.innerHTML = `
                        <div class="mint-item-header">
                            <span class="mint-tier-badge ${tierClass}">${nft.tier_name}${onChainBadge}</span>
                            <span class="mint-time">${timeAgo}${explorerLink}</span>
                        </div>
                        <div class="mint-user">üîë ${displayAddress}</div>
                        <div class="mint-details">
                            <span>${nft.rarity || 'Common'}</span>
                            <span>√ó${nft.earning_multiplier || '2.0'} boost</span>
                        </div>
                    `;
                    listEl.appendChild(mintItem);
                });
                
                // Fill empty grid slots to prevent layout gaps
                // Calculate how many items fit per row based on container width
                const containerWidth = listEl.offsetWidth || 1200; // Fallback width
                const itemMinWidth = 280; // minmax(280px, 1fr)
                const gap = 15;
                const itemsPerRow = Math.max(1, Math.floor((containerWidth + gap) / (itemMinWidth + gap)));
                
                if (itemsPerRow > 0 && recentNFTs.length > 0) {
                    const totalItems = recentNFTs.length;
                    const rows = Math.ceil(totalItems / itemsPerRow);
                    const totalSlots = rows * itemsPerRow;
                    const emptySlots = totalSlots - totalItems;
                    
                    // Add invisible placeholder items to fill empty slots in last row
                    for (let i = 0; i < emptySlots && i < itemsPerRow - 1; i++) {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'mint-item';
                        placeholder.style.visibility = 'hidden';
                        placeholder.style.height = '0';
                        placeholder.style.padding = '0';
                        placeholder.style.margin = '0';
                        placeholder.style.border = 'none';
                        placeholder.style.minHeight = '0';
                        listEl.appendChild(placeholder);
                    }
                }

                console.log('‚úÖ Recent mints loaded:', recentNFTs.length);
            } catch (error) {
                console.error('‚ùå Failed to load recent mints:', error);
                const listEl = document.getElementById('recent-mints-list');
                if (listEl) {
                    listEl.innerHTML = '<div class="loading-mints">Failed to load activity. Please refresh.</div>';
                }
            }
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const mintTime = new Date(timestamp);
            const diffMs = now - mintTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        // Auto-refresh recent mints every 30 seconds (only if page is visible)
        let refreshInterval = setInterval(() => {
            // Only refresh if page is visible (not in background tab)
            if (!document.hidden) {
                loadRecentMints();
                loadCollectionStats();
            }
        }, 30000); // 30 seconds instead of 10
        
        // Also refresh when page becomes visible again
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                loadRecentMints();
                loadCollectionStats();
            }
        });

        // ==============================================
        // FAQ TOGGLE
        // ==============================================
        function toggleFAQ(element) {
            const faqItem = element.parentElement;
            const isActive = faqItem.classList.contains('active');
            
            // Close all FAQ items
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Toggle current item
            if (!isActive) {
                faqItem.classList.add('active');
            }
        }

        window.addEventListener('load', async () => {
            console.log('üöÄ NFT Mint Page loaded');
            console.log('üë§ Telegram User ID:', TELEGRAM_USER_ID);

            // ‚ö° PARALLEL LOADING: Load all data simultaneously for faster startup
            const loadPromises = [
                // Load collection stats and recent mints in parallel
                loadCollectionStats(),
                loadRecentMints(),
                // Fetch SOL/USD price (needed for price calculations)
                fetchSOLPrice()
            ];
            
            // Restore wallet connection in parallel (non-blocking)
            const walletPromise = (async () => {
                try {
                    const savedWallet = localStorage.getItem('phantom_wallet_address');
                    if (savedWallet && window.solana && window.solana.isPhantom) {
                        try {
                            const resp = await window.solana.connect({ onlyIfTrusted: true });
                            if (resp && resp.publicKey) {
                                walletAddress = resp.publicKey.toString();
                                walletConnected = true;
                                console.log('‚úÖ Wallet auto-connected:', walletAddress);
                                
                                // Save wallet address to database on auto-connect (non-blocking)
                                fetch(`${TAMA_API_BASE}/update-wallet`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        telegram_id: TELEGRAM_USER_ID,
                                        wallet_address: walletAddress
                                    })
                                }).then(response => {
                                    if (response.ok) {
                                        return response.json();
                                    }
                                }).then(result => {
                                    if (result) console.log('‚úÖ Wallet address saved to database (auto-connect):', result);
                                }).catch(err => {
                                    console.warn('‚ö†Ô∏è Error saving wallet to database (auto-connect):', err);
                                });
                                
                                updateWalletUI();
                            }
                        } catch (err) {
                            console.log('‚ÑπÔ∏è Wallet not auto-connected (user needs to connect manually)');
                        }
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Failed to restore wallet:', err);
                }
            })();
            
            // Wait for initial data to load
            await Promise.allSettled(loadPromises);
            
            // ‚ö° Load prices and balance in parallel (after SOL price is fetched)
            await Promise.allSettled([
                loadPricesAndStats(),
                loadTAMABalance()
            ]);

            // ============================================
            // üöÄ REAL-TIME BALANCE UPDATES (WebSocket)
            // ============================================
            if (TELEGRAM_USER_ID && TELEGRAM_USER_ID !== 123456789) {
                console.log('üîå Subscribing to real-time balance updates...');
                
                // Subscribe to leaderboard changes for current user
                const balanceChannel = supabase
                    .channel('balance-changes')
                    .on(
                        'postgres_changes',
                        {
                            event: 'UPDATE',
                            schema: 'public',
                            table: 'leaderboard',
                            filter: `telegram_id=eq.${TELEGRAM_USER_ID}`
                        },
                        (payload) => {
                            console.log('‚ö° Real-time balance update:', payload);
                            
                            // Extract new TAMA balance
                            const newBalance = payload.new.tama || 0;
                            const oldBalance = payload.old.tama || 0;
                            
                            if (newBalance !== oldBalance) {
                                console.log(`üí∞ Balance changed: ${oldBalance} ‚Üí ${newBalance} TAMA`);
                                
                                // Update UI immediately
                                tamaBalance = newBalance;
                                document.getElementById('tama-balance').textContent = newBalance.toLocaleString();
                                
                                // Show notification
                                const diff = newBalance - oldBalance;
                                if (diff > 0) {
                                    showNotification('success', 'Balance Updated', 
                                        `+${diff.toLocaleString()} TAMA`);
                                } else if (diff < 0) {
                                    showNotification('warning', 'Balance Updated', 
                                        `${diff.toLocaleString()} TAMA`);
                                }
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('‚úÖ Real-time balance updates ACTIVE');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.warn('‚ö†Ô∏è Real-time subscription error');
                        }
                    });
                
                // Cleanup on page unload
                window.addEventListener('beforeunload', () => {
                    supabase.removeChannel(balanceChannel);
                });
            }

            // ‚ö° Optimized auto-refresh intervals (longer to reduce server load)
            // Auto-refresh prices every 30 seconds (was 10s - too frequent)
            setInterval(() => {
                if (!isLoadingPrices) loadPricesAndStats();
            }, 30000);
            
            // Auto-refresh balance every 60 seconds (was 30s - too frequent)
            setInterval(() => {
                if (!isLoadingBalance) loadTAMABalance();
            }, 60000);
            
            // Update SOL/USD rate every 5 minutes (was 60s - too frequent)
            setInterval(fetchSOLPrice, 300000);
        });
    </script>

    <!-- Legal Footer -->
    <div style="margin-top: 60px; padding: 30px 20px; background: #f8f9fa; border-top: 2px solid #e0e0e0; text-align: center; color: #666;">
        <p style="margin: 10px 0; font-size: 0.95em;">
            <a href="/terms" style="color: #9945FF; text-decoration: none; margin: 0 12px; font-weight: 500;">‚öñÔ∏è Terms of Service</a> |
            <a href="/privacy" style="color: #9945FF; text-decoration: none; margin: 0 12px; font-weight: 500;">üîí Privacy Policy</a> |
            <a href="/disclaimer" style="color: #9945FF; text-decoration: none; margin: 0 12px; font-weight: 500;">‚ö†Ô∏è Risk Warning</a>
        </p>
        <p style="margin-top: 15px; font-size: 0.85em; color: #999;">
            ¬© 2024-2025 Solana Tamagotchi. All rights reserved.
        </p>
    </div>
</body>
</html>

