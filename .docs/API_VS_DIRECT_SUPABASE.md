# üî• API vs Direct Supabase - Why API is Better

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ (–ø—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ Supabase):

```javascript
// BAD: Direct Supabase call from frontend
const response = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?telegram_id=eq.${userId}`, {
    method: 'PATCH',
    headers: {
        'apikey': SUPABASE_ANON_KEY,  // ‚ö†Ô∏è EXPOSED KEY!
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ tama: gameState.tama, ... })
});
```

### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
1. ‚ùå **–ö–ª—é—á–∏ Supabase –≤–∏–¥–Ω—ã –≤ frontend** (–º–æ–∂–Ω–æ —É–∫—Ä–∞—Å—Ç—å)
2. ‚ùå **–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö** (—á–∏—Ç–µ—Ä –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á—Ç–æ —É–≥–æ–¥–Ω–æ)
3. ‚ùå **–ù–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏** (NFT boost, –∞–Ω—Ç–∏—á–∏—Ç, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
4. ‚ùå **CORS –ø—Ä–æ–±–ª–µ–º—ã** (–µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
5. ‚ùå **–ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏** (–ª–æ–≥–∏–∫–∞ —Ä–∞–∑–º–∞–∑–∞–Ω–∞ –ø–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É)

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π API):

```javascript
// GOOD: Use our API
const apiUrl = `${TAMA_API_BASE}/leaderboard/upsert`;
const response = await fetch(apiUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        user_id: userId,
        tama: gameState.tama,
        level: gameState.level,
        pet_data: pet_data,
        ...
    })
});
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
1. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∫–ª—é—á–∏ Supabase —Å–∫—Ä—ã—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è** - API –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
3. ‚úÖ **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞** - NFT boost, –∞–Ω—Ç–∏—á–∏—Ç, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
4. ‚úÖ **CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω** - —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
5. ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è** - –≤—Å—è –ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
6. ‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∏—á–∏

---

## üîß –ù–∞—à API Endpoint

### POST `/api/tama/leaderboard/upsert`

**Request:**
```json
{
  "user_id": "7401131043",
  "user_type": "telegram",
  "tama": 21383,
  "level": 9,
  "xp": 850,
  "pet_data": {
    "hp": 100,
    "food": 80,
    "happy": 90,
    "totalClicks": 1234,
    "maxCombo": 50,
    ...
  },
  "pet_name": "Gotchi",
  "pet_type": "kawai"
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Game data updated successfully",
  "data": {
    "user_id": "7401131043",
    "tama": 21383,
    "level": 9
  }
}
```

**Response (Error):**
```json
{
  "error": "user_id is required"
}
```

---

## üìä –ß—Ç–æ –¥–µ–ª–∞–µ—Ç API:

1. **–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `user_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ `tama` –Ω–µ null
   - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
   - –ï—Å–ª–∏ –¥–∞ - UPDATE
   - –ï—Å–ª–∏ –Ω–µ—Ç - INSERT (—Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏)

3. **–õ–æ–≥–∏—Ä—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `last_activity` timestamp
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

4. **–ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å:**
   - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ NFT boost
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω—Ç–∏—á–∏—Ç–∞ (–º–∞–∫—Å. –∫–ª–∏–∫–∏ –≤ –º–∏–Ω—É—Ç—É)
   - –í–∞–ª–∏–¥–∞—Ü–∏—è Level-up –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `transactions` —Ç–∞–±–ª–∏—Ü—É

---

## üî• –°—Ä–∞–≤–Ω–µ–Ω–∏–µ

| Feature | Direct Supabase | Our API |
|---------|----------------|---------|
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | ‚ùå –ö–ª—é—á–∏ –≤ frontend | ‚úÖ –ö–ª—é—á–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (NFT boost, –∞–Ω—Ç–∏—á–∏—Ç) |
| **CORS** | ‚ö†Ô∏è –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å | ‚úÖ –£–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏) |
| **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** | ‚ùå –¢—è–∂–µ–ª–æ | ‚úÖ –õ–µ–≥–∫–æ |
| **–°–∫–æ—Ä–æ—Å—Ç—å** | üü¢ Fast | üü¢ Fast (one extra hop) |

---

## üéØ –í—ã–≤–æ–¥

**–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π API –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ Supabase!**

- –≠—Ç–æ **–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
- –≠—Ç–æ **–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ**
- –≠—Ç–æ **–ª–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å**
- –≠—Ç–æ **–ø—Ä–æ—â–µ —Ä–∞—Å—à–∏—Ä—è—Ç—å**

---

## üìù Files Modified

- **`api/tama_supabase.php`** - Added `/leaderboard/upsert` endpoint
- **`tamagotchi-game.html`** - Updated `saveDirectToSupabase()` to use API

---

**Status:** ‚úÖ IMPLEMENTED  
**Date:** November 7, 2025  
**API URL:** `https://huma-chain-xyz-production.up.railway.app/api/tama/leaderboard/upsert`

