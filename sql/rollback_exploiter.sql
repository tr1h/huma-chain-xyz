-- ğŸš¨ ROLLBACK EXPLOITER BALANCE
-- User: wallet_7mckTJhKqQXM
-- Wallet: 7mckTJhKqQXMbr7DNcWqc5Lf8QFtdTaQmoNkT6esrx96
-- Exploited Balance: 32,935,860 TAMA

-- Step 1: Get transaction history for this wallet user
SELECT
    id,
    user_id,
    wallet_address,
    amount,
    type,
    balance_before,
    balance_after,
    metadata,
    created_at
FROM transactions
WHERE wallet_address = '7mckTJhKqQXMbr7DNcWqc5Lf8QFtdTaQmoNkT6esrx96'
ORDER BY created_at DESC
LIMIT 50;

-- Step 2: Check wallet_users current balance
SELECT
    user_id,
    username,
    wallet_address,
    tama_balance,
    level,
    last_active,
    created_at
FROM wallet_users
WHERE wallet_address = '7mckTJhKqQXMbr7DNcWqc5Lf8QFtdTaQmoNkT6esrx96';

-- Step 3: Find suspicious high-win transactions
SELECT
    id,
    amount,
    type,
    balance_before,
    balance_after,
    metadata,
    created_at
FROM transactions
WHERE wallet_address = '7mckTJhKqQXMbr7DNcWqc5Lf8QFtdTaQmoNkT6esrx96'
    AND type IN ('slots_win', 'wheel_win')
    AND amount > 50000  -- Abnormally high wins
ORDER BY amount DESC;

-- Step 4: Calculate total exploited amount
SELECT
    COUNT(*) as exploit_count,
    SUM(amount) as total_exploited,
    MIN(created_at) as first_exploit,
    MAX(created_at) as last_exploit
FROM transactions
WHERE wallet_address = '7mckTJhKqQXMbr7DNcWqc5Lf8QFtdTaQmoNkT6esrx96'
    AND type IN ('slots_win', 'wheel_win')
    AND amount > 50000
    AND created_at < '2026-01-15 20:00:00';  -- Before security fix

-- âš ï¸ STEP 5: ROLLBACK - Reset wallet user balance to 0
-- Only run this after reviewing the data above!
/*
UPDATE wallet_users
SET
    tama_balance = 0,
    updated_at = NOW()
WHERE wallet_address = '7mckTJhKqQXMbr7DNcWqc5Lf8QFtdTaQmoNkT6esrx96';
*/

-- Step 6: Insert rollback transaction record
/*
INSERT INTO transactions (
    user_id,
    wallet_address,
    amount,
    type,
    balance_before,
    balance_after,
    metadata,
    created_at
)
VALUES (
    'wallet_7mckTJhKqQXM',
    '7mckTJhKqQXMbr7DNcWqc5Lf8QFtdTaQmoNkT6esrx96',
    -32935860,  -- Remove all exploited TAMA
    'admin_rollback',
    32935860,
    0,
    '{"reason": "Security exploit rollback", "exploit_type": "client_side_slots_manipulation", "fixed_date": "2026-01-15"}'::jsonb,
    NOW()
);
*/

-- Step 7: Mark exploited transactions (optional - for audit trail)
/*
UPDATE transactions
SET metadata = COALESCE(metadata::jsonb, '{}'::jsonb) || '{"exploited": true, "rollback_date": "2026-01-15"}'::jsonb
WHERE wallet_address = '7mckTJhKqQXMbr7DNcWqc5Lf8QFtdTaQmoNkT6esrx96'
    AND type IN ('slots_win', 'wheel_win')
    AND amount > 50000
    AND created_at < '2026-01-15 20:00:00';
*/

-- âœ… VERIFICATION: Check final balance after rollback
/*
SELECT
    user_id,
    username,
    wallet_address,
    tama_balance,
    updated_at
FROM wallet_users
WHERE wallet_address = '7mckTJhKqQXMbr7DNcWqc5Lf8QFtdTaQmoNkT6esrx96';
*/
