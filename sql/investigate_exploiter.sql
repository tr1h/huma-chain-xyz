-- ğŸ” Investigation: Find exploiter with abnormal TAMA balance
-- Looking for user with ~32,935,860 TAMA

-- Step 1: Find top users by balance
SELECT
    telegram_id,
    telegram_username,
    telegram_first_name,
    tama,
    created_at,
    updated_at
FROM leaderboard
WHERE tama > 1000000  -- Users with > 1M TAMA
ORDER BY tama DESC
LIMIT 20;

-- Step 2: Get transaction history for suspicious user
-- Replace 'EXPLOITER_ID' with actual telegram_id from Step 1
/*
SELECT
    id,
    telegram_id,
    amount,
    type,
    balance_before,
    balance_after,
    metadata,
    created_at
FROM transactions
WHERE telegram_id = 'EXPLOITER_ID'
ORDER BY created_at DESC
LIMIT 100;
*/

-- Step 3: Count suspicious slots wins
-- (High win amounts that shouldn't be possible with old max multipliers)
/*
SELECT
    telegram_id,
    COUNT(*) as suspicious_wins,
    SUM(amount) as total_suspicious_tama,
    MIN(created_at) as first_exploit,
    MAX(created_at) as last_exploit
FROM transactions
WHERE telegram_id = 'EXPLOITER_ID'
    AND type IN ('slots_win', 'wheel_win')
    AND amount > 100000  -- Suspicious high wins
GROUP BY telegram_id;
*/

-- Step 4: Calculate legitimate balance
-- Sum of all non-suspicious transactions
/*
SELECT
    telegram_id,
    SUM(CASE
        WHEN type IN ('slots_win', 'wheel_win') AND amount > 100000 THEN 0
        ELSE amount
    END) as legitimate_balance
FROM transactions
WHERE telegram_id = 'EXPLOITER_ID'
GROUP BY telegram_id;
*/

-- Step 5: ROLLBACK - Set user balance to 0 or legitimate amount
-- âš ï¸ WARNING: Only run this after confirming the telegram_id!
/*
UPDATE leaderboard
SET tama = 0,  -- or use legitimate_balance from Step 4
    updated_at = NOW()
WHERE telegram_id = 'EXPLOITER_ID';
*/

-- Step 6: Mark exploited transactions
-- Add a flag to identify exploited transactions
/*
UPDATE transactions
SET metadata = jsonb_set(
    COALESCE(metadata::jsonb, '{}'::jsonb),
    '{exploited}',
    'true'::jsonb
)
WHERE telegram_id = 'EXPLOITER_ID'
    AND type IN ('slots_win', 'wheel_win')
    AND amount > 100000
    AND created_at < NOW();  -- Before security fix
*/
