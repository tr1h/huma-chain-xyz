<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>NFT Debug - Check Database</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .result {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
        }
        .error {
            border-left-color: #ff0000;
            color: #ff6666;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover {
            background: #00cc00;
        }
    </style>
</head>
<body>
    <h1>üîç NFT Database Debug Tool</h1>
    <p>This tool checks what's actually in the database for your account.</p>
    
    <div>
        <label>Telegram User ID:</label>
        <input type="text" id="userId" value="202140267" style="width: 200px; padding: 5px; background: #333; color: #0f0; border: 1px solid #0f0;">
        <button onclick="checkNFTs()">Check NFTs</button>
        <button onclick="checkRPC()">Check RPC Function</button>
    </div>
    
    <div id="output"></div>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://zfrazyupameidxpjihrh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcmF6eXVwYW1laWR4cGppaHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI0NjE5NjIsImV4cCI6MjA0ODAzNzk2Mn0.2w5nT6fzb4l5lB19fWe0Q9DpQzPWx2X8eBiQvkBqN3A';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        function addOutput(title, data, isError = false) {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = 'result' + (isError ? ' error' : '');
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            output.appendChild(div);
        }
        
        async function checkNFTs() {
            const userId = document.getElementById('userId').value;
            document.getElementById('output').innerHTML = '';
            
            addOutput('üîç Checking for User ID:', userId);
            
            // 1. Check user_nfts table
            try {
                const { data, error } = await supabase
                    .from('user_nfts')
                    .select('*')
                    .eq('telegram_id', userId)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    addOutput('‚ùå Error querying user_nfts:', error, true);
                } else {
                    addOutput(`‚úÖ Found ${data.length} NFTs in user_nfts:`, data);
                }
            } catch (err) {
                addOutput('‚ùå Exception:', err, true);
            }
            
            // 2. Check user_nfts with is_active filter
            try {
                const { data, error } = await supabase
                    .from('user_nfts')
                    .select('*')
                    .eq('telegram_id', userId)
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    addOutput('‚ùå Error querying user_nfts (is_active=true):', error, true);
                } else {
                    addOutput(`‚úÖ Found ${data.length} ACTIVE NFTs in user_nfts:`, data);
                }
            } catch (err) {
                addOutput('‚ùå Exception:', err, true);
            }
            
            // 3. Check if telegram_id is stored as string or number
            try {
                const { data, error } = await supabase
                    .from('user_nfts')
                    .select('telegram_id')
                    .limit(10);
                
                if (error) {
                    addOutput('‚ùå Error checking telegram_id types:', error, true);
                } else {
                    const types = data.map(row => ({
                        telegram_id: row.telegram_id,
                        type: typeof row.telegram_id
                    }));
                    addOutput('üîç Sample telegram_id types:', types);
                }
            } catch (err) {
                addOutput('‚ùå Exception:', err, true);
            }
            
            // 4. Check recent NFTs (last 10)
            try {
                const { data, error } = await supabase
                    .from('user_nfts')
                    .select('id, telegram_id, nft_mint_address, is_active, created_at')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) {
                    addOutput('‚ùå Error querying recent NFTs:', error, true);
                } else {
                    addOutput('üïê Last 10 NFTs in database:', data);
                }
            } catch (err) {
                addOutput('‚ùå Exception:', err, true);
            }
        }
        
        async function checkRPC() {
            document.getElementById('output').innerHTML = '';
            
            // Test RPC function
            try {
                const { data, error } = await supabase.rpc('insert_user_nft', {
                    p_telegram_id: '202140267',
                    p_nft_design_id: 1,
                    p_nft_mint_address: 'test_debug_' + Date.now(),
                    p_tier_name: 'Bronze',
                    p_rarity: 'Common',
                    p_earning_multiplier: 1.0,
                    p_daily_reward: 50
                });
                
                if (error) {
                    addOutput('‚ùå RPC Function Error:', error, true);
                } else {
                    addOutput('‚úÖ RPC Function Result:', data);
                }
            } catch (err) {
                addOutput('‚ùå RPC Exception:', err, true);
            }
        }
        
        // Auto-check on load if user_id in URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        if (userId) {
            document.getElementById('userId').value = userId;
            setTimeout(checkNFTs, 500);
        }
    </script>
</body>
</html>

