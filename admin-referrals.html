<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral System Admin - Solana Tamagotchi</title>
    <!-- Admin Password -->
    <meta name="admin-password-hash" content="86303a8eab5693506714a32875b556fd84daf2209f184459642af6e153da3ff3">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Admin Login Screen */
        #adminLoginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-container h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 28px;
        }

        #adminPasswordInput {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        #adminPasswordInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: #5568d3;
        }

        #adminLoginError {
            color: red;
            margin-top: 15px;
            min-height: 20px;
            font-size: 14px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .back-btn {
            position: absolute;
            left: 0;
            top: 0;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4ade80;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .tab-btn.active {
            background: rgba(74, 222, 128, 0.3);
            border-color: #4ade80;
        }

        .table-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            color: #4ade80;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }

        th {
            background: rgba(255,255,255,0.1);
            font-weight: bold;
            color: #4ade80;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-pending {
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .status-active {
            background: rgba(74, 222, 128, 0.3);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(74,222,128,0.3);
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
        }

        .error {
            color: #ef4444;
            text-align: center;
            padding: 20px;
            background: rgba(239,68,68,0.1);
            border-radius: 10px;
            margin: 20px 0;
        }

        .user-link {
            color: #4ade80;
            text-decoration: none;
            font-weight: bold;
        }

        .user-link:hover {
            text-decoration: underline;
        }

        .milestone-progress {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .milestone-item {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }

        .milestone-completed {
            background: rgba(74, 222, 128, 0.3);
            color: #4ade80;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .search-box::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .search-box:focus {
            outline: none;
            border-color: #4ade80;
        }
    </style>
</head>
<body>
    <!-- Admin Login Screen -->
    <div id="adminLoginScreen">
        <div class="login-container">
            <h2>üîê Admin Access</h2>
            <input type="password" id="adminPasswordInput" placeholder="Enter password">
            <button class="login-btn" onclick="adminAuth.checkPassword()">Login</button>
            <div id="adminLoginError"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="adminContent" style="display: none;">
        <div class="container">
            <div class="header">
                <a href="super-admin.html" class="back-btn">‚¨ÖÔ∏è Back to Dashboard</a>
                <h1>üîó Referral System Admin</h1>
                <p>Manage and monitor referrals</p>
            </div>

            <!-- Stats -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeReferrals">-</div>
                    <div class="stat-label">Active Referrals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingReferrals">-</div>
                    <div class="stat-label">Pending Referrals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClicks">-</div>
                    <div class="stat-label">Referral Clicks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalEarnings">-</div>
                    <div class="stat-label">Total TAMA Earned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="conversionRate">-</div>
                    <div class="stat-label">Conversion Rate</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">üìä Overview</button>
                <button class="tab-btn" onclick="switchTab('active')">‚úÖ Active Referrals</button>
                <button class="tab-btn" onclick="switchTab('pending')">‚è≥ Pending Referrals</button>
                <button class="tab-btn" onclick="switchTab('top')">üèÜ Top Referrers</button>
                <button class="tab-btn" onclick="switchTab('milestones')">üéÅ Milestones</button>
                <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            </div>

            <!-- Refresh Button -->
            <div style="text-align: center;">
                <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
            </div>

            <!-- Search -->
            <input type="text" class="search-box" id="searchBox" placeholder="üîç Search by username or Telegram ID..." onkeyup="filterTable()">

            <!-- Loading/Error -->
            <div id="loading" class="loading">Loading data...</div>
            <div id="error" class="error" style="display: none;"></div>

            <!-- Overview Tab -->
            <div id="tab-overview" class="table-container">
                <h2 class="table-title">üìä All Users & Referrals</h2>
                <table id="overviewTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Referral Code</th>
                            <th>Active</th>
                            <th>Pending</th>
                            <th>Total</th>
                            <th>Earnings</th>
                            <th>Milestones</th>
                        </tr>
                    </thead>
                    <tbody id="overviewTableBody"></tbody>
                </table>
            </div>

            <!-- Active Referrals Tab -->
            <div id="tab-active" class="table-container" style="display: none;">
                <h2 class="table-title">‚úÖ Active Referrals</h2>
                <table id="activeTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Referred User</th>
                            <th>Referred By</th>
                            <th>Code Used</th>
                            <th>Created At</th>
                            <th>Reward Paid</th>
                        </tr>
                    </thead>
                    <tbody id="activeTableBody"></tbody>
                </table>
            </div>

            <!-- Pending Referrals Tab -->
            <div id="tab-pending" class="table-container" style="display: none;">
                <h2 class="table-title">‚è≥ Pending Referrals</h2>
                <table id="pendingTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Referred User</th>
                            <th>Referred By</th>
                            <th>Code Used</th>
                            <th>Created At</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTableBody"></tbody>
                </table>
            </div>

            <!-- Top Referrers Tab -->
            <div id="tab-top" class="table-container" style="display: none;">
                <h2 class="table-title">üèÜ Top Referrers</h2>
                <table id="topTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Total Referrals</th>
                            <th>Active</th>
                            <th>Pending</th>
                            <th>Earnings</th>
                        </tr>
                    </thead>
                    <tbody id="topTableBody"></tbody>
                </table>
            </div>

            <!-- Milestones Tab -->
            <div id="tab-milestones" class="table-container" style="display: none;">
                <h2 class="table-title">üéÅ Milestone Progress</h2>
                <table id="milestonesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Total Refs</th>
                            <th>5 Refs</th>
                            <th>10 Refs</th>
                            <th>25 Refs</th>
                            <th>50 Refs</th>
                            <th>100 Refs</th>
                            <th>Next Milestone</th>
                        </tr>
                    </thead>
                    <tbody id="milestonesTableBody"></tbody>
                </table>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="table-container" style="display: none;">
                <h2 class="table-title">‚öôÔ∏è Referral Rewards Settings</h2>
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #4ade80; margin-bottom: 15px;">üí∞ Per Referral Reward</h3>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <label style="flex: 1; font-weight: bold;">TAMA per referral:</label>
                            <input type="number" id="setting-referral_reward" min="0" step="100" 
                                   style="flex: 1; padding: 10px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                            <span style="color: #4ade80; font-weight: bold;">TAMA</span>
                        </div>
                        <p style="opacity: 0.7; font-size: 0.9rem;">Amount awarded instantly when someone joins via referral link</p>
                    </div>

                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #4ade80; margin-bottom: 15px;">üéÅ Milestone Bonuses (Hybrid System)</h3>
                        <p style="opacity: 0.7; font-size: 0.85rem; margin-bottom: 15px;">Level 1 only: 1,000 TAMA per referral + milestone bonuses</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">1 referral ‚Üí</label>
                                <input type="number" id="setting-milestone_1" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">3 referrals ‚Üí</label>
                                <input type="number" id="setting-milestone_3" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">5 referrals ‚Üí</label>
                                <input type="number" id="setting-milestone_5" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">10 referrals ‚Üí</label>
                                <input type="number" id="setting-milestone_10" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">15 referrals ‚Üí</label>
                                <input type="number" id="setting-milestone_15" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">25 referrals ‚Üí</label>
                                <input type="number" id="setting-milestone_25" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">50 referrals ‚Üí</label>
                                <input type="number" id="setting-milestone_50" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">75 referrals ‚Üí</label>
                                <input type="number" id="setting-milestone_75" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">100 referrals ‚Üí</label>
                                <input type="number" id="setting-milestone_100" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">150 referrals ‚Üí</label>
                                <input type="number" id="setting-milestone_150" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">250 referrals üëë ‚Üí</label>
                                <input type="number" id="setting-milestone_250" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">500 referrals üåü ‚Üí</label>
                                <input type="number" id="setting-milestone_500" min="0" step="100" 
                                       style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                                <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <label style="flex: 1; font-weight: bold; font-size: 0.9rem;">1,000 referrals ‚ö° ‚Üí</label>
                            <input type="number" id="setting-milestone_1000" min="0" step="100" 
                                   style="flex: 1; padding: 8px; border-radius: 8px; border: 2px solid #667eea; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
                            <span style="color: #4ade80; font-weight: bold; font-size: 0.9rem;">TAMA</span>
                        </div>
                        
                        <p style="opacity: 0.7; font-size: 0.9rem; margin-top: 15px;">Bonus amounts awarded when user reaches milestone (Level 1 system only - no Level 2)</p>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="refresh-btn" onclick="saveSettings()" style="background: linear-gradient(135deg, #10b981, #059669);">
                            üíæ Save Settings
                        </button>
                        <button class="refresh-btn" onclick="loadSettings()" style="background: linear-gradient(135deg, #667eea, #5568d3); margin-left: 10px;">
                            üîÑ Reload Settings
                        </button>
                    </div>

                    <div id="settings-message" style="margin-top: 20px; text-align: center; min-height: 30px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        const SUPABASE_URL = window.CONFIG?.SUPABASE_URL || 'https://zfrazyupameidxpjihrh.supabase.co';
        const SUPABASE_ANON_KEY = window.CONFIG?.SUPABASE_KEY || '';

        let allData = {
            users: [],
            activeReferrals: [],
            pendingReferrals: [],
            clicks: [],
            transactions: []
        };

        let currentTab = 'overview';

        // Generate referral code (same algorithm as game)
        async function generateReferralCode(telegramId) {
            // Check if telegramId is valid
            if (!telegramId || telegramId === null || telegramId === undefined) {
                return 'TAMA000000';
            }
            
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(String(telegramId));
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = new Uint8Array(hashBuffer);
                
                const hashVal = (hashArray[0] << 16) | (hashArray[1] << 8) | hashArray[2];
                const base36Chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                let codePart = '';
                let num = hashVal % (36 ** 6);
                for (let i = 0; i < 6; i++) {
                    codePart = base36Chars[num % 36] + codePart;
                    num = Math.floor(num / 36);
                }
                return 'TAMA' + codePart;
            } catch (error) {
                console.error('Error generating referral code:', error);
                return 'TAMA000000';
            }
        }

        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';

                // Load all data in parallel
                const [users, active, pending, clicks, transactions] = await Promise.all([
                    fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=*`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }).then(r => r.json()),
                    
                    fetch(`${SUPABASE_URL}/rest/v1/referrals?select=*`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }).then(r => r.json()),
                    
                    fetch(`${SUPABASE_URL}/rest/v1/pending_referrals?select=*&status=eq.pending`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }).then(r => r.json()),
                    
                    fetch(`${SUPABASE_URL}/rest/v1/referral_clicks?select=*`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }).then(r => r.json()),
                    
                    fetch(`${SUPABASE_URL}/rest/v1/transactions?select=*&type=eq.referral_bonus`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }).then(r => r.json())
                ]);

                allData = { users, activeReferrals: active, pendingReferrals: pending, clicks, transactions };

                await updateStats();
                await renderCurrentTab();

                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Error loading data: ' + error.message;
            }
        }

        async function updateStats() {
            const { users, activeReferrals, pendingReferrals, clicks, transactions } = allData;

            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeReferrals').textContent = activeReferrals.length;
            document.getElementById('pendingReferrals').textContent = pendingReferrals.length;
            document.getElementById('totalClicks').textContent = clicks.length;

            const totalEarnings = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
            document.getElementById('totalEarnings').textContent = totalEarnings.toLocaleString() + ' TAMA';

            const conversionRate = clicks.length > 0 
                ? ((activeReferrals.length / clicks.length) * 100).toFixed(1) 
                : '0.0';
            document.getElementById('conversionRate').textContent = conversionRate + '%';
        }

        async function renderCurrentTab() {
            const { users, activeReferrals, pendingReferrals } = allData;

            if (currentTab === 'overview') {
                await renderOverview();
            } else if (currentTab === 'active') {
                renderActive();
            } else if (currentTab === 'pending') {
                renderPending();
            } else if (currentTab === 'top') {
                await renderTop();
            } else if (currentTab === 'milestones') {
                await renderMilestones();
            }
        }

        async function renderOverview() {
            const tbody = document.getElementById('overviewTableBody');
            tbody.innerHTML = '';

            for (const user of allData.users) {
                // Skip users without telegram_id
                if (!user.telegram_id) {
                    console.warn('User without telegram_id:', user);
                    continue;
                }
                
                const activeCount = allData.activeReferrals.filter(r => String(r.referrer_telegram_id) === String(user.telegram_id)).length;
                const pendingCount = allData.pendingReferrals.filter(r => String(r.referrer_telegram_id) === String(user.telegram_id)).length;
                const totalCount = activeCount + pendingCount;
                
                const earnings = allData.transactions
                    .filter(t => String(t.user_id) === String(user.telegram_id))
                    .reduce((sum, t) => sum + (t.amount || 0), 0);

                const refCode = await generateReferralCode(user.telegram_id);

                const milestones = [5, 10, 25, 50, 100];
                const completed = milestones.filter(m => totalCount >= m);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.telegram_id}</td>
                    <td class="user-link">${user.telegram_username || 'Unknown'}</td>
                    <td><code>${refCode}</code></td>
                    <td>${activeCount}</td>
                    <td>${pendingCount}</td>
                    <td><strong>${totalCount}</strong></td>
                    <td>${earnings.toLocaleString()} TAMA</td>
                    <td>
                        ${completed.map(m => `<span class="milestone-item milestone-completed">${m}</span>`).join(' ')}
                        ${completed.length === 0 ? '<span class="milestone-item">None</span>' : ''}
                    </td>
                `;
                tbody.appendChild(row);
            }

            document.getElementById('overviewTable').style.display = 'table';
        }

        function renderActive() {
            const tbody = document.getElementById('activeTableBody');
            tbody.innerHTML = '';

            allData.activeReferrals.forEach(ref => {
                const referrer = allData.users.find(u => u.telegram_id === ref.referrer_telegram_id);
                const referred = allData.users.find(u => u.telegram_id === ref.referred_telegram_id);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${referred?.telegram_username || ref.referred_telegram_id}</td>
                    <td class="user-link">${referrer?.telegram_username || ref.referrer_telegram_id}</td>
                    <td><code>${ref.referral_code || 'N/A'}</code></td>
                    <td>${new Date(ref.created_at).toLocaleString()}</td>
                    <td><span class="status-badge status-active">‚úÖ Paid</span></td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('activeTable').style.display = 'table';
        }

        function renderPending() {
            const tbody = document.getElementById('pendingTableBody');
            tbody.innerHTML = '';

            allData.pendingReferrals.forEach(ref => {
                const referrer = allData.users.find(u => u.telegram_id === ref.referrer_telegram_id);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ref.referred_telegram_id}</td>
                    <td class="user-link">${referrer?.telegram_username || ref.referrer_telegram_id}</td>
                    <td><code>${ref.referral_code || 'N/A'}</code></td>
                    <td>${new Date(ref.created_at).toLocaleString()}</td>
                    <td><span class="status-badge status-pending">‚è≥ Pending</span></td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('pendingTable').style.display = 'table';
        }

        async function renderTop() {
            const tbody = document.getElementById('topTableBody');
            tbody.innerHTML = '';

            // Calculate totals for each user
            const userStats = allData.users.map(user => {
                const activeCount = allData.activeReferrals.filter(r => r.referrer_telegram_id === user.telegram_id).length;
                const pendingCount = allData.pendingReferrals.filter(r => r.referrer_telegram_id === user.telegram_id).length;
                const totalCount = activeCount + pendingCount;
                const earnings = allData.transactions
                    .filter(t => t.user_id === user.telegram_id)
                    .reduce((sum, t) => sum + (t.amount || 0), 0);

                return { user, activeCount, pendingCount, totalCount, earnings };
            });

            // Sort by total referrals
            userStats.sort((a, b) => b.totalCount - a.totalCount);

            // Show top 20
            userStats.slice(0, 20).forEach((stat, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${medal}</td>
                    <td>${stat.user.telegram_id}</td>
                    <td class="user-link">${stat.user.telegram_username || 'Unknown'}</td>
                    <td><strong>${stat.totalCount}</strong></td>
                    <td>${stat.activeCount}</td>
                    <td>${stat.pendingCount}</td>
                    <td>${stat.earnings.toLocaleString()} TAMA</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('topTable').style.display = 'table';
        }

        async function renderMilestones() {
            const tbody = document.getElementById('milestonesTableBody');
            tbody.innerHTML = '';

            const milestones = [5, 10, 25, 50, 100];

            for (const user of allData.users) {
                const activeCount = allData.activeReferrals.filter(r => r.referrer_telegram_id === user.telegram_id).length;
                const pendingCount = allData.pendingReferrals.filter(r => r.referrer_telegram_id === user.telegram_id).length;
                const totalCount = activeCount + pendingCount;

                if (totalCount === 0) continue; // Skip users with no referrals

                const nextMilestone = milestones.find(m => m > totalCount) || 'MAX';
                const progress = nextMilestone !== 'MAX' ? `${totalCount}/${nextMilestone}` : 'All unlocked!';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.telegram_id}</td>
                    <td class="user-link">${user.telegram_username || 'Unknown'}</td>
                    <td><strong>${totalCount}</strong></td>
                    <td>${totalCount >= 5 ? '‚úÖ' : '‚ùå'}</td>
                    <td>${totalCount >= 10 ? '‚úÖ' : '‚ùå'}</td>
                    <td>${totalCount >= 25 ? '‚úÖ' : '‚ùå'}</td>
                    <td>${totalCount >= 50 ? '‚úÖ' : '‚ùå'}</td>
                    <td>${totalCount >= 100 ? '‚úÖ' : '‚ùå'}</td>
                    <td>${progress}</td>
                `;
                tbody.appendChild(row);
            }

            document.getElementById('milestonesTable').style.display = 'table';
        }

        function switchTab(tab) {
            currentTab = tab;

            // Hide all tabs
            ['overview', 'active', 'pending', 'top', 'milestones', 'settings'].forEach(t => {
                const tabEl = document.getElementById(`tab-${t}`);
                if (tabEl) tabEl.style.display = 'none';
            });

            // Show current tab
            const currentTabEl = document.getElementById(`tab-${tab}`);
            if (currentTabEl) {
                currentTabEl.style.display = 'block';
            }

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const clickedBtn = event?.target || document.querySelector(`.tab-btn[onclick*="'${tab}'"]`);
            if (clickedBtn) clickedBtn.classList.add('active');

            renderCurrentTab();
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const tables = ['overviewTableBody', 'activeTableBody', 'pendingTableBody', 'topTableBody', 'milestonesTableBody'];

            tables.forEach(tableId => {
                const tbody = document.getElementById(tableId);
                if (!tbody) return;

                Array.from(tbody.rows).forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // Load referral settings
        async function loadSettings() {
            try {
                const response = await fetch('https://api.solanatamagotchi.com/api/referral-settings.php');
                const result = await response.json();
                
                if (result.success && result.settings) {
                    // Fill form fields
                    const settings = result.settings;
                    document.getElementById('setting-referral_reward').value = settings.referral_reward?.value || '1000';
                    document.getElementById('setting-milestone_1').value = settings.milestone_1?.value || '500';
                    document.getElementById('setting-milestone_3').value = settings.milestone_3?.value || '750';
                    document.getElementById('setting-milestone_5').value = settings.milestone_5?.value || '1000';
                    document.getElementById('setting-milestone_10').value = settings.milestone_10?.value || '3000';
                    document.getElementById('setting-milestone_15').value = settings.milestone_15?.value || '5000';
                    document.getElementById('setting-milestone_25').value = settings.milestone_25?.value || '10000';
                    document.getElementById('setting-milestone_50').value = settings.milestone_50?.value || '30000';
                    document.getElementById('setting-milestone_75').value = settings.milestone_75?.value || '50000';
                    document.getElementById('setting-milestone_100').value = settings.milestone_100?.value || '100000';
                    document.getElementById('setting-milestone_150').value = settings.milestone_150?.value || '150000';
                    document.getElementById('setting-milestone_250').value = settings.milestone_250?.value || '250000';
                    document.getElementById('setting-milestone_500').value = settings.milestone_500?.value || '500000';
                    document.getElementById('setting-milestone_1000').value = settings.milestone_1000?.value || '1000000';
                    
                    const msgDiv = document.getElementById('settings-message');
                    if (msgDiv) {
                        msgDiv.innerHTML = '<span style="color: #4ade80;">‚úÖ Settings loaded</span>';
                        setTimeout(() => msgDiv.innerHTML = '', 3000);
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                const msgDiv = document.getElementById('settings-message');
                if (msgDiv) {
                    msgDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Error loading settings</span>';
                }
            }
        }

        // Save referral settings
        async function saveSettings() {
            try {
                const settings = {
                    referral_reward: document.getElementById('setting-referral_reward').value,
                    milestone_1: document.getElementById('setting-milestone_1').value,
                    milestone_3: document.getElementById('setting-milestone_3').value,
                    milestone_5: document.getElementById('setting-milestone_5').value,
                    milestone_10: document.getElementById('setting-milestone_10').value,
                    milestone_15: document.getElementById('setting-milestone_15').value,
                    milestone_25: document.getElementById('setting-milestone_25').value,
                    milestone_50: document.getElementById('setting-milestone_50').value,
                    milestone_75: document.getElementById('setting-milestone_75').value,
                    milestone_100: document.getElementById('setting-milestone_100').value,
                    milestone_150: document.getElementById('setting-milestone_150').value,
                    milestone_250: document.getElementById('setting-milestone_250').value,
                    milestone_500: document.getElementById('setting-milestone_500').value,
                    milestone_1000: document.getElementById('setting-milestone_1000').value
                };

                const response = await fetch('https://api.solanatamagotchi.com/api/referral-settings.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        settings: settings,
                        updated_by: 'admin'
                    })
                });

                const result = await response.json();
                
                const msgDiv = document.getElementById('settings-message');
                if (result.success) {
                    if (msgDiv) {
                        msgDiv.innerHTML = '<span style="color: #4ade80;">‚úÖ Settings saved successfully!</span>';
                        setTimeout(() => msgDiv.innerHTML = '', 3000);
                    }
                } else {
                    if (msgDiv) {
                        msgDiv.innerHTML = `<span style="color: #ef4444;">‚ùå Error: ${result.error || 'Unknown error'}</span>`;
                    }
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                const msgDiv = document.getElementById('settings-message');
                if (msgDiv) {
                    msgDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Error saving settings</span>';
                }
            }
        }

        // Load data on page load
        window.onload = function() {
            loadData();
        };
    </script>

    <!-- Admin Authentication -->
    <script src="js/admin-auth.js"></script>
</body>
</html>

